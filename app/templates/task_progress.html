{% extends "base.html" %}

{% block title %}Analysis Results - SEO Tools{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
        <a href="/" class="text-blue-600 hover:text-blue-800 mb-2 inline-block">
            <i class="fas fa-arrow-left mr-1"></i>Back to tools
        </a>
        <h2 class="text-2xl font-bold text-gray-800">Analysis Results</h2>
        <p class="text-gray-600">Task ID: <span id="task-id">{{ task_id }}</span></p>
    </div>

    <!-- Progress Section -->
    <div id="progress-section" class="bg-white rounded-xl shadow-md p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h3 class="text-lg font-semibold" id="status-title">Running...</h3>
                <p class="text-gray-600" id="status-message">Initializing...</p>
            </div>
            <div id="status-icon" class="text-4xl">
                <i class="fas fa-spinner fa-spin text-blue-500"></i>
            </div>
        </div>
        
        <!-- Progress Bar -->
        <div class="w-full bg-gray-200 rounded-full h-4 mb-2">
            <div id="progress-bar" class="bg-blue-500 h-4 rounded-full progress-bar" style="width: 0%"></div>
        </div>
        <div id="progress-meta" class="hidden mt-3 grid grid-cols-1 md:grid-cols-4 gap-2 text-sm">
            <div class="bg-slate-50 border border-slate-200 rounded px-3 py-2">
                <div class="text-slate-500">Processed</div>
                <div id="progress-processed" class="font-semibold text-slate-800">0</div>
            </div>
            <div class="bg-slate-50 border border-slate-200 rounded px-3 py-2">
                <div class="text-slate-500">Total</div>
                <div id="progress-total" class="font-semibold text-slate-800">0</div>
            </div>
            <div class="bg-slate-50 border border-slate-200 rounded px-3 py-2">
                <div class="text-slate-500">Queue</div>
                <div id="progress-queue" class="font-semibold text-slate-800">0</div>
            </div>
            <div class="bg-slate-50 border border-slate-200 rounded px-3 py-2">
                <div class="text-slate-500">Current URL</div>
                <div id="progress-current-url" class="font-semibold text-slate-800 truncate">-</div>
            </div>
        </div>
    </div>

    <!-- Results Section (hidden initially) -->
    <div id="results-section" class="hidden space-y-6">
        <!-- Results Content -->
        <div id="results-content" class="space-y-6">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>

    <!-- Error Section (hidden initially) -->
    <div id="error-section" class="hidden bg-red-50 border-l-4 border-red-500 p-6 rounded-r-xl">
        <div class="flex items-start">
            <i class="fas fa-exclamation-triangle text-red-500 text-xl mr-3 mt-1"></i>
            <div>
                <h3 class="text-red-800 font-semibold mb-2">Execution Error</h3>
                <p id="error-message" class="text-red-700"></p>
            </div>
        </div>
    </div>

    <!-- Copy Notification -->
    <div id="copy-notification" class="fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 transition-transform duration-300 z-50">
        <i class="fas fa-check mr-2"></i>Copied to clipboard
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .sitepro-results {
        --sp-bg-soft: linear-gradient(180deg, #f8fbff 0%, #f6f8fc 100%);
        --sp-card-border: #dbe4f0;
        --sp-card-shadow: 0 10px 28px rgba(15, 23, 42, 0.06);
        --sp-card-shadow-hover: 0 14px 32px rgba(15, 23, 42, 0.1);
        --sp-title: #0f172a;
        --sp-muted: #475569;
        --sp-accent: #1d4ed8;
    }
    .sitepro-results {
        background: var(--sp-bg-soft);
        border: 1px solid #e2e8f0;
        border-radius: 1rem;
        padding: 1rem;
    }
    .sitepro-results > div.bg-white.rounded-xl.shadow-md.p-6 {
        border: 1px solid var(--sp-card-border);
        box-shadow: var(--sp-card-shadow);
        transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        animation: sitepro-fade-in 0.35s ease both;
    }
    .sitepro-results > div.bg-white.rounded-xl.shadow-md.p-6:hover {
        transform: translateY(-2px);
        border-color: #bfdbfe;
        box-shadow: var(--sp-card-shadow-hover);
    }
    .sitepro-results h3,
    .sitepro-results h4 {
        color: var(--sp-title);
        letter-spacing: -0.01em;
    }
    .sitepro-results h3 {
        font-weight: 700;
        font-size: 1.125rem;
    }
    .sitepro-results h4 {
        font-weight: 650;
        font-size: 1rem;
    }
    .sitepro-results .text-gray-600,
    .sitepro-results .text-slate-500 {
        color: var(--sp-muted) !important;
    }
    .sitepro-results table thead th {
        position: sticky;
        top: 0;
        background: #f8fafc;
        z-index: 2;
        text-transform: uppercase;
        letter-spacing: 0.03em;
    }
    .sitepro-results table tbody tr:hover {
        background: #f8fbff;
    }
    .sitepro-chip {
        border: 1px solid #cbd5e1;
        background: #f8fafc;
        color: #0f172a;
        border-radius: 999px;
        padding: 0.2rem 0.6rem;
        font-size: 0.72rem;
        font-weight: 600;
    }
    @keyframes sitepro-fade-in {
        from {
            opacity: 0;
            transform: translateY(8px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    .renderpro-results {
        --rp-bg-soft: linear-gradient(180deg, #f7fbff 0%, #f5f8ff 100%);
        --rp-card-border: #d7e3f3;
        --rp-card-shadow: 0 10px 28px rgba(2, 6, 23, 0.06);
        --rp-card-shadow-hover: 0 14px 32px rgba(2, 6, 23, 0.1);
        --rp-title: #0f172a;
        --rp-muted: #475569;
    }
    .renderpro-results {
        background: var(--rp-bg-soft);
        border: 1px solid #e2e8f0;
        border-radius: 1rem;
        padding: 1rem;
    }
    .renderpro-results .bg-white.rounded-xl.shadow-md,
    .renderpro-results .bg-white.rounded-2xl.shadow-lg {
        border: 1px solid var(--rp-card-border);
        box-shadow: var(--rp-card-shadow);
        transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        animation: renderpro-fade-in 0.32s ease both;
    }
    .renderpro-results .bg-white.rounded-xl.shadow-md:hover,
    .renderpro-results .bg-white.rounded-2xl.shadow-lg:hover {
        transform: translateY(-2px);
        border-color: #bfdbfe;
        box-shadow: var(--rp-card-shadow-hover);
    }
    .renderpro-results h3,
    .renderpro-results h4 {
        color: var(--rp-title);
        letter-spacing: -0.01em;
    }
    .renderpro-results h3 {
        font-weight: 700;
        font-size: 1.1rem;
    }
    .renderpro-results h4 {
        font-weight: 650;
        font-size: 0.98rem;
    }
    .renderpro-results .text-gray-600,
    .renderpro-results .text-slate-500 {
        color: var(--rp-muted) !important;
    }
    .renderpro-results table thead th {
        position: sticky;
        top: 0;
        z-index: 2;
        background: #f8fafc;
        text-transform: uppercase;
        letter-spacing: 0.03em;
    }
    .renderpro-results table tbody tr:hover {
        background: #f8fbff;
    }
    .renderpro-chip {
        border: 1px solid #bfdbfe;
        background: #eff6ff;
        color: #1e3a8a;
        border-radius: 999px;
        padding: 0.2rem 0.65rem;
        font-size: 0.72rem;
        font-weight: 600;
    }
    @keyframes renderpro-fade-in {
        from {
            opacity: 0;
            transform: translateY(8px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
const taskId = "{{ task_id }}";
let pollInterval;

function addTaskToLocalHistory(item) {
    try {
        if (typeof window.addToHistory === 'function') {
            window.addToHistory(item);
            return;
        }
        const HISTORY_KEY = 'seo_tools_history';
        const MAX_HISTORY_ITEMS = 10;
        const raw = localStorage.getItem(HISTORY_KEY);
        const history = raw ? JSON.parse(raw) : [];
        history.unshift(item);
        localStorage.setItem(HISTORY_KEY, JSON.stringify(history.slice(0, MAX_HISTORY_ITEMS)));
    } catch (e) {
        console.error('Error writing history:', e);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    checkTaskStatus();
    pollInterval = setInterval(checkTaskStatus, 1000);
});

async function checkTaskStatus() {
    try {
        const response = await fetch(`/api/tasks/${taskId}`);
        const data = await response.json();
        
        updateProgress(data);
        
        if (data.status === 'SUCCESS') {
            clearInterval(pollInterval);
            showResults(data.result);
        } else if (data.status === 'FAILURE') {
            clearInterval(pollInterval);
            showError(data);
        }
    } catch (error) {
        console.error('Error checking task status:', error);
    }
}

function updateProgress(data) {
    const progressBar = document.getElementById('progress-bar');
    const statusTitle = document.getElementById('status-title');
    const statusMessage = document.getElementById('status-message');
    const statusIcon = document.getElementById('status-icon');
    const progressMetaWrap = document.getElementById('progress-meta');
    const processedEl = document.getElementById('progress-processed');
    const totalEl = document.getElementById('progress-total');
    const queueEl = document.getElementById('progress-queue');
    const currentUrlEl = document.getElementById('progress-current-url');
    const progressMeta = data.progress_meta || {};

    if (data.status === 'SUCCESS') {
        statusTitle.textContent = 'Completed';
        statusMessage.textContent = data.status_message || 'Analysis completed successfully';
        progressBar.style.width = '100%';
        progressBar.classList.remove('bg-blue-500');
        progressBar.classList.add('bg-green-500');
        statusIcon.innerHTML = '<i class="fas fa-check-circle text-green-500"></i>';
        progressMetaWrap.classList.add('hidden');
        return;
    }

    if (data.status === 'FAILURE') {
        statusTitle.textContent = 'Error';
        statusMessage.textContent = data.error || data.status_message || 'Analysis finished with an error';
        progressBar.style.width = `${data.progress || 100}%`;
        progressBar.classList.remove('bg-blue-500');
        progressBar.classList.add('bg-red-500');
        statusIcon.innerHTML = '<i class="fas fa-times-circle text-red-500"></i>';
        progressMetaWrap.classList.add('hidden');
        return;
    }

    const p = Number.isFinite(Number(data.progress)) ? Number(data.progress) : 10;
    statusTitle.textContent = data.status === 'RUNNING' ? 'Running...' : 'Queued...';
    statusMessage.textContent = data.status_message || (data.status === 'RUNNING' ? 'Analysis in progress' : 'Task is waiting in queue');
    progressBar.style.width = `${Math.max(5, Math.min(95, p))}%`;
    progressBar.classList.remove('bg-green-500', 'bg-red-500');
    progressBar.classList.add('bg-blue-500');
    statusIcon.innerHTML = '<i class="fas fa-spinner fa-spin text-blue-500"></i>';

    const isSitePro = (data.task_type === 'site_audit_pro');
    const totalPages = Number(progressMeta.total_pages || 0);
    if (isSitePro && totalPages > 0) {
        const processedPages = Number(progressMeta.processed_pages || 0);
        const queueSize = Number(progressMeta.queue_size || 0);
        processedEl.textContent = String(processedPages);
        totalEl.textContent = String(totalPages);
        queueEl.textContent = String(queueSize);
        currentUrlEl.textContent = progressMeta.current_url || '-';
        progressMetaWrap.classList.remove('hidden');
    } else {
        progressMetaWrap.classList.add('hidden');
    }
}

function showResults(data) {
    document.getElementById('progress-section').classList.add('hidden');
    document.getElementById('results-section').classList.remove('hidden');
    const result = data;
    lastTaskResult = data;
    
    // Store data for download functions (include task_id from API response)
    if (data.task_type === 'robots_check') {
        robotsData = {
            ...data,
            task_id: data.task_id || taskId,
            url: data.url || ''
        };
        console.log('Robots data stored:', robotsData);
    } else if (data.task_type === 'sitemap_validate') {
        sitemapData = {
            ...data,
            task_id: data.task_id || taskId,
            url: data.url || ''
        };
    } else if (data.task_type === 'bot_check') {
        botData = {
            ...data,
            task_id: data.task_id || taskId,
            url: data.url || ''
        };
    } else if (data.task_type === 'mobile_check') {
        mobileData = {
            ...data,
            task_id: data.task_id || taskId,
            url: data.url || ''
        };
    } else if (data.task_type === 'render_audit') {
        renderData = {
            ...data,
            task_id: data.task_id || taskId,
            url: data.url || ''
        };
    } else if (data.task_type === 'site_audit_pro') {
        siteAuditProData = {
            ...data,
            task_id: data.task_id || taskId,
            url: data.url || ''
        };
    } else if (data.task_type === 'onpage_audit') {
        onpageData = {
            ...data,
            task_id: data.task_id || taskId,
            url: data.url || ''
        };
    }
    
    const resultsContent = document.getElementById('results-content');
    
    // Generate results HTML based on task type
    if (data.task_type === 'site_analyze') {
        resultsContent.innerHTML = generateSiteAnalysisHTML(data);
    } else if (data.task_type === 'robots_check') {
        resultsContent.innerHTML = generateRobotsHTML(data);
    } else if (result.task_type === 'sitemap_validate') {
        resultsContent.innerHTML = generateSitemapHTMLV2(result);
    } else if (result.task_type === 'bot_check') {
        resultsContent.innerHTML = generateBotHTML(result);
        setTimeout(() => applyBotTableControls(), 0);
    } else if (result.task_type === 'render_audit') {
        resultsContent.innerHTML = generateRenderAuditHTML(result);
    } else if (result.task_type === 'mobile_check') {
        resultsContent.innerHTML = generateMobileCheckHTML(result);
    } else if (result.task_type === 'site_audit_pro') {
        resultsContent.innerHTML = generateSiteAuditProHTML(result);
        initSiteAuditProIssuesExplorer(result);
    } else if (result.task_type === 'onpage_audit') {
        resultsContent.innerHTML = generateOnPageAuditHTML(result);
        filterOnpageIssues('all');
    } else {
        resultsContent.innerHTML = generateGenericHTML(result);
    }
}

function showError(data) {
    document.getElementById('progress-section').classList.add('hidden');
    document.getElementById('error-section').classList.remove('hidden');
    document.getElementById('error-message').textContent = data.error || 'Unknown error';
}

// Global variables for robots data
let robotsData = null;
let sitemapData = null;
let botData = null;
let mobileData = null;
let renderData = null;
let siteAuditProData = null;
let siteAuditProIssuesState = { issues: [], filtered: [], filter: 'all', query: '', limit: 20, sort: 'severity', owner: 'all' };
let onpageData = null;
let lastTaskResult = null;
let sitemapExportUrls = [];
let sitemapDuplicateLines = [];
let sitemapFilePreviewUrls = [];

function generateTextReport() {
    if (!robotsData) return 'No data for report';
    const r = robotsData.results || robotsData;
    const groups = r.groups_detail || r.groups || [];

    let totalDisallow = 0;
    let totalAllow = 0;
    groups.forEach(g => {
        totalDisallow += (g.disallow || []).length;
        totalAllow += (g.allow || []).length;
    });

    let report = 'ROBOTS.TXT AUDIT REPORT\n';
    report += '='.repeat(60) + '\n';
    report += 'Site URL: ' + (robotsData.url || '') + '\n';
    report += 'Generated at: ' + new Date().toLocaleString() + '\n';
    report += '='.repeat(60) + '\n\n';

    report += 'SUMMARY\n' + '-'.repeat(30) + '\n';
    report += 'robots.txt found: ' + (r.robots_txt_found ? 'yes' : 'no') + '\n';
    report += 'HTTP status: ' + (r.status_code ?? 'n/a') + '\n';
    report += 'Quality score: ' + (r.quality_score ?? 'n/a') + ' (' + (r.quality_grade || 'n/a') + ')\n';
    report += 'Production ready: ' + (r.production_ready ? 'yes' : 'no') + '\n';
    report += 'User-Agents: ' + (r.user_agents || 0) + '\n';
    report += 'Disallow rules: ' + totalDisallow + '\n';
    report += 'Allow rules: ' + totalAllow + '\n';
    report += 'File size: ' + (r.content_length || 0) + ' bytes\n';
    report += 'Lines: ' + (r.lines_count || 0) + '\n\n';

    const severity = r.severity_counts || {};
    report += 'SEVERITY\n' + '-'.repeat(30) + '\n';
    report += 'Critical: ' + (severity.critical ?? (r.critical_issues || r.issues || []).length) + '\n';
    report += 'Warning: ' + (severity.warning ?? (r.warning_issues || r.warnings || []).length) + '\n';
    report += 'Info: ' + (severity.info ?? (r.info_issues || []).length) + '\n\n';

    const issues = r.critical_issues || r.issues || [];
    if (issues.length > 0) {
        report += 'CRITICAL ISSUES\n' + '-'.repeat(30) + '\n';
        issues.forEach(i => report += '! ' + i + '\n');
        report += '\n';
    }

    const warnings = r.warning_issues || r.warnings || [];
    if (warnings.length > 0) {
        report += 'WARNINGS\n' + '-'.repeat(30) + '\n';
        warnings.forEach(w => report += '- ' + w + '\n');
        report += '\n';
    }

    const infoIssues = r.info_issues || [];
    if (infoIssues.length > 0) {
        report += 'INFO\n' + '-'.repeat(30) + '\n';
        infoIssues.forEach(i => report += '- ' + i + '\n');
        report += '\n';
    }

    const sitemaps = (r.sitemaps || []).map(s => s && s.url ? s.url : s).filter(Boolean);
    if (sitemaps.length > 0) {
        report += 'SITEMAPS\n' + '-'.repeat(30) + '\n';
        sitemaps.forEach(sm => report += '- ' + sm + '\n');
        report += '\n';
    }

    const sitemapChecks = r.sitemap_checks || [];
    if (sitemapChecks.length > 0) {
        report += 'SITEMAP URL CHECKS\n' + '-'.repeat(30) + '\n';
        sitemapChecks.forEach(check => {
            const status = check.ok === true ? 'OK' : (check.ok === false ? 'FAIL' : 'SKIPPED');
            const code = check.status_code ? ` HTTP ${check.status_code}` : '';
            const err = check.error ? ` | ${check.error}` : '';
            report += `- ${status}: ${check.url || ''}${code}${err}\n`;
        });
        report += '\n';
    }

    if (groups.length > 0) {
        report += 'GROUP RULES\n' + '-'.repeat(30) + '\n';
        groups.forEach((group, idx) => {
            report += `\nGroup ${idx + 1}: ${(group.user_agents || []).join(', ')}\n`;
            (group.disallow || []).forEach(d => report += `  Disallow: ${d.path} (line ${d.line})\n`);
            (group.allow || []).forEach(a => report += `  Allow: ${a.path} (line ${a.line})\n`);
        });
        report += '\n';
    }

    const syntaxErrors = r.syntax_errors || [];
    if (syntaxErrors.length > 0) {
        report += 'SYNTAX ERRORS\n' + '-'.repeat(30) + '\n';
        syntaxErrors.forEach(err => {
            report += `- line ${err.line || '?'}: ${err.error || ''}\n`;
            if (err.content) report += `  content: ${err.content}\n`;
        });
        report += '\n';
    }

    const recommendations = r.recommendations || [];
    if (recommendations.length > 0) {
        report += 'RECOMMENDATIONS\n' + '-'.repeat(30) + '\n';
        recommendations.forEach(rec => report += '- ' + rec + '\n');
        report += '\n';
    }

    const topFixes = r.top_fixes || [];
    if (topFixes.length > 0) {
        report += 'TOP FIXES\n' + '-'.repeat(30) + '\n';
        topFixes.forEach(fix => {
            report += '[' + String((fix.priority || 'medium')).toUpperCase() + '] ' + (fix.title || 'Fix') + '\n';
            if (fix.why) report += '  Why: ' + fix.why + '\n';
            if (fix.action) report += '  Action: ' + fix.action + '\n';
        });
        report += '\n';
    }

    const httpStatusAnalysis = r.http_status_analysis || {};
    const httpNotes = httpStatusAnalysis.notes || [];
    if (httpNotes.length > 0) {
        report += 'HTTP STATUS ANALYSIS\n' + '-'.repeat(30) + '\n';
        report += 'Status: ' + (httpStatusAnalysis.status_code ?? r.status_code ?? 'n/a') + '\n';
        httpNotes.forEach(note => report += '- ' + note + '\n');
        report += '\n';
    }

    const unsupported = r.unsupported_directives || [];
    if (unsupported.length > 0) {
        report += 'UNSUPPORTED DIRECTIVES\n' + '-'.repeat(30) + '\n';
        unsupported.forEach(item => {
            report += `- line ${item.line || '?'}: ${item.directive || ''}${item.value ? `: ${item.value}` : ''}\n`;
        });
        report += '\n';
    }

    const hostValidation = r.host_validation || {};
    const hostWarnings = hostValidation.warnings || [];
    const hostList = hostValidation.hosts || r.hosts || [];
    if (hostList.length > 0 || hostWarnings.length > 0) {
        report += 'HOST VALIDATION\n' + '-'.repeat(30) + '\n';
        if (hostList.length > 0) report += 'Hosts: ' + hostList.join(', ') + '\n';
        hostWarnings.forEach(w => report += '- ' + w + '\n');
        report += '\n';
    }

    const conflictScan = r.directive_conflicts || {};
    const conflictDetails = conflictScan.details || [];
    if (conflictDetails.length > 0) {
        report += 'DIRECTIVE CONFLICTS\n' + '-'.repeat(30) + '\n';
        conflictDetails.forEach(c => {
            const marker = c.path || c.groups || '';
            report += `- ${c.type || 'conflict'} | ua=${c.user_agent || ''}${marker ? ` | ${marker}` : ''}\n`;
        });
        report += '\n';
    }

    const longestMatch = r.longest_match_analysis || {};
    const longestNotes = longestMatch.notes || [];
    if (longestNotes.length > 0) {
        report += 'LONGEST-MATCH NOTES\n' + '-'.repeat(30) + '\n';
        longestNotes.forEach(n => report += '- ' + n + '\n');
        report += '\n';
    }

    const paramRecs = r.param_recommendations || [];
    if (paramRecs.length > 0) {
        report += 'YANDEX CLEAN-PARAM RECOMMENDATIONS\n' + '-'.repeat(30) + '\n';
        paramRecs.forEach(n => report += '- ' + n + '\n');
        report += '\n';
    }

    const rawContent = r.raw_content || '';
    if (rawContent) {
        report += 'RAW ROBOTS.TXT\n' + '-'.repeat(30) + '\n';
        report += rawContent + '\n';
    }

    return report;
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        const notification = document.getElementById('copy-notification');
        notification.classList.remove('translate-y-20');
        setTimeout(() => {
            notification.classList.add('translate-y-20');
        }, 2000);
    }).catch(err => {
        console.error('РћС€РёР±РєР° РєРѕРїРёСЂРѕРІР°РЅРёСЏ:', err);
    });
}

function escapeHtml(text) {
    return String(text || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
}

function sanitizeHttpUrl(rawUrl) {
    if (!rawUrl) return '';
    try {
        const parsed = new URL(rawUrl, window.location.origin);
        if (parsed.protocol !== 'http:' && parsed.protocol !== 'https:') {
            return '';
        }
        return parsed.href;
    } catch (_) {
        return '';
    }
}

function formatRobotsRawWithLineNumbers(rawText) {
    const lines = String(rawText || '').replace(/\r\n/g, '\n').split('\n');
    return lines.map((line, idx) => {
        const n = String(idx + 1).padStart(4, ' ');
        return `<div class="flex"><span class="select-none text-gray-500 pr-4 w-14 text-right border-r border-gray-700 mr-4">${n}</span><span class="whitespace-pre-wrap break-all flex-1">${escapeHtml(line)}</span></div>`;
    }).join('');
}

function copyCurrentTaskJson() {
    if (!lastTaskResult) {
        alert('РќРµС‚ РґР°РЅРЅС‹С… РґР»СЏ РєРѕРїРёСЂРѕРІР°РЅРёСЏ');
        return;
    }
    copyToClipboard(JSON.stringify(lastTaskResult, null, 2));
}

function copyOnpageRecommendations() {
    if (!lastTaskResult || lastTaskResult.task_type !== 'onpage_audit') {
        alert('РќРµС‚ РґР°РЅРЅС‹С… OnPage РґР»СЏ РєРѕРїРёСЂРѕРІР°РЅРёСЏ');
        return;
    }
    const r = (lastTaskResult.results || {});
    const recs = (r.recommendations || []);
    if (!recs.length) {
        alert('Р РµРєРѕРјРµРЅРґР°С†РёР№ РїРѕРєР° РЅРµС‚');
        return;
    }
    const lines = recs.map((item, idx) => `${idx + 1}. ${item}`);
    copyToClipboard(lines.join('\n'));
}

function copyOnpageTopFixes() {
    if (!lastTaskResult || lastTaskResult.task_type !== 'onpage_audit') {
        alert('РќРµС‚ РґР°РЅРЅС‹С… OnPage РґР»СЏ РєРѕРїРёСЂРѕРІР°РЅРёСЏ');
        return;
    }
    const r = (lastTaskResult.results || {});
    const queue = (r.priority_queue || []);
    const fallbackFixes = (r.top_fixes || []);
    const list = queue.length > 0
        ? queue.slice(0, 10).map((q, idx) =>
            `${idx + 1}. [${(q.bucket || 'Later').toUpperCase()}] ${(q.title || q.code || 'Issue')} | Severity: ${(q.severity || 'info').toUpperCase()} | Priority: ${q.priority_score ?? 0} | Effort: ${q.effort ?? 0}`
        )
        : fallbackFixes.slice(0, 10).map((f, idx) =>
            `${idx + 1}. [${String((f.priority || 'medium')).toUpperCase()}] ${f.title || 'Fix'}${f.action ? ` | Action: ${f.action}` : ''}`
        );
    if (!list.length) {
        alert('Top fixes РїРѕРєР° РЅРµС‚');
        return;
    }
    copyToClipboard(list.join('\n'));
}

function filterOnpageIssues(mode) {
    const wrapper = document.getElementById('onpage-issues-list');
    if (!wrapper) return;
    const cards = wrapper.querySelectorAll('[data-issue-severity]');
    let visibleCount = 0;
    cards.forEach((card) => {
        const severity = String(card.getAttribute('data-issue-severity') || 'info').toLowerCase();
        const shouldShow = mode === 'all' ? true : severity === mode;
        card.classList.toggle('hidden', !shouldShow);
        if (shouldShow) visibleCount += 1;
    });
    const counter = document.getElementById('onpage-issues-count');
    if (counter) {
        counter.textContent = `${visibleCount} / ${cards.length}`;
    }
    const buttons = document.querySelectorAll('[data-onpage-issues-filter]');
    buttons.forEach((btn) => {
        const isActive = btn.getAttribute('data-onpage-issues-filter') === mode;
        btn.classList.toggle('bg-slate-900', isActive);
        btn.classList.toggle('text-white', isActive);
        btn.classList.toggle('bg-white', !isActive);
        btn.classList.toggle('text-slate-700', !isActive);
    });
}

function filterSiteAuditProIssues() {
    const source = Array.isArray(siteAuditProIssuesState.issues) ? siteAuditProIssuesState.issues : [];
    const query = String(siteAuditProIssuesState.query || '').trim().toLowerCase();
    const mode = String(siteAuditProIssuesState.filter || 'all').toLowerCase();
    const owner = String(siteAuditProIssuesState.owner || 'all');
    const ownerHintByCode = (code) => {
        const codeL = String(code || '').toLowerCase();
        if (/(title|meta|h1|keyword|content|ai_|duplicate_)/.test(codeL)) return 'Content+SEO';
        if (/(schema|structured|hreflang|canonical|index|http_status)/.test(codeL)) return 'SEO+Dev';
        if (/(security|cache|compression|https|crawl_budget|redirect)/.test(codeL)) return 'Dev+Infra';
        return 'SEO';
    };
    return source.filter((issue) => {
        const severity = String(issue.severity || 'info').toLowerCase();
        if (mode !== 'all' && severity !== mode) return false;
        if (owner !== 'all' && ownerHintByCode(issue.code) !== owner) return false;
        if (!query) return true;
        const haystack = [
            issue.code,
            issue.title,
            issue.details,
            issue.url,
            issue.severity,
        ].map(v => String(v || '').toLowerCase()).join(' ');
        return haystack.includes(query);
    });
}

function renderSiteAuditProIssuesExplorer() {
    const wrapper = document.getElementById('sitepro-issues-list');
    if (!wrapper) return;

    const filtered = filterSiteAuditProIssues();
    const sorted = [...filtered];
    if (siteAuditProIssuesState.sort === 'url') {
        sorted.sort((a, b) => String(a.url || '').localeCompare(String(b.url || '')));
    } else {
        const rank = { critical: 0, warning: 1, info: 2 };
        sorted.sort((a, b) => {
            const sa = String(a.severity || 'info').toLowerCase();
            const sb = String(b.severity || 'info').toLowerCase();
            const bySeverity = (rank[sa] ?? 3) - (rank[sb] ?? 3);
            if (bySeverity !== 0) return bySeverity;
            return String(a.code || '').localeCompare(String(b.code || ''));
        });
    }
    siteAuditProIssuesState.filtered = sorted;
    const limit = Number(siteAuditProIssuesState.limit || 20);
    const visible = sorted.slice(0, limit);

    const counter = document.getElementById('sitepro-issues-count');
    if (counter) counter.textContent = `${visible.length} / ${sorted.length}`;

    const buttons = document.querySelectorAll('[data-sitepro-issues-filter]');
    buttons.forEach((btn) => {
        const btnMode = btn.getAttribute('data-sitepro-issues-filter') || 'all';
        const isActive = btnMode === siteAuditProIssuesState.filter;
        btn.classList.toggle('bg-slate-900', isActive);
        btn.classList.toggle('text-white', isActive);
        btn.classList.toggle('bg-white', !isActive);
        btn.classList.toggle('text-slate-700', !isActive);
    });

    if (!visible.length) {
        wrapper.innerHTML = '<div class="text-sm text-gray-500">РџСЂРѕР±Р»РµРјС‹ РЅРµ РЅР°Р№РґРµРЅС‹ РїРѕ С‚РµРєСѓС‰РёРј С„РёР»СЊС‚СЂР°Рј.</div>';
        return;
    }

    wrapper.innerHTML = visible.map((issue) => {
        const severity = String(issue.severity || 'info').toLowerCase();
        const classes = severity === 'critical'
            ? { card: 'border-red-500 bg-red-50', badge: 'bg-red-100 text-red-700' }
            : severity === 'warning'
                ? { card: 'border-yellow-500 bg-yellow-50', badge: 'bg-yellow-100 text-yellow-700' }
                : { card: 'border-blue-500 bg-blue-50', badge: 'bg-blue-100 text-blue-700' };
        return `
            <div class="text-sm border-l-4 ${classes.card} p-3 rounded-r mb-2">
                <div class="flex flex-wrap items-center gap-2">
                    <span class="px-2 py-0.5 rounded-full text-xs font-semibold ${classes.badge}">${escapeHtml(severity.toUpperCase())}</span>
                    <span class="font-semibold">${escapeHtml(issue.code || 'issue')}</span>
                </div>
                <div class="mt-1">${escapeHtml(issue.title || '')}</div>
                ${issue.details ? `<div class="text-gray-700 mt-1">${escapeHtml(issue.details)}</div>` : ''}
                ${issue.url ? `<div class="text-gray-600 mt-1 break-all">${escapeHtml(issue.url)}</div>` : ''}
            </div>
        `;
    }).join('');
}

function setSiteAuditProIssuesFilter(mode) {
    siteAuditProIssuesState.filter = String(mode || 'all').toLowerCase();
    renderSiteAuditProIssuesExplorer();
}

function updateSiteAuditProIssuesQuery(value) {
    siteAuditProIssuesState.query = String(value || '');
    renderSiteAuditProIssuesExplorer();
}

function updateSiteAuditProIssuesLimit(value) {
    const parsed = Number(value || 20);
    siteAuditProIssuesState.limit = Number.isFinite(parsed) ? parsed : 20;
    renderSiteAuditProIssuesExplorer();
}

function updateSiteAuditProIssuesSort(value) {
    siteAuditProIssuesState.sort = String(value || 'severity');
    renderSiteAuditProIssuesExplorer();
}

function updateSiteAuditProIssuesOwner(value) {
    siteAuditProIssuesState.owner = String(value || 'all');
    renderSiteAuditProIssuesExplorer();
}

function applySiteProOwnerPreset(owner) {
    siteAuditProIssuesState.owner = String(owner || 'all');
    const ownerInput = document.getElementById('sitepro-issues-owner');
    if (ownerInput) ownerInput.value = siteAuditProIssuesState.owner;
    renderSiteAuditProIssuesExplorer();
}

function applySiteProIssuePreset(query, mode = 'all') {
    siteAuditProIssuesState.filter = String(mode || 'all').toLowerCase();
    siteAuditProIssuesState.query = String(query || '');
    const queryInput = document.getElementById('sitepro-issues-search');
    if (queryInput) queryInput.value = siteAuditProIssuesState.query;
    renderSiteAuditProIssuesExplorer();
}

function initSiteAuditProIssuesExplorer(result) {
    const r = result.results || {};
    const issues = Array.isArray(r.issues) ? r.issues : [];
    siteAuditProIssuesState = {
        issues,
        filtered: issues,
        filter: 'all',
        query: '',
        limit: 20,
        sort: 'severity',
        owner: 'all',
    };
    const queryInput = document.getElementById('sitepro-issues-search');
    if (queryInput) queryInput.value = '';
    const limitInput = document.getElementById('sitepro-issues-limit');
    if (limitInput) limitInput.value = '20';
    const sortInput = document.getElementById('sitepro-issues-sort');
    if (sortInput) sortInput.value = 'severity';
    const ownerInput = document.getElementById('sitepro-issues-owner');
    if (ownerInput) ownerInput.value = 'all';
    renderSiteAuditProIssuesExplorer();
}

function downloadTextReport() {
    const report = generateTextReport();
    const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `robots-report-${new Date().toISOString().slice(0,10)}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function downloadLinesAsTxt(lines, filename) {
    const content = (lines || []).join('\n');
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const href = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = href;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(href);
}

function downloadLinesAsTxtParts(lines, baseFilename, partSize = 25000) {
    const arr = lines || [];
    if (arr.length === 0) return;
    let part = 1;
    for (let i = 0; i < arr.length; i += partSize) {
        const slice = arr.slice(i, i + partSize);
        const partName = `${baseFilename}_part-${String(part).padStart(3, '0')}.txt`;
        downloadLinesAsTxt(slice, partName);
        part += 1;
    }
}

function downloadCurrentSitemapUrls(baseFilename) {
    downloadLinesAsTxt(sitemapExportUrls, `${baseFilename}.txt`);
}

function downloadCurrentSitemapUrlsParts(baseFilename, partSize = 25000) {
    downloadLinesAsTxtParts(sitemapExportUrls, baseFilename, partSize);
}

function downloadCurrentSitemapDuplicates(filename) {
    downloadLinesAsTxt(sitemapDuplicateLines, filename);
}

function downloadSitemapFilePreview(index, filename) {
    const lines = (sitemapFilePreviewUrls[index] || []);
    downloadLinesAsTxt(lines, filename);
}

async function downloadSitemapXlsxReport() {
    if (!sitemapData) {
        alert('РќРµС‚ РґР°РЅРЅС‹С… sitemap');
        return;
    }
    try {
        const response = await fetch('/api/export/sitemap-xlsx', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ task_id: sitemapData.task_id || taskId })
        });
        if (!response.ok) {
            const err = await response.json();
            throw new Error(err.error || `HTTP ${response.status}`);
        }
        const blob = await response.blob();
        const href = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const cd = response.headers.get('Content-Disposition') || '';
        const m = cd.match(/filename=([^;]+)/i);
        a.download = m ? m[1].replace(/\"/g, '') : `sitemap-report-${new Date().toISOString().slice(0,10)}.xlsx`;
        a.href = href;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(href);
    } catch (error) {
        console.error('Error downloading sitemap xlsx:', error);
        alert('РќРµ СѓРґР°Р» СЃРєР°С‡Р°С‚СЊ XLSX-РѕС‚С‡РµС‚  sitemap');
    }
}

async function runSitemapCheckFromRobots(sitemapUrl) {
    if (!sitemapUrl) {
        alert('Sitemap URL is empty');
        return;
    }
    try {
        const response = await fetch('/api/tasks/sitemap-validate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url: sitemapUrl })
        });
        const data = await response.json();
        if (!response.ok || !data.task_id) {
            throw new Error(data.error || data.detail || `HTTP ${response.status}`);
        }
        addTaskToLocalHistory({
            taskId: data.task_id,
            tool: 'sitemap-validate',
            url: sitemapUrl,
            status: data.status || 'SUCCESS',
            timestamp: new Date().toISOString()
        });
        window.location.href = `/results/${data.task_id}`;
    } catch (error) {
        console.error('Error starting sitemap validation:', error);
        alert('Failed to start sitemap validation: ' + (error.message || error));
    }
}

async function downloadBotXlsxReport() {
    if (!botData) {
        alert('No bot check data available');
        return;
    }
    try {
        const response = await fetch('/api/export/bot-xlsx', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ task_id: botData.task_id || taskId })
        });
        if (!response.ok) {
            const err = await response.json();
            throw new Error(err.error || `HTTP ${response.status}`);
        }
        const blob = await response.blob();
        const href = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const cd = response.headers.get('Content-Disposition') || '';
        const m = cd.match(/filename=([^;]+)/i);
        a.download = m ? m[1].replace(/\"/g, '') : `bot-report-${new Date().toISOString().slice(0,10)}.xlsx`;
        a.href = href;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(href);
    } catch (error) {
        console.error('Error downloading bot xlsx:', error);
        alert('Failed to download bot XLSX report');
    }
}

async function downloadBotDocxReport() {
    if (!botData) {
        alert('No bot check data available');
        return;
    }
    try {
        const response = await fetch('/api/export/bot-docx', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ task_id: botData.task_id || taskId })
        });
        if (!response.ok) {
            const err = await response.json();
            throw new Error(err.error || `HTTP ${response.status}`);
        }
        const blob = await response.blob();
        const href = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const cd = response.headers.get('Content-Disposition') || '';
        const m = cd.match(/filename=([^;]+)/i);
        a.download = m ? m[1].replace(/\"/g, '') : `bot-report-${new Date().toISOString().slice(0,10)}.docx`;
        a.href = href;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(href);
    } catch (error) {
        console.error('Error downloading bot docx:', error);
        alert('Failed to download bot DOCX report');
    }
}

async function downloadWordReport() {
    if (!robotsData) {
        alert('РќРµС‚ РґР°РЅРЅС‹С… РґР»СЏ РѕС‚С‡РµС‚Р°');
        return;
    }
    
    try {
        const response = await fetch('/api/export/robots', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ task_id: robotsData.task_id || robotsData.url })
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `robots-report-${new Date().toISOString().slice(0,10)}.docx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        } else {
            const error = await response.json();
            alert('РћС€РёР±РєР° РїСЂРё СЃРѕР·РґР°РЅРёРё РѕС‚С‡РµС‚Р°: ' + (error.error || response.statusText));
        }
    } catch (error) {
        console.error('Error downloading Word report:', error);
        alert('РћС€РёР±РєР° РїСЂРё СЃРєР°С‡РёРІР°РЅРёРё РѕС‚С‡РµС‚Р°');
    }
}

async function downloadMobileDocxReport() {
    if (!mobileData) {
        alert('РќРµС‚ РґР°РЅРЅС‹С… РјРѕР±РёР»СЊРЅРѕР№ РїСЂРѕРІРµСЂРєРё');
        return;
    }
    try {
        const response = await fetch('/api/export/mobile-docx', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ task_id: mobileData.task_id || taskId })
        });
        if (!response.ok) {
            const payloadType = response.headers.get('content-type') || '';
            if (payloadType.includes('application/json')) {
                const err = await response.json();
                throw new Error(err.error || err.detail || `HTTP ${response.status}`);
            }
            const rawText = await response.text();
            throw new Error(rawText || `HTTP ${response.status}`);
        }
        const blob = await response.blob();
        const href = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const cd = response.headers.get('Content-Disposition') || '';
        const m = cd.match(/filename=([^;]+)/i);
        a.download = m ? m[1].replace(/\"/g, '') : `mobile-report-${new Date().toISOString().slice(0,10)}.docx`;
        a.href = href;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(href);
    } catch (error) {
        console.error('РћС€РёР±РєР° СЃРєР°С‡РёРІР°РЅРёСЏ РјРѕР±РёР» DOCX:', error);
        alert('РќРµ СѓРґР°Р» СЃРєР°С‡Р°С‚СЊ DOCX-РѕС‚С‡РµС‚');
    }
}

async function downloadMobileXlsxReport() {
    if (!mobileData) {
        alert('РќРµС‚ РґР°РЅРЅС‹С… РјРѕР±РёР»СЊРЅРѕР№ РїСЂРѕРІРµСЂРєРё');
        return;
    }
    try {
        const response = await fetch('/api/export/mobile-xlsx', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ task_id: mobileData.task_id || taskId })
        });
        const payloadType = response.headers.get('content-type') || '';
        if (!response.ok || payloadType.includes('application/json')) {
            const err = await response.json();
            throw new Error(err.error || `HTTP ${response.status}`);
        }
        const blob = await response.blob();
        const href = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const cd = response.headers.get('Content-Disposition') || '';
        const m = cd.match(/filename=([^;]+)/i);
        a.download = m ? m[1].replace(/\"/g, '') : `mobile-issues-${new Date().toISOString().slice(0,10)}.xlsx`;
        a.href = href;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(href);
    } catch (error) {
        console.error('РћС€РёР±РєР° СЃРєР°С‡РёРІР°РЅРёСЏ РјРѕР±РёР» XLSX:', error);
        alert(error.message || 'РќРµ СѓРґР°Р» СЃРєР°С‡Р°С‚СЊ XLSX-РѕС‚С‡РµС‚');
    }
}

async function downloadRenderDocxReport() {
    if (!renderData) {
        alert('РќРµС‚ РґР°РЅРЅС‹С… СЂРµРЅРґРµСЂ-Р°СѓРґРёС‚Р°');
        return;
    }
    try {
        const response = await fetch('/api/export/render-docx', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ task_id: renderData.task_id || taskId })
        });
        if (!response.ok) {
            const err = await response.json();
            throw new Error(err.error || `HTTP ${response.status}`);
        }
        const blob = await response.blob();
        const href = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const cd = response.headers.get('Content-Disposition') || '';
        const m = cd.match(/filename=([^;]+)/i);
        a.download = m ? m[1].replace(/\"/g, '') : `render-report-${new Date().toISOString().slice(0,10)}.docx`;
        a.href = href;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(href);
    } catch (error) {
        console.error('РћС€РёР±РєР° СЃРєР°С‡РёРІР°РЅРёСЏ render DOCX:', error);
        alert('РќРµ СѓРґР°Р» СЃРєР°С‡Р°С‚СЊ DOCX-РѕС‚С‡РµС‚');
    }
}

async function downloadRenderXlsxReport() {
    if (!renderData) {
        alert('РќРµС‚ РґР°РЅРЅС‹С… СЂРµРЅРґРµСЂ-Р°СѓРґРёС‚Р°');
        return;
    }
    try {
        const response = await fetch('/api/export/render-xlsx', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ task_id: renderData.task_id || taskId })
        });
        const payloadType = response.headers.get('content-type') || '';
        if (!response.ok || payloadType.includes('application/json')) {
            const err = await response.json();
            throw new Error(err.error || `HTTP ${response.status}`);
        }
        const blob = await response.blob();
        const href = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const cd = response.headers.get('Content-Disposition') || '';
        const m = cd.match(/filename=([^;]+)/i);
        a.download = m ? m[1].replace(/\"/g, '') : `render-issues-${new Date().toISOString().slice(0,10)}.xlsx`;
        a.href = href;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(href);
    } catch (error) {
        console.error('РћС€РёР±РєР° СЃРєР°С‡РёРІР°РЅРёСЏ render XLSX:', error);
        alert(error.message || 'РќРµ СѓРґР°Р» СЃРєР°С‡Р°С‚СЊ XLSX-РѕС‚С‡РµС‚');
    }
}

async function downloadSiteAuditProXlsxReport() {
    if (!siteAuditProData) {
        alert('РќРµС‚ РґР°РЅРЅС‹С… Site Audit Pro');
        return;
    }
    try {
        const response = await fetch('/api/export/site-audit-pro-xlsx', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ task_id: siteAuditProData.task_id || taskId })
        });
        const payloadType = response.headers.get('content-type') || '';
        if (!response.ok || payloadType.includes('application/json')) {
            const err = await response.json();
            throw new Error(err.error || `HTTP ${response.status}`);
        }
        const blob = await response.blob();
        const href = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const cd = response.headers.get('Content-Disposition') || '';
        const m = cd.match(/filename=([^;]+)/i);
        a.download = m ? m[1].replace(/\"/g, '') : `site-audit-pro-${new Date().toISOString().slice(0,10)}.xlsx`;
        a.href = href;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(href);
    } catch (error) {
        console.error('РћС€РёР±РєР° СЃРєР°С‡РёРІР°РЅРёСЏ Site Audit Pro XLSX:', error);
        alert(error.message || 'РќРµ СѓРґР°Р» СЃРєР°С‡Р°С‚СЊ XLSX-РѕС‚С‡РµС‚');
    }
}

async function downloadSiteAuditProDocxReport() {
    if (!siteAuditProData) {
        alert('РќРµС‚ РґР°РЅРЅС‹С… Site Audit Pro');
        return;
    }
    try {
        const response = await fetch('/api/export/site-audit-pro-docx', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ task_id: siteAuditProData.task_id || taskId })
        });
        const payloadType = response.headers.get('content-type') || '';
        if (!response.ok || payloadType.includes('application/json')) {
            const err = await response.json();
            throw new Error(err.error || `HTTP ${response.status}`);
        }
        const blob = await response.blob();
        const href = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const cd = response.headers.get('Content-Disposition') || '';
        const m = cd.match(/filename=([^;]+)/i);
        a.download = m ? m[1].replace(/\"/g, '') : `site-audit-pro-${new Date().toISOString().slice(0,10)}.docx`;
        a.href = href;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(href);
    } catch (error) {
        console.error('РћС€РёР±РєР° СЃРєР°С‡РёРІР°РЅРёСЏ Site Audit Pro DOCX:', error);
        alert(error.message || 'РќРµ СѓРґР°Р» СЃРєР°С‡Р°С‚СЊ DOCX-РѕС‚С‡РµС‚');
    }
}

async function downloadOnpageDocxReport() {
    if (!onpageData) {
        alert('РќРµС‚ РґР°РЅРЅС‹С… OnPage Audit');
        return;
    }
    try {
        const response = await fetch('/api/export/onpage-docx', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ task_id: onpageData.task_id || taskId })
        });
        const payloadType = response.headers.get('content-type') || '';
        if (!response.ok || payloadType.includes('application/json')) {
            const err = await response.json();
            throw new Error(err.error || `HTTP ${response.status}`);
        }
        const blob = await response.blob();
        const href = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const cd = response.headers.get('Content-Disposition') || '';
        const m = cd.match(/filename=([^;]+)/i);
        a.download = m ? m[1].replace(/\"/g, '') : `onpage-report-${new Date().toISOString().slice(0,10)}.docx`;
        a.href = href;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(href);
    } catch (error) {
        console.error('РћС€РёР±РєР° СЃРєР°С‡РёРІР°РЅРёСЏ OnPage DOCX:', error);
        alert(error.message || 'РќРµ СѓРґР°Р»РѕСЃСЊ СЃРєР°С‡Р°С‚СЊ DOCX-РѕС‚С‡РµС‚');
    }
}

async function downloadOnpageXlsxReport() {
    if (!onpageData) {
        alert('РќРµС‚ РґР°РЅРЅС‹С… OnPage Audit');
        return;
    }
    try {
        const response = await fetch('/api/export/onpage-xlsx', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ task_id: onpageData.task_id || taskId })
        });
        const payloadType = response.headers.get('content-type') || '';
        if (!response.ok || payloadType.includes('application/json')) {
            const err = await response.json();
            throw new Error(err.error || `HTTP ${response.status}`);
        }
        const blob = await response.blob();
        const href = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const cd = response.headers.get('Content-Disposition') || '';
        const m = cd.match(/filename=([^;]+)/i);
        a.download = m ? m[1].replace(/\"/g, '') : `onpage-report-${new Date().toISOString().slice(0,10)}.xlsx`;
        a.href = href;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(href);
    } catch (error) {
        console.error('РћС€РёР±РєР° СЃРєР°С‡РёРІР°РЅРёСЏ OnPage XLSX:', error);
        alert(error.message || 'РќРµ СѓРґР°Р»РѕСЃСЊ СЃРєР°С‡Р°С‚СЊ XLSX-РѕС‚С‡РµС‚');
    }
}

let mobileLightboxItems = [];
let mobileLightboxIndex = 0;

function ensureMobileLightbox() {
    let overlay = document.getElementById('mobile-lightbox');
    if (overlay) return overlay;
    overlay = document.createElement('div');
    overlay.id = 'mobile-lightbox';
    overlay.className = 'fixed inset-0 bg-black/90 z-50 hidden items-center justify-center p-4';
    overlay.innerHTML = `
        <button id="mobile-lightbox-close" class="absolute top-4 right-4 text-white text-2xl px-3 py-1 bg-black/40 rounded">&times;</button>
        <button id="mobile-lightbox-prev" class="absolute left-4 text-white text-3xl px-3 py-1 bg-black/40 rounded">&lsaquo;</button>
        <img id="mobile-lightbox-image" class="max-w-full max-h-full rounded-lg shadow-2xl" src="" alt="screenshot">
        <button id="mobile-lightbox-next" class="absolute right-4 text-white text-3xl px-3 py-1 bg-black/40 rounded">&rsaquo;</button>
        <div id="mobile-lightbox-caption" class="absolute bottom-4 left-1/2 -translate-x-1/2 text-white bg-black/40 px-4 py-2 rounded"></div>
    `;
    document.body.appendChild(overlay);
    document.getElementById('mobile-lightbox-close').onclick = () => overlay.classList.add('hidden');
    document.getElementById('mobile-lightbox-prev').onclick = () => showMobileLightboxImage(mobileLightboxIndex - 1);
    document.getElementById('mobile-lightbox-next').onclick = () => showMobileLightboxImage(mobileLightboxIndex + 1);
    overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.classList.add('hidden'); });
    return overlay;
}

function showMobileLightboxImage(index) {
    if (!mobileLightboxItems.length) return;
    if (index < 0) index = mobileLightboxItems.length - 1;
    if (index >= mobileLightboxItems.length) index = 0;
    mobileLightboxIndex = index;
    const item = mobileLightboxItems[index];
    document.getElementById('mobile-lightbox-image').src = item.src;
    document.getElementById('mobile-lightbox-caption').textContent = item.caption || '';
}

function openMobileLightbox(index) {
    const overlay = ensureMobileLightbox();
    showMobileLightboxImage(index);
    overlay.classList.remove('hidden');
    overlay.classList.add('flex');
}

function generateRobotsHTML(data) {
    const resultData = data.result || data;
    const r = resultData.results || resultData;
    const sourceUrl = data.url || resultData.url || robotsData?.url || '';
    
    let userAgents = 'РќРµ РЅР°Р№РґРµРЅРѕ';
    if (Array.isArray(r.user_agents)) {
        userAgents = r.user_agents.join(', ');
    } else if (typeof r.user_agents === 'number') {
        userAgents = `${r.user_agents} pcs.`;
    } else if (r.user_agents) {
        userAgents = String(r.user_agents);
    }
    
    const issues = r.critical_issues || r.issues || [];
    const warnings = r.warning_issues || r.warnings || [];
    const infoIssues = r.info_issues || [];
    const sitemaps = r.sitemaps || [];
    const processedSitemaps = (sitemaps || []).map(s => s.url || s) || [];
    const sitemapChecks = r.sitemap_checks || [];
    const groups = r.groups_detail || r.groups || [];
    const recommendations = r.recommendations || [];
    const topFixes = r.top_fixes || [];
    const syntaxErrors = r.syntax_errors || [];
    const unsupportedDirectives = r.unsupported_directives || [];
    const hostValidation = r.host_validation || {};
    const hostWarnings = hostValidation.warnings || [];
    const hostList = hostValidation.hosts || r.hosts || [];
    const directiveConflicts = r.directive_conflicts || {};
    const conflictDetails = directiveConflicts.details || [];
    const longestMatch = r.longest_match_analysis || {};
    const longestMatchNotes = longestMatch.notes || [];
    const httpStatusAnalysis = r.http_status_analysis || {};
    const httpStatusNotes = httpStatusAnalysis.notes || [];
    const paramRecommendations = r.param_recommendations || [];
    const rawContent = r.raw_content || '';
    const rawWithLineNumbers = formatRobotsRawWithLineNumbers(rawContent);
    const qualityScore = Number.isFinite(r.quality_score) ? r.quality_score : 0;
    const qualityGrade = r.quality_grade || 'РЅ/Рґ';
    const productionReady = !!r.production_ready;
    
    let totalDisallow = 0;
    let totalAllow = 0;
    groups.forEach(g => {
        totalDisallow += (g.disallow || []).length;
        totalAllow += (g.allow || []).length;
    });
    
    const userAgentCount = r.user_agents || 0;
    const disallowRulesCount = totalDisallow;
    const allowRulesCount = totalAllow;
    
    let issuesHTML = '';
    if (issues.length > 0) {
        issuesHTML = issues.map(issue => `
            <div class="bg-red-50 border border-red-200 rounded-lg p-3 mb-2">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
                    <span class="text-red-700 font-medium">${issue}</span>
                </div>
            </div>
        `).join('');
    }
    
    let warningsHTML = '';
    if (warnings.length > 0) {
        warningsHTML = warnings.map(warning => `
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-2">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-circle text-yellow-500 mr-2"></i>
                    <span class="text-yellow-700">${warning}</span>
                </div>
            </div>
        `).join('');
    }
    
    let sitemapsHtml = '';
    if (processedSitemaps.length > 0) {
        sitemapsHtml = processedSitemaps.map(sm => {
            const canCheck = /^https?:\/\//i.test(sm || '');
            return `
            <div class="flex items-center gap-2 bg-green-50 border border-green-200 rounded px-3 py-2 mb-1">
                <i class="fas fa-sitemap text-green-500"></i>
                <a href="${sm}" target="_blank" class="text-green-700 hover:underline text-sm break-all flex-1">${sm}</a>
                <button
                    ${canCheck ? `onclick='runSitemapCheckFromRobots(${JSON.stringify(sm)})'` : 'disabled'}
                    class="text-xs px-3 py-1 rounded border ${canCheck ? 'border-blue-200 text-blue-700 hover:bg-blue-50' : 'border-gray-200 text-gray-400 cursor-not-allowed'}"
                    title="Run sitemap check in standalone sitemap tool"
                >
                    РџСЂРѕРІРµСЂРёС‚СЊ
                </button>
            </div>
        `;
        }).join('');
    }
    
    let groupsHTML = '';
    if (groups.length > 0) {
        groupsHTML = groups.map((group, idx) => `
            <div class="border rounded-lg mb-4 overflow-hidden">
                <div class="bg-gray-100 px-4 py-2 border-b">
                    <span class="font-semibold text-gray-700">Р“СЂСѓРїРїР° ${idx + 1}:</span>
                    <span class="text-gray-600 ml-2">${group.user_agents.join(', ')}</span>
                </div>
                <div class="p-4">
                    ${group.disallow.length > 0 ? `
                        <div class="mb-3">
                            <h5 class="text-sm font-medium text-red-600 mb-2">Disallow (${group.disallow.length}):</h5>
                            <div class="max-h-40 overflow-y-auto">
                                ${group.disallow.map(d => `
                                    <div class="flex items-center text-sm font-mono bg-red-50 px-2 py-1 rounded mb-1">
                                        <span class="text-red-600 mr-2">Disallow:</span>
                                        <span class="text-gray-700 break-all">${d.path}</span>
                                        <span class="text-gray-400 ml-auto text-xs">line ${d.line}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    ${group.allow.length > 0 ? `
                        <div>
                            <h5 class="text-sm font-medium text-green-600 mb-2">Allow (${group.allow.length}):</h5>
                            <div class="max-h-40 overflow-y-auto">
                                ${group.allow.map(a => `
                                    <div class="flex items-center text-sm font-mono bg-green-50 px-2 py-1 rounded mb-1">
                                        <span class="text-green-600 mr-2">Allow:</span>
                                        <span class="text-gray-700 break-all">${a.path}</span>
                                        <span class="text-gray-400 ml-auto text-xs">line ${a.line}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
        `).join('');
    }
    
    let recommendationsHTML = '';
    if (recommendations.length > 0) {
        recommendationsHTML = recommendations.map(rec => `
            <div class="flex items-start mb-2 p-2 bg-blue-50 rounded">
                <i class="fas fa-lightbulb text-blue-500 mr-2 mt-1"></i>
                <span class="text-sm text-blue-700">${rec}</span>
            </div>
        `).join('');
    }

    let topFixesHTML = '';
    if (topFixes.length > 0) {
        topFixesHTML = topFixes.map(fix => `
            <div class="border rounded-lg p-3 mb-2 bg-indigo-50 border-indigo-200">
                <div class="text-sm font-semibold text-indigo-700">[${(fix.priority || 'medium').toUpperCase()}] ${fix.title || 'Fix'}</div>
                ${fix.why ? `<div class="text-sm text-indigo-700 mt-1">Why: ${fix.why}</div>` : ''}
                ${fix.action ? `<div class="text-sm text-indigo-800 mt-1">Action: ${fix.action}</div>` : ''}
            </div>
        `).join('');
    }

    let sitemapChecksHTML = '';
    if (sitemapChecks.length > 0) {
        sitemapChecksHTML = sitemapChecks.map(check => {
            const ok = check.ok;
            const badge = ok === true ? 'bg-green-100 text-green-700' : (ok === null ? 'bg-gray-100 text-gray-700' : 'bg-red-100 text-red-700');
            const status = ok === true ? '' : (ok === null ? 'РџР РћРџРЈР©Р•' : 'РћРЁРР‘');
            return `
                <div class="border rounded-lg p-3 mb-2">
                    <div class="flex items-center justify-between">
                        <a href="${check.url}" target="_blank" class="text-sm text-blue-600 hover:underline break-all">${check.url}</a>
                        <span class="text-xs px-2 py-1 rounded ${badge}">${status}</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">
                        ${check.status_code ? `HTTP ${check.status_code}` : ''} ${check.error ? `РІР‚Сћ ${check.error}` : ''}
                    </div>
                </div>
            `;
        }).join('');
    }

    let syntaxErrorsHTML = '';
    if (syntaxErrors.length > 0) {
        syntaxErrorsHTML = syntaxErrors.map(err => `
            <div class="border rounded-lg p-3 mb-2 bg-rose-50 border-rose-200">
                <div class="text-sm text-rose-700 font-medium">Line ${err.line || '?'}</div>
                <div class="text-sm text-rose-700">${err.error || ''}</div>
                ${err.content ? `<div class="text-xs text-rose-600 mt-1 font-mono break-all">${escapeHtml(err.content)}</div>` : ''}
            </div>
        `).join('');
    }

    let unsupportedDirectivesHTML = '';
    if (unsupportedDirectives.length > 0) {
        unsupportedDirectivesHTML = unsupportedDirectives.map(item => `
            <div class="border rounded-lg p-3 mb-2 bg-amber-50 border-amber-200 text-amber-800 text-sm">
                <span class="font-semibold">Line ${item.line || '?'}</span>
                : <span class="font-mono">${item.directive || ''}${item.value ? `: ${item.value}` : ''}</span>
            </div>
        `).join('');
    }

    let hostValidationHTML = '';
    if (hostList.length > 0 || hostWarnings.length > 0) {
        hostValidationHTML = `
            ${hostList.length > 0 ? `<div class="text-sm text-gray-700 mb-2"><span class="font-semibold">Hosts:</span> ${hostList.join(', ')}</div>` : ''}
            ${hostWarnings.map(w => `<div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-2 text-yellow-700 text-sm">${w}</div>`).join('')}
        `;
    }

    let conflictDetailsHTML = '';
    if (conflictDetails.length > 0) {
        conflictDetailsHTML = conflictDetails.map(item => `
            <div class="border rounded-lg p-3 mb-2 bg-orange-50 border-orange-200 text-sm text-orange-800">
                <span class="font-semibold">${item.type || 'conflict'}</span>
                ${item.user_agent ? ` | UA: ${item.user_agent}` : ''}
                ${item.path ? ` | Path: ${item.path}` : ''}
                ${item.groups ? ` | Groups: ${item.groups}` : ''}
            </div>
        `).join('');
    }

    let longestMatchHTML = '';
    if (longestMatchNotes.length > 0) {
        longestMatchHTML = longestMatchNotes.map(note => `
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-2 text-blue-700 text-sm">${note}</div>
        `).join('');
    }

    let httpStatusAnalysisHTML = '';
    if (httpStatusNotes.length > 0) {
        httpStatusAnalysisHTML = `
            <div class="text-sm text-gray-700 mb-2"><span class="font-semibold">HTTP status context:</span> ${httpStatusAnalysis.status_code ?? r.status_code ?? 'n/a'}</div>
            ${httpStatusNotes.map(note => `<div class="bg-slate-50 border border-slate-200 rounded-lg p-3 mb-2 text-slate-700 text-sm">${note}</div>`).join('')}
        `;
    }

    let paramRecommendationsHTML = '';
    if (paramRecommendations.length > 0) {
        paramRecommendationsHTML = paramRecommendations.map(note => `
            <div class="bg-cyan-50 border border-cyan-200 rounded-lg p-3 mb-2 text-cyan-700 text-sm">${note}</div>
        `).join('');
    }
    
    return `
        <div class="space-y-6">
            <!-- Actions -->
            <div class="bg-white rounded-xl shadow-md p-4 flex flex-wrap gap-3">
                <button onclick="downloadTextReport()" class="inline-flex items-center bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition cursor-pointer">
                    <i class="fas fa-file-download mr-2"></i>
                    РЎРєР°С‡Р°С‚СЊ РѕС‚С‡РµС‚ (.txt)
                </button>
                <button onclick="downloadWordReport()" class="inline-flex items-center bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition cursor-pointer">
                    <i class="fas fa-file-word mr-2"></i>
                    РЎРєР°С‡Р°С‚СЊ РѕС‚С‡РµС‚ (.docx)
                </button>
                <button onclick="copyToClipboard(JSON.stringify(robotsData, null, 2))" class="inline-flex items-center bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition">
                    <i class="fas fa-copy mr-2"></i>
                    РљРѕРїРёСЂРѕРІР°С‚СЊ JSON
                </button>

                <button onclick='copyToClipboard(${JSON.stringify(rawContent)})' class="inline-flex items-center bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition">
                    <i class="fas fa-file-alt mr-2"></i>
                    Copy robots.txt
                </button>

            </div>
            
            <!-- Summary Stats -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">РџСЂРѕРІРµСЂРєР° Robots.txt</h3>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-6 gap-4 mb-4">
                    <div class="text-center p-3 ${productionReady ? 'bg-emerald-50' : 'bg-amber-50'} rounded-lg">
                        <div class="text-2xl font-bold ${productionReady ? 'text-emerald-600' : 'text-amber-600'}">${qualityScore}</div>
                        <div class="text-xs text-gray-500">РћС†РµРЅРєР° (${qualityGrade})</div>
                    </div>
                    <div class="text-center p-3 bg-blue-50 rounded-lg">
                        <div class="text-2xl font-bold text-blue-600">${userAgentCount}</div>
                        <div class="text-xs text-gray-500">User-Agents</div>
                    </div>
                    <div class="text-center p-3 bg-red-50 rounded-lg">
                        <div class="text-2xl font-bold text-red-600">${disallowRulesCount}</div>
                        <div class="text-xs text-gray-500">Disallow</div>
                    </div>
                    <div class="text-center p-3 bg-green-50 rounded-lg">
                        <div class="text-2xl font-bold text-green-600">${allowRulesCount}</div>
                        <div class="text-xs text-gray-500">Allow</div>
                    </div>
                    <div class="text-center p-3 bg-purple-50 rounded-lg">
                        <div class="text-2xl font-bold text-purple-600">${r.content_length || 0}</div>
                        <div class="text-xs text-gray-500">Байт</div>
                    </div>
                    <div class="text-center p-3 bg-gray-50 rounded-lg">
                        <div class="text-2xl font-bold text-gray-600">${r.lines_count || 0}</div>
                        <div class="text-xs text-gray-500">Lines</div>
                    </div>
                </div>
                
                <div class="text-sm text-gray-600 border-t pt-3">
                    <span class="font-medium">URL:</span> <a href="${sourceUrl}" target="_blank" class="text-blue-600 hover:underline">${sourceUrl}</a>
                    <span class="mx-2">|</span>
                    <span class="font-medium">Robots.txt:</span> 
                    <a href="${sourceUrl.replace(/\/$/, '')}/robots.txt" target="_blank" class="text-blue-600 hover:underline">РїРѕРєР°Р·Р°С‚СЊ файл</a>
                </div>
            </div>
            
            <!-- Issues -->
            ${issuesHTML ? `
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h4 class="text-lg font-semibold text-red-600 mb-3">
                        <i class="fas fa-exclamation-triangle mr-2"></i>РџСЂРѕР±Р»РµРјС‹ (${issues.length})
                    </h4>
                    ${issuesHTML}
                </div>
            ` : '<div class="bg-white rounded-xl shadow-md p-6"><div class="text-green-600"><i class="fas fa-check mr-2"></i>РљСЂРёС‚РёС‡РµСЃРєРёС… РїСЂРѕР±Р»РµРј РЅРµ РѕР±РЅР°СЂСѓР¶РµРЅРѕ</div></div>'}
            
            <!-- Warnings -->
            ${warningsHTML ? `
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h4 class="text-lg font-semibold text-yellow-600 mb-3">
                        <i class="fas fa-exclamation-circle mr-2"></i>РџСЂРµРґСѓРїСЂРµР¶РґРµРЅРёСЏ (${warnings.length})
                    </h4>
                    ${warningsHTML}
                </div>
            ` : ''}

            ${infoIssues.length > 0 ? `
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h4 class="text-lg font-semibold text-sky-600 mb-3">
                        <i class="fas fa-info-circle mr-2"></i>РРЅС„Рѕ (${infoIssues.length})
                    </h4>
                    ${infoIssues.map(item => `
                        <div class="bg-sky-50 border border-sky-200 rounded-lg p-3 mb-2 text-sky-700 text-sm">${item}</div>
                    `).join('')}
                </div>
            ` : ''}
             
            ${httpStatusAnalysisHTML ? `
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h4 class="text-lg font-semibold text-slate-700 mb-3">
                        <i class="fas fa-server mr-2"></i>HTTP Status Analysis
                    </h4>
                    ${httpStatusAnalysisHTML}
                </div>
            ` : ''}

            ${unsupportedDirectivesHTML ? `
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h4 class="text-lg font-semibold text-amber-700 mb-3">
                        <i class="fas fa-ban mr-2"></i>Unsupported Directives (${unsupportedDirectives.length})
                    </h4>
                    ${unsupportedDirectivesHTML}
                </div>
            ` : ''}

            ${syntaxErrorsHTML ? `
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h4 class="text-lg font-semibold text-rose-700 mb-3">
                        <i class="fas fa-code-branch mr-2"></i>Syntax Errors (${syntaxErrors.length})
                    </h4>
                    ${syntaxErrorsHTML}
                </div>
            ` : ''}

            ${hostValidationHTML ? `
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h4 class="text-lg font-semibold text-yellow-700 mb-3">
                        <i class="fas fa-network-wired mr-2"></i>Host Validation
                    </h4>
                    ${hostValidationHTML}
                </div>
            ` : ''}

            ${conflictDetailsHTML ? `
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h4 class="text-lg font-semibold text-orange-700 mb-3">
                        <i class="fas fa-random mr-2"></i>Directive Conflicts (${conflictDetails.length})
                    </h4>
                    ${conflictDetailsHTML}
                </div>
            ` : ''}

            ${longestMatchHTML ? `
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h4 class="text-lg font-semibold text-blue-700 mb-3">
                        <i class="fas fa-ruler-combined mr-2"></i>Longest Match Notes (${longestMatchNotes.length})
                    </h4>
                    ${longestMatchHTML}
                </div>
            ` : ''}

            ${paramRecommendationsHTML ? `
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h4 class="text-lg font-semibold text-cyan-700 mb-3">
                        <i class="fas fa-filter mr-2"></i>Yandex Clean-param Recommendations (${paramRecommendations.length})
                    </h4>
                    ${paramRecommendationsHTML}
                </div>
            ` : ''}

            <!-- Sitemaps -->
            ${processedSitemaps.length > 0 ? `
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="flex items-center justify-between mb-3 gap-3">
                        <h4 class="text-lg font-semibold text-green-600">
                            <i class="fas fa-sitemap mr-2"></i>Sitemap (${processedSitemaps.length})
                        </h4>
                        <a href="/" class="text-sm text-blue-600 hover:underline whitespace-nowrap">РћС‚РєСЂС‹С‚СЊ РёРЅСЃС‚СЂСѓРјРµРЅС‚ sitemap</a>
                    </div>
                    ${sitemapsHtml}
                </div>
            ` : ''}

            ${sitemapChecksHTML ? `
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h4 class="text-lg font-semibold text-indigo-600 mb-3">
                        <i class="fas fa-shield-alt mr-2"></i>РџСЂРѕРІРµСЂРєРё URL РёР· sitemap (${sitemapChecks.length})
                    </h4>
                    ${sitemapChecksHTML}
                </div>
            ` : ''}
            
            <!-- Groups Detail -->
            ${groupsHTML ? `
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h4 class="text-lg font-semibold text-gray-700 mb-3">
                        <i class="fas fa-list mr-2"></i>Р”РµС‚Р°Р»СЊРЅС‹Р№ Р°РЅР°Р»РёР· 
                    </h4>
                    ${groupsHTML}
                </div>
            ` : ''}

            ${rawContent ? `
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-lg font-semibold text-gray-700">
                            <i class="fas fa-file-code mr-2"></i>Robots.txt (Raw)
                        </h4>
                        <div class="text-xs text-gray-500">Line numbers are visual only</div>
                    </div>
                    <div class="text-xs bg-gray-900 text-gray-100 p-4 rounded-lg overflow-auto max-h-96 font-mono">${rawWithLineNumbers}</div>
                </div>
            ` : ''}
            
            <!-- Recommendations -->
            ${recommendationsHTML ? `
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h4 class="text-lg font-semibold text-blue-600 mb-3">
                        <i class="fas fa-lightbulb mr-2"></i>Р РµРєРѕРјРµРЅРґР°С†РёРё
                    </h4>
                    ${recommendationsHTML}
                </div>
            ` : ''}
            
            ${topFixesHTML ? `
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h4 class="text-lg font-semibold text-indigo-700 mb-3">
                        <i class="fas fa-wrench mr-2"></i>РџСЂРёРѕСЂРёС‚РµС‚РЅС‹Рµ РёСЃРїСЂР°РІР»РµРЅРёСЏ (${topFixes.length})
                    </h4>
                    ${topFixesHTML}
                </div>
            ` : ''}

            <div class="bg-white rounded-xl shadow-md p-6">
                <h4 class="text-lg font-semibold text-gray-700 mb-3">
                    <i class="fas fa-book mr-2"></i>Official Robots.txt Help
                </h4>
                <div class="space-y-2 text-sm">
                    <a class="text-blue-600 hover:underline break-all" href="https://developers.google.com/search/docs/crawling-indexing/robots/robots_txt" target="_blank" rel="noopener noreferrer">
                        Google Search Central: robots.txt specification
                    </a>
                    <a class="text-blue-600 hover:underline break-all" href="https://yandex.com/support/webmaster/en/robot-workings/allow-disallow" target="_blank" rel="noopener noreferrer">
                        Yandex Webmaster: Allow/Disallow directives
                    </a>
                    <a class="text-blue-600 hover:underline break-all" href="https://yandex.com/support/webmaster/en/robot-workings/clean-param" target="_blank" rel="noopener noreferrer">
                        Yandex Webmaster: Clean-param directive
                    </a>
                </div>
            </div>
        </div>
    `;
}

function generateSitemapHTMLV2(result) {
    const r = result.results || result;
    const exportUrls = r.export_urls || [];
    const sitemapFiles = r.sitemap_files || [];
    const warnings = r.warnings || [];
    const errors = r.errors || [];
    const recommendations = r.recommendations || [];
    const highlights = r.highlights || [];
    const qualityScore = Number.isFinite(r.quality_score) ? r.quality_score : null;
    const qualityGrade = r.quality_grade || '';
    const duplicateDetails = r.duplicate_details || [];
    const duplicateLines = duplicateDetails.map(d => `${d.url}\tРїРµСЂРІС‹Р№: ${d.first_sitemap || '-'}\tРґСѓР±Р»РёРєР°С‚: ${d.duplicate_sitemap || '-'}`);
    const exportChunkSize = r.export_chunk_size || 25000;
    const dateStamp = new Date().toISOString().slice(0, 10);
    const safeDomain = (result.url || 'sitemap').replace(/https?:\/\//, '').replace(/[^\w.-]+/g, '_');
    sitemapExportUrls = exportUrls;
    sitemapDuplicateLines = duplicateLines;
    sitemapFilePreviewUrls = sitemapFiles.map(f => (f.urls || []).slice(0, 100000));
    const totalIssues = errors.length + warnings.length;
    const healthBadge = r.valid && totalIssues === 0 ? 'bg-emerald-100 text-emerald-700' : (r.valid ? 'bg-amber-100 text-amber-700' : 'bg-rose-100 text-rose-700');
    const healthText = r.valid && totalIssues === 0 ? 'Healthy sitemap' : (r.valid ? 'Valid with warnings' : 'Needs fixes');
    const totalUrls = Number(r.urls_count || 0);
    const uniqueUrls = Number(r.unique_urls_count || 0);
    const scanned = Number(r.sitemaps_scanned || 0);
    const validScanned = Number(r.sitemaps_valid || 0);
    const exported = Number(exportUrls.length || 0);
    const coverageUnique = totalUrls > 0 ? Math.round((uniqueUrls / totalUrls) * 1000) / 10 : 0;
    const filesValidRate = scanned > 0 ? Math.round((validScanned / scanned) * 1000) / 10 : 0;
    const exportCoverage = totalUrls > 0 ? Math.round((exported / totalUrls) * 1000) / 10 : 0;
    const riskLevel = errors.length > 0 ? 'High' : (warnings.length > 0 ? 'Medium' : 'Low');
    const scanLimitFiles = Number(r.scan_limit_files || 0);
    const scanLimitReached = !!r.scan_limit_reached;
    const scanQueueRemaining = Number(r.scan_queue_remaining || 0);
    const scanProgressByLimit = scanLimitFiles > 0 ? Math.min(100, Math.round((scanned / scanLimitFiles) * 1000) / 10) : 100;
    const maxUrlsPerFile = Math.max(1, ...sitemapFiles.map(f => Number(f.urls_count || 0)));
    const phaseFetchDone = Number.isFinite(Number(r.status_code)) && Number(r.status_code) > 0;
    const phaseTraverseDone = scanned > 0;
    const phaseParseDone = totalUrls > 0 || errors.length > 0;
    const phaseFinalizeDone = true;

    return `
        <div class="space-y-4">
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Р’Р°Р»РёРґР°С†РёСЏ Sitemap</h3>
                    <div class="flex gap-2">
                        <button onclick="copyToClipboard('${result.url}')" class="text-blue-600 hover:text-blue-800 text-sm">
                            <i class="fas fa-copy mr-1"></i>РљРѕРїРёСЂРѕРІР°С‚СЊ URL
                        </button>
                        ${exportUrls.length > 0 ? `
                            <button onclick='downloadCurrentSitemapUrls("sitemap-urls-${safeDomain}-${dateStamp}")' class="text-green-600 hover:text-green-800 text-sm">
                                <i class="fas fa-file-download mr-1"></i>Р­РєСЃРїРѕСЂС‚ URL (.txt)
                            </button>
                            <button onclick='downloadCurrentSitemapUrlsParts("sitemap-urls-${safeDomain}-${dateStamp}", ${exportChunkSize})' class="text-green-600 hover:text-green-800 text-sm">
                                <i class="fas fa-layer-group mr-1"></i>Р­РєСЃРїРѕСЂС‚ URL (С‡Р°СЃС‚СЏРјРё)
                            </button>
                        ` : ''}
                        <button onclick="downloadSitemapXlsxReport()" class="text-indigo-600 hover:text-indigo-800 text-sm">
                            <i class="fas fa-file-excel mr-1"></i>РЎРєР°С‡Р°С‚СЊ XLSX
                        </button>
                        <button onclick="copyToClipboard(JSON.stringify(lastTaskResult, null, 2))" class="text-blue-600 hover:text-blue-800 text-sm">
                            <i class="fas fa-code mr-1"></i>JSON
                        </button>
                    </div>
                </div>
                <p class="text-sm text-gray-600 mb-4">
                    РћС‚С‡РµС‚ РїРѕРєР°Р·С‹РІР°РµС‚ РєРѕСЂСЂРµРєС‚РЅРѕСЃС‚СЊ СЃС‚СЂСѓРєС‚СѓСЂС‹ sitemap, РєР°С‡РµСЃС‚РІРѕ URL Рё СЂРёСЃРєРё РґР»СЏ РёРЅРґРµРєСЃР°С†РёРё.
                </p>
                <div class="mb-4">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${healthBadge}">
                        ${healthText}
                    </span>
                    <span class="ml-3 text-sm text-gray-600">Errors: ${errors.length} | Warnings: ${warnings.length} | Recommendations: ${recommendations.length}${qualityScore !== null ? ` | Score: ${qualityScore}${qualityGrade ? ` (${qualityGrade})` : ''}` : ''}</span>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div><span class="text-gray-600">URL:</span> <span class="font-medium break-all">${result.url}</span></div>
                    <div><span class="text-gray-600">Р’Р°Р»РёРґРµРЅ:</span> <span class="font-medium">${r.valid ? 'Р”Р°' : 'РќРµС‚'}</span></div>
                    <div><span class="text-gray-600">HTTP:</span> <span class="font-medium">${r.status_code || 'РЅ/Рґ'}</span></div>
                    <div><span class="text-gray-600">Р’СЃРµ URL:</span> <span class="font-medium">${r.urls_count || 0}</span></div>
                    <div><span class="text-gray-600">РЈРЅРёРєР°Р»СЊРЅС‹С… URL:</span> <span class="font-medium">${r.unique_urls_count || 0}</span></div>
                    <div><span class="text-gray-600">Р”СѓР±Р»РёРєР°С‚:</span> <span class="font-medium">${r.duplicate_urls_count || 0}</span></div>
                    <div><span class="text-gray-600">Sitemap РїСЂРѕРІРµСЂРµРЅРѕ:</span> <span class="font-medium">${r.sitemaps_scanned || 0}</span></div>
                    <div><span class="text-gray-600">Sitemap РІР°Р»РёРґРЅРѕ:</span> <span class="font-medium">${r.sitemaps_valid || 0}</span></div>
                    <div><span class="text-gray-600">Invalid URL:</span> <span class="font-medium">${r.invalid_urls_count || 0}</span></div>
                    <div><span class="text-gray-600">Invalid lastmod:</span> <span class="font-medium">${r.invalid_lastmod_count || 0}</span></div>
                    <div><span class="text-gray-600">Invalid changefreq:</span> <span class="font-medium">${r.invalid_changefreq_count || 0}</span></div>
                    <div><span class="text-gray-600">Invalid priority:</span> <span class="font-medium">${r.invalid_priority_count || 0}</span></div>
                    <div><span class="text-gray-600">Size:</span> <span class="font-medium">${r.size || 0} bytes</span></div>
                </div>
                ${r.error ? `<div class="mt-3 text-red-600 font-medium">РћС€РёР±РєР°: ${r.error}</div>` : ''}
                ${r.urls_export_truncated ? `<div class="mt-3 text-amber-700 text-sm">Р­РєСЃРїРѕСЂС‚ РѕРіСЂР°РЅРёС‡РµРЅ РґРѕ ${r.max_export_urls || 0} URL.</div>` : ''}
                ${(r.export_parts_count || 0) > 1 ? `<div class="mt-2 text-gray-600 text-sm">Р РµРєРѕРјРµРЅРґСѓРµРјРѕРµ С‡РёСЃР»Рѕ С‡Р°СЃС‚РµР№: ${r.export_parts_count} ( ${exportChunkSize} URL).</div>` : ''}
            </div>

            <div class="bg-white rounded-xl shadow-md p-6">
                <h4 class="font-semibold text-gray-700 mb-3">Scan Visualization</h4>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs mb-4">
                    <div class="px-3 py-2 rounded border ${phaseFetchDone ? 'bg-emerald-50 border-emerald-200 text-emerald-700' : 'bg-gray-50 border-gray-200 text-gray-500'}">1. Fetch root</div>
                    <div class="px-3 py-2 rounded border ${phaseTraverseDone ? 'bg-emerald-50 border-emerald-200 text-emerald-700' : 'bg-gray-50 border-gray-200 text-gray-500'}">2. Traverse sitemap index</div>
                    <div class="px-3 py-2 rounded border ${phaseParseDone ? 'bg-emerald-50 border-emerald-200 text-emerald-700' : 'bg-gray-50 border-gray-200 text-gray-500'}">3. Parse URLs</div>
                    <div class="px-3 py-2 rounded border ${phaseFinalizeDone ? 'bg-emerald-50 border-emerald-200 text-emerald-700' : 'bg-gray-50 border-gray-200 text-gray-500'}">4. Build report</div>
                </div>
                <div class="space-y-3">
                    <div>
                        <div class="flex justify-between text-xs text-gray-600 mb-1">
                            <span>Traversal progress</span>
                            <span>${scanned} / ${scanLimitFiles || scanned} files (${scanProgressByLimit}%)</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-500 h-2 rounded-full" style="width:${scanProgressByLimit}%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-xs text-gray-600 mb-1">
                            <span>Unique URL coverage</span>
                            <span>${coverageUnique}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-emerald-500 h-2 rounded-full" style="width:${coverageUnique}%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-xs text-gray-600 mb-1">
                            <span>Export coverage</span>
                            <span>${exportCoverage}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-indigo-500 h-2 rounded-full" style="width:${exportCoverage}%"></div>
                        </div>
                    </div>
                </div>
                ${scanLimitReached ? `<div class="mt-3 text-xs text-amber-700">Traversal limit reached: ${scanLimitFiles}. Remaining queued sitemaps: ${scanQueueRemaining}.</div>` : ''}
            </div>

            <div class="bg-white rounded-xl shadow-md p-6">
                <h4 class="font-semibold text-gray-700 mb-3">Coverage Insights</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div class="bg-slate-50 border border-slate-200 rounded-lg p-3">
                        <div class="text-slate-500">Unique URL coverage</div>
                        <div class="text-lg font-semibold text-slate-800">${coverageUnique}%</div>
                        <div class="text-xs text-slate-500">Unique / Total = ${uniqueUrls} / ${totalUrls}</div>
                    </div>
                    <div class="bg-slate-50 border border-slate-200 rounded-lg p-3">
                        <div class="text-slate-500">Valid sitemap files</div>
                        <div class="text-lg font-semibold text-slate-800">${filesValidRate}%</div>
                        <div class="text-xs text-slate-500">Valid / Scanned = ${validScanned} / ${scanned}</div>
                    </div>
                    <div class="bg-slate-50 border border-slate-200 rounded-lg p-3">
                        <div class="text-slate-500">Export coverage</div>
                        <div class="text-lg font-semibold text-slate-800">${exportCoverage}%</div>
                        <div class="text-xs text-slate-500">Exported / Total = ${exported} / ${totalUrls}</div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6">
                <h4 class="font-semibold text-gray-700 mb-3">Indexation Risk</h4>
                <div class="text-sm text-gray-700">
                    <span class="font-medium">Risk level:</span> ${riskLevel} |
                    <span class="font-medium">Errors:</span> ${errors.length} |
                    <span class="font-medium">Warnings:</span> ${warnings.length}
                </div>
                <div class="mt-2 text-xs text-gray-500">
                    High: sitemap fetch/parse errors. Medium: valid structure with warnings. Low: no errors and no warnings.
                </div>
            </div>

            ${errors.length > 0 ? `
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h4 class="font-semibold text-red-600 mb-2">РћС€РёР±РєРё (${errors.length})</h4>
                    ${errors.slice(0, 50).map(e => `<div class="text-sm text-red-700 mb-1">${escapeHtml(e)}</div>`).join('')}
                </div>
            ` : ''}

            ${warnings.length > 0 ? `
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h4 class="font-semibold text-amber-600 mb-2">РџСЂРµРґСѓРїСЂРµР¶РґРµРЅРёСЏ (${warnings.length})</h4>
                    ${warnings.slice(0, 50).map(w => `<div class="text-sm text-amber-700 mb-1">${escapeHtml(w)}</div>`).join('')}
                </div>
            ` : ''}

            ${duplicateDetails.length > 0 ? `
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-semibold text-rose-700">Р”СѓР±Р»Рё URL (${duplicateDetails.length})</h4>
                        <button onclick='downloadCurrentSitemapDuplicates("sitemap-duplicates-${safeDomain}-${dateStamp}.txt")' class="text-xs text-rose-700 hover:text-rose-900">
                            <i class="fas fa-file-download mr-1"></i>Р­РєСЃРїРѕСЂС‚ РґСѓР±Р»РµР№
                        </button>
                    </div>
                    ${r.duplicate_details_truncated ? `<div class="text-xs text-amber-700 mb-2">РЎРїРёСЃРѕРє СЃРѕРєСЂР°С‰РµРЅ.</div>` : ''}
                    <div class="max-h-72 overflow-auto border rounded">
                        ${duplicateDetails.slice(0, 500).map(d => `
                            <div class="text-xs border-b p-2">
                                <div class="font-medium break-all text-gray-800">${escapeHtml(d.url)}</div>
                                <div class="text-gray-600">РїРµСЂРІС‹Р№: <span class="break-all">${escapeHtml(d.first_sitemap || '-')}</span></div>
                                <div class="text-gray-600">РґСѓР±Р»РёРєР°С‚: <span class="break-all">${escapeHtml(d.duplicate_sitemap || '-')}</span></div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}

            ${recommendations.length > 0 ? `
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h4 class="font-semibold text-blue-600 mb-2">Р РµРєРѕРјРµРЅРґР°С†РёРё</h4>
                    ${recommendations.map(rec => `<div class="text-sm text-blue-700 mb-1">- ${escapeHtml(rec)}</div>`).join('')}
                </div>
            ` : ''}

            ${highlights.length > 0 ? `
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h4 class="font-semibold text-emerald-700 mb-2">РљР»СЋС‡РµРІС‹Рµ РІС‹РІРѕРґС‹</h4>
                    ${highlights.map(item => `<div class="text-sm text-emerald-700 mb-1">- ${escapeHtml(item)}</div>`).join('')}
                </div>
            ` : ''}

            <div class="bg-white rounded-xl shadow-md p-6">
                <h4 class="font-semibold text-gray-700 mb-3">Файлы Sitemap (${sitemapFiles.length})</h4>
                <div class="space-y-3">
                    ${sitemapFiles.map((f, idx) => `
                        <div class="border rounded-lg p-3">
                            <div class="flex justify-between items-center mb-1">
                                <div class="text-sm font-medium break-all">${escapeHtml(f.sitemap_url)}</div>
                                <div class="text-xs ${f.ok ? 'text-green-600' : 'text-red-600'}">${f.ok ? '' : 'РћРЁРР‘'}</div>
                            </div>
                            <div class="text-xs text-gray-600 mb-2">С‚РёРї: ${escapeHtml(f.type || 'РЅРµРёР·РІРµСЃС‚РЅРѕ')} | HTTP: ${f.status_code || 'РЅ/Рґ'} | URL: ${f.urls_count || 0}</div>
                            ${f.duplicate_count > 0 ? `<div class="text-xs text-rose-700 mb-2">РґСѓР±Р»РёРєР°С‚ РІ СЌС‚ sitemap: ${f.duplicate_count}</div>` : ''}
                            ${(f.urls || []).length > 0 ? `
                                <button onclick='downloadSitemapFilePreview(${idx}, "sitemap-${safeDomain}-${dateStamp}-${idx + 1}-urls-preview.txt")' class="text-xs text-green-700 hover:text-green-900 mb-2">
                                    <i class="fas fa-file-download mr-1"></i>Р­РєСЃРїРѕСЂС‚ URL СЌС‚РѕРіРѕ sitemap
                                </button>
                            ` : ''}
                            ${(f.urls_omitted || 0) > 0 ? `<div class="text-xs text-amber-700 mb-1">С‚РѕР» РїСЂРµРґРїСЂРѕСЃРјРѕС‚СЂ, РїСЂРѕРїСѓС‰РµРЅРѕ: ${f.urls_omitted}</div>` : ''}
                            ${(f.duplicate_urls || []).length > 0 ? `
                                <div class="text-xs text-rose-700 mb-1">РџСЂРёРјРµСЂС‹ РґСѓР±Р»РµР№ URL:</div>
                                <div class="text-xs text-rose-700 break-all">${escapeHtml((f.duplicate_urls || []).slice(0, 10).join(' | '))}</div>
                            ` : ''}
                            ${(f.errors || []).length > 0 ? `<div class="text-xs text-red-600">${escapeHtml((f.errors || []).join(' | '))}</div>` : ''}
                            ${(f.warnings || []).length > 0 ? `<div class="text-xs text-amber-600">${escapeHtml((f.warnings || []).join(' | '))}</div>` : ''}
                        </div>
                    `).join('')}
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-md p-6">
                <h4 class="font-semibold text-gray-700 mb-3">Help</h4>
                <div class="space-y-1 text-sm">
                    <a class="text-blue-600 hover:underline break-all" href="https://www.sitemaps.org/protocol.html" target="_blank" rel="noopener noreferrer">Sitemaps protocol (sitemaps.org)</a>
                    <a class="text-blue-600 hover:underline break-all" href="https://developers.google.com/search/docs/crawling-indexing/sitemaps/overview" target="_blank" rel="noopener noreferrer">Google Search Central: Sitemaps overview</a>
                </div>
            </div>

        </div>
    `;
}

function generateSitemapHTML(result) {
    const r = result.results || result;
    return `
        <div class="bg-white rounded-xl shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Р’Р°Р»РёРґР°С†РёСЏ Sitemap</h3>
                <button onclick="copyToClipboard('${result.url}')" class="text-blue-600 hover:text-blue-800 text-sm">
                    <i class="fas fa-copy mr-1"></i>РљРѕРїРёСЂРѕРІР°С‚СЊ URL
                </button>
            </div>
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div><span class="text-gray-600">URL:</span> <span class="font-medium">${result.url}</span></div>
                <div><span class="text-gray-600">Р’Р°Р»РёРґРµРЅ:</span> <span class="font-medium">${r.valid ? 'Р”Р°' : 'РќРµС‚'}</span></div>
                <div><span class="text-gray-600">URLs РЅР°Р№РґРµРЅРѕ:</span> <span class="font-medium">${r.urls_count || 0}</span></div>
                <div><span class="text-gray-600">РЎС‚Р°С‚:</span> <span class="font-medium">${r.status || 'РЅ/Рґ'}</span></div>
                ${r.error ? `<div class="col-span-2 text-red-600"><span class="font-medium">РћС€РёР±РєР°: ${r.error}</span></div>` : ''}
            </div>
        </div>
    `;
}


function filterBotRowsByCategory(category) {
    const select = document.getElementById('bot-category-filter');
    if (select) {
        select.value = category || 'all';
    }
    applyBotTableControls();
}

function applyBotTableControls() {
    const table = document.getElementById('bot-results-list');
    if (!table) return;
    const tbody = table.querySelector('tbody');
    if (!tbody) return;

    const category = (document.getElementById('bot-category-filter') || {}).value || 'all';
    const quick = (document.getElementById('bot-quick-filter') || {}).value || 'all';
    const sortKey = (document.getElementById('bot-sort-select') || {}).value || 'bot_az';

    const rows = Array.from(tbody.querySelectorAll('tr.bot-row'));

    const asNumber = (value, fallback = 0) => {
        const n = Number(value);
        return Number.isFinite(n) ? n : fallback;
    };

    const compare = (a, b) => {
        if (sortKey === 'indexable_first') {
            const aIdx = a.dataset.indexable === '1' ? 1 : 0;
            const bIdx = b.dataset.indexable === '1' ? 1 : 0;
            return aIdx - bIdx;
        }
        if (sortKey === 'response_asc') {
            return asNumber(a.dataset.responseMs, 10 ** 9) - asNumber(b.dataset.responseMs, 10 ** 9);
        }
        if (sortKey === 'response_desc') {
            return asNumber(b.dataset.responseMs, -1) - asNumber(a.dataset.responseMs, -1);
        }
        return (a.dataset.botName || '').localeCompare((b.dataset.botName || ''));
    };

    rows.sort(compare);
    rows.forEach((row) => tbody.appendChild(row));

    rows.forEach((row) => {
        const rowCategory = row.dataset.category || '';
        const byCategory = category === 'all' || rowCategory === category;
        let byQuick = true;
        if (quick === 'critical') byQuick = row.dataset.critical === '1';
        if (quick === 'ai') byQuick = row.dataset.ai === '1';
        if (quick === 'search') byQuick = row.dataset.search === '1';
        row.style.display = (byCategory && byQuick) ? '' : 'none';
    });
}

function generateBotHTML(result) {
    const r = result.results || result;
    const summary = r.summary || {};
    const categoryStats = r.category_stats || [];
    const issues = r.issues || [];
    const blockers = r.priority_blockers || [];
    const botRows = r.bot_rows || [];
    const criticalCategories = new Set(['Google', 'Yandex', 'Bing', 'Search']);

    const categorySet = new Set(botRows.map((x) => String(x.category || '').trim()).filter(Boolean));
    const categoryOptions = ['all', ...Array.from(categorySet).sort()];

    const botRowsHtml = botRows.map((row) => {
        const statusText = row.status || row.error || 'n/a';
        const responseMs = row.response_time_ms ? `${row.response_time_ms} ms` : 'n/a';
        const reachableLabel = row.accessible ? 'yes' : 'no';
        const indexable = row.accessible && row.has_content && row.robots_allowed !== false && !row.x_robots_forbidden && !row.meta_forbidden;
        const indexableLabel = indexable ? 'yes' : 'no';
        const category = String(row.category || '');
        const isAi = category === 'AI';
        const isSearch = criticalCategories.has(category);
        return `
            <tr
                class="bot-row border-b"
                data-category="${category}"
                data-ai="${isAi ? '1' : '0'}"
                data-search="${isSearch ? '1' : '0'}"
                data-critical="${isSearch ? '1' : '0'}"
                data-indexable="${indexable ? '1' : '0'}"
                data-reachable="${row.accessible ? '1' : '0'}"
                data-response-ms="${row.response_time_ms || ''}"
                data-bot-name="${String(row.bot_name || '').toLowerCase()}"
            >
                <td class="py-2 pr-2 font-medium">${row.bot_name || ''}</td>
                <td class="py-2 pr-2 text-gray-700">${row.category || ''}</td>
                <td class="py-2 pr-2 ${row.accessible ? 'text-green-700' : 'text-red-700'}">${statusText}</td>
                <td class="py-2 pr-2">${responseMs}</td>
                <td class="py-2 pr-2 ${row.accessible ? 'text-green-700' : 'text-red-700'}">${reachableLabel}</td>
                <td class="py-2 pr-2 ${indexable ? 'text-green-700' : 'text-amber-700'}">${indexableLabel}</td>
            </tr>
        `;
    }).join('');

    const matrixRows = categoryStats.map((c) => `
        <tr class="border-b text-sm">
            <td class="py-2 pr-2 font-medium">${c.category}</td>
            <td class="py-2 pr-2">${c.total}</td>
            <td class="py-2 pr-2">${c.accessible}</td>
            <td class="py-2 pr-2">${c.indexable ?? 0}</td>
            <td class="py-2 pr-2">${c.non_indexable ?? 0}</td>
            <td class="py-2 pr-2">${c.indexable_pct ?? 0}%</td>
            <td class="py-2 pr-2">${c.priority_risk_score ?? 0}</td>
        </tr>
    `).join('');

    const blockersHtml = blockers.length > 0
        ? blockers.slice(0, 8).map((b) => `
            <div class="rounded-lg border border-amber-200 bg-amber-50 p-3 text-sm">
                <div class="font-semibold text-amber-900">${b.title}</div>
                <div class="text-amber-800">Priority: ${b.priority_score} | Affected bots: ${b.affected_bots}</div>
                <div class="text-amber-700">${b.details}</div>
                <div class="text-amber-700">Sample bots: ${(b.sample_bots || []).join(', ') || '-'}</div>
            </div>
        `).join('')
        : '<div class="text-sm text-gray-500">No prioritized blockers found.</div>';

    const issueRows = issues.slice(0, 20).map(i => `
        <div class="py-2 border-b text-sm">
            <div class="font-medium ${i.severity === 'critical' ? 'text-red-700' : (i.severity === 'warning' ? 'text-amber-700' : 'text-blue-700')}">
                ${(i.severity || 'info').toUpperCase()} - ${i.bot || 'bot'}
            </div>
            <div class="text-gray-700">${i.title || ''}</div>
            <div class="text-gray-500">${i.details || ''}</div>
        </div>
    `).join('');

    return `
        <div class="bg-white rounded-xl shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Bot Access Check</h3>
                <div class="flex gap-3">
                    <button onclick="downloadBotDocxReport()" class="text-indigo-600 hover:text-indigo-800 text-sm">
                        <i class="fas fa-file-word mr-1"></i>Download DOCX
                    </button>
                    <button onclick="downloadBotXlsxReport()" class="text-green-600 hover:text-green-800 text-sm">
                        <i class="fas fa-file-excel mr-1"></i>Download XLSX
                    </button>
                    <button onclick="copyToClipboard('${result.url}')" class="text-blue-600 hover:text-blue-800 text-sm">
                        <i class="fas fa-copy mr-1"></i>Copy URL
                    </button>
                </div>
            </div>
            <p class="text-sm text-gray-600 mb-4">
                Matrix view for reachable/indexable bot states with criticality-based blocker prioritization.
            </p>
            <div class="grid grid-cols-2 gap-4 text-sm mb-4">
                <div><span class="text-gray-600">URL:</span> <span class="font-medium">${result.url}</span></div>
                <div><span class="text-gray-600">Bots checked:</span> <span class="font-medium">${(r.bots_checked || []).length}</span></div>
                ${summary.total ? `<div><span class="text-gray-600">Crawlable:</span> <span class="font-medium">${summary.crawlable || 0}/${summary.total}</span></div>` : ''}
                ${summary.total ? `<div><span class="text-gray-600">Renderable:</span> <span class="font-medium">${summary.renderable || 0}/${summary.total}</span></div>` : ''}
                ${summary.total ? `<div><span class="text-gray-600">Available:</span> <span class="font-medium">${summary.accessible || 0}/${summary.total}</span></div>` : ''}
                ${summary.total ? `<div><span class="text-gray-600">Indexable:</span> <span class="font-medium">${summary.indexable || 0}/${summary.total}</span></div>` : ''}
                ${summary.total ? `<div><span class="text-gray-600">Non-indexable:</span> <span class="font-medium">${summary.non_indexable || 0}</span></div>` : ''}
                ${summary.avg_response_time_ms ? `<div><span class="text-gray-600">Avg response:</span> <span class="font-medium">${summary.avg_response_time_ms} ms</span></div>` : ''}
                <div><span class="text-gray-600">Retry profile:</span> <span class="font-medium">${r.retry_profile || 'standard'}</span></div>
                <div><span class="text-gray-600">Criticality/SLA:</span> <span class="font-medium">${r.criticality_profile || 'balanced'} / ${r.sla_profile || 'standard'}</span></div>
            </div>

            <div class="border-t pt-4">
                <div class="flex items-center justify-between mb-2">
                    <h4 class="font-semibold">Bot Results</h4>
                    <div class="flex items-center gap-2 text-sm">
                        <label for="bot-quick-filter" class="text-gray-600">Quick:</label>
                        <select id="bot-quick-filter" class="border rounded px-2 py-1" onchange="applyBotTableControls()">
                            <option value="all">all</option>
                            <option value="critical">critical bots only</option>
                            <option value="search">search only</option>
                            <option value="ai">ai only</option>
                        </select>
                        <label for="bot-category-filter" class="text-gray-600">Filter:</label>
                        <select id="bot-category-filter" class="border rounded px-2 py-1" onchange="applyBotTableControls()">
                            ${categoryOptions.map((cat) => `<option value="${cat}">${cat}</option>`).join('')}
                        </select>
                        <label for="bot-sort-select" class="text-gray-600">Sort:</label>
                        <select id="bot-sort-select" class="border rounded px-2 py-1" onchange="applyBotTableControls()">
                            <option value="bot_az">bot A-Z</option>
                            <option value="indexable_first">non-indexable first</option>
                            <option value="response_asc">response asc</option>
                            <option value="response_desc">response desc</option>
                        </select>
                    </div>
                </div>
                <div class="overflow-auto">
                    <table class="w-full min-w-[760px] text-sm" id="bot-results-list">
                        <thead>
                            <tr class="text-left text-xs text-slate-500 border-b">
                                <th class="py-2 pr-2">Bot</th>
                                <th class="py-2 pr-2">Category</th>
                                <th class="py-2 pr-2">HTTP/Error</th>
                                <th class="py-2 pr-2">Response</th>
                                <th class="py-2 pr-2">Reachable</th>
                                <th class="py-2 pr-2">Indexable</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${botRowsHtml || '<tr><td colspan="6" class="py-3 text-gray-500">No bot rows available.</td></tr>'}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="border-t pt-4 mt-4">
                <h4 class="font-semibold mb-2">Category Matrix</h4>
                <div class="overflow-auto">
                    <table class="w-full min-w-[760px]">
                        <thead>
                            <tr class="text-left text-xs text-slate-500 border-b">
                                <th class="py-2 pr-2">Category</th>
                                <th class="py-2 pr-2">Total</th>
                                <th class="py-2 pr-2">Reachable</th>
                                <th class="py-2 pr-2">Indexable</th>
                                <th class="py-2 pr-2">Non-indexable</th>
                                <th class="py-2 pr-2">Indexable %</th>
                                <th class="py-2 pr-2">Risk score</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${matrixRows || '<tr><td colspan="7" class="py-3 text-gray-500">No category stats available.</td></tr>'}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="border-t pt-4 mt-4">
                <h4 class="font-semibold mb-2">Priority Blockers (by bot criticality)</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    ${blockersHtml}
                </div>
            </div>

            <div class="border-t pt-4 mt-4">
                <h4 class="font-semibold mb-2">Top Issues</h4>
                ${issueRows || '<div class="text-sm text-gray-500">No issues detected</div>'}
            </div>

            <div class="border-t pt-4 mt-4">
                <h4 class="font-semibold mb-2">Host Consistency</h4>
                <div class="text-sm ${((r.host_consistency || {}).consistent === false) ? 'text-amber-700' : 'text-green-700'}">
                    ${((r.host_consistency || {}).consistent === false) ? 'Inconsistencies detected across host variants.' : 'Host variants look consistent.'}
                </div>
                ${((r.host_consistency || {}).notes || []).length ? `<ul class="list-disc pl-5 text-sm text-gray-700 mt-2">${(r.host_consistency.notes || []).map(n => `<li>${n}</li>`).join('')}</ul>` : ''}
            </div>

            <div class="border-t pt-4 mt-4">
                <h4 class="font-semibold mb-2">Diff vs Baseline</h4>
                ${
                    (r.baseline_diff || {}).has_baseline
                        ? `<div class="overflow-auto"><table class="w-full min-w-[520px] text-sm"><thead><tr class="text-left text-xs text-slate-500 border-b"><th class="py-2 pr-2">Metric</th><th class="py-2 pr-2">Current</th><th class="py-2 pr-2">Baseline</th><th class="py-2 pr-2">Delta</th></tr></thead><tbody>${((r.baseline_diff.metrics || []).map(m => `<tr class="border-b"><td class="py-2 pr-2">${m.metric || ''}</td><td class="py-2 pr-2">${m.current ?? ''}</td><td class="py-2 pr-2">${m.baseline ?? ''}</td><td class="py-2 pr-2">${m.delta ?? ''}</td></tr>`).join('') || '<tr><td colspan=\"4\" class=\"py-2 text-gray-500\">No metrics.</td></tr>')}</tbody></table></div>`
                        : `<div class="text-sm text-gray-500">${(r.baseline_diff || {}).message || 'No baseline found.'}</div>`
                }
            </div>
        </div>
    `;
}

function generateSiteAnalysisHTML(result) {
    const r = result.results || result;
    if (r.error) {
        return `
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">РђРЅР°Р»РёР· СЃР°Р№С‚Р°</h3>
                    <button onclick="copyCurrentTaskJson()" class="text-blue-600 hover:text-blue-800 text-sm">
                        <i class="fas fa-copy mr-1"></i>РљРѕРїРёСЂРѕРІР°С‚СЊ JSON
                    </button>
                </div>
                <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-r">
                    <p class="text-red-700">РћС€РёР±РєР°: ${r.error}</p>
                </div>
            </div>
        `;
    }
    
    const summary = r.summary || {};
    const content = r.content_analysis || {};
    const tech = r.technology_stack || [];
    const issues = r.all_issues || [];
    const critical = r.critical_issues || [];
    const warnings = r.warning_issues || [];
    const info = r.info_issues || [];
    const recs = r.recommendations || [];
    
    const score = summary.seo_score || 0;
    let scoreBadge = 'bg-green-100 text-green-800';
    if (score < 30) scoreBadge = 'bg-red-100 text-red-800';
    else if (score < 50) scoreBadge = 'bg-orange-100 text-orange-800';
    else if (score < 70) scoreBadge = 'bg-yellow-100 text-yellow-800';
    
    let techHTML = '';
    if (tech.length > 0) {
        techHTML = tech.map(t => `
            <span class="inline-flex items-center bg-purple-100 text-purple-700 rounded-full px-3 py-1 text-sm font-medium mr-2 mb-2">
                ${t.tech}
                <span class="ml-1 bg-purple-200 text-purple-800 rounded-full px-1.5 py-0.5 text-xs">${t.count}</span>
            </span>
        `).join('');
    } else {
        techHTML = '<span class="text-gray-500">РўРµС…РЅРѕР»РѕРіРёРё РЅРµ РѕРїСЂРµРґРµР»РµРЅС‹</span>';
    }
    
    let issuesHTML = '';
    if (critical.length > 0) {
        issuesHTML += `
            <div class="mb-4">
                <h4 class="font-semibold text-red-600 mb-2"><i class="fas fa-exclamation-triangle mr-2"></i>РљСЂРёС‚РёС‡РµСЃРєРёРµ РїСЂРѕР±Р»РµРјС‹ (${critical.length}):</h4>
                <ul class="list-disc pl-5 text-sm text-red-700 space-y-1">
                    ${critical.slice(0, 10).map(i => `<li>${i.issue} <span class="text-gray-500 ml-2">- ${i.url.substring(0, 60)}...</span></li>`).join('')}
                </ul>
            </div>
        `;
    }
    if (warnings.length > 0) {
        issuesHTML += `
            <div class="mb-4">
                <h4 class="font-semibold text-yellow-600 mb-2"><i class="fas fa-exclamation-circle mr-2"></i>РџСЂРµРґСѓРїСЂРµР¶РґРµРЅРёСЏ (${warnings.length}):</h4>
                <ul class="list-disc pl-5 text-sm text-yellow-700 space-y-1">
                    ${warnings.slice(0, 10).map(i => `<li>${i.issue} <span class="text-gray-500 ml-2">- ${i.url.substring(0, 60)}...</span></li>`).join('')}
                </ul>
            </div>
        `;
    }
    if (info.length > 0) {
        issuesHTML += `
            <div class="mb-4">
                <h4 class="font-semibold text-blue-600 mb-2"><i class="fas fa-info-circle mr-2"></i>Р РµРєРѕРјРµРЅРґР°С†РёРё (${info.length}):</h4>
                <ul class="list-disc pl-5 text-sm text-blue-700 space-y-1">
                    ${info.slice(0, 5).map(i => `<li>${i.issue}</li>`).join('')}
                </ul>
            </div>
        `;
    }
    if (issues.length === 0) {
        issuesHTML = '<p class="text-green-600"><i class="fas fa-check mr-2"></i>РџСЂРѕР±Р»РµРј РЅРµ РѕР±РЅР°СЂСѓР¶РµРЅРѕ!</p>';
    }
    
    let recsHTML = '';
    if (recs.length > 0) {
        recsHTML = recs.map(rec => `
            <div class="flex items-start mb-2 p-3 rounded ${rec.priority === 'critical' ? 'bg-red-100' : rec.priority === 'high' ? 'bg-orange-50' : rec.priority === 'medium' ? 'bg-yellow-50' : 'bg-gray-50'}">
                <span class="inline-block w-3 h-3 rounded-full mr-3 mt-1 flex-shrink-0 ${
                    rec.priority === 'critical' ? 'bg-red-500' : 
                    rec.priority === 'high' ? 'bg-orange-500' : 
                    rec.priority === 'medium' ? 'bg-yellow-500' : 'bg-gray-500'
                }"></span>
                <span class="text-sm text-gray-700">${rec.text}</span>
            </div>
        `).join('');
    }
    
    // Pages breakdown
    const goodPages = summary.good_pages || 0;
    const avgPages = summary.average_pages || 0;
    const badPages = summary.bad_pages || 0;
    const totalPages = goodPages + avgPages + badPages || 1;
    
    const goodPercent = Math.round((goodPages / totalPages) * 100);
    const avgPercent = Math.round((avgPages / totalPages) * 100);
    const badPercent = Math.round((badPages / totalPages) * 100);
    
    return `
        <div class="space-y-6">
            <!-- Summary Card -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-lg font-semibold">РђРЅР°Р»РёР· СЃР°Р№С‚Р°</h3>
                        <p class="text-gray-500 text-sm break-all">${result.url}</p>
                    </div>
                    <button onclick="copyCurrentTaskJson()" class="text-blue-600 hover:text-blue-800 text-sm">
                        <i class="fas fa-copy mr-1"></i>РљРѕРїРёСЂРѕРІР°С‚СЊ JSON
                    </button>
                </div>
                
                <!-- Score -->
                <div class="flex items-center mb-6 p-4 rounded-lg ${scoreBadge}">
                    <div class="text-4xl font-bold mr-4">${score}</div>
                    <div>
                        <div class="font-semibold text-lg">SEO РћС†РµРЅРєР°</div>
                        <div class="text-sm opacity-90">
                            ${score >= 80 ? 'РћС‚Р»РёС‡РЅС‹Р№ СЂРµР·СѓР»СЊС‚Р°С‚!' : 
                              score >= 70 ? 'РҐРѕСЂРѕС€РёР№ СЂРµР·СѓР»СЊС‚Р°С‚' : 
                              score >= 50 ? 'РўСЂРµР±СѓРµС‚ СѓР»СѓС‡С€РµРЅРёСЏ' : 
                              score >= 30 ? 'РќРёР·РєРёР№ СЂРµР·СѓР»СЊС‚Р°С‚' : 
                              'РљСЂРёС‚РёС‡РµСЃРєРё РЅРёР·РєРёР№!'}
                        </div>
                    </div>
                </div>
                
                <!-- Stats Grid -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                    <div class="text-center p-3 bg-gray-50 rounded-lg">
                        <div class="text-2xl font-bold text-blue-600">${summary.pages_crawled || 0}</div>
                        <div class="text-xs text-gray-500">РЎС‚СЂР°РЅРёС† РїСЂРѕСЃРєР°РЅРёСЂРѕРІР°РЅРѕ</div>
                    </div>
                    <div class="text-center p-3 bg-gray-50 rounded-lg">
                        <div class="text-2xl font-bold text-green-600">${summary.internal_links_count || 0}</div>
                        <div class="text-xs text-gray-500">Р’РЅСѓС‚СЂРµРЅРЅРёС… СЃСЃС‹Р»</div>
                    </div>
                    <div class="text-center p-3 bg-gray-50 rounded-lg">
                        <div class="text-2xl font-bold text-red-600">${summary.broken_links_count || 0}</div>
                        <div class="text-xs text-gray-500">Р‘РёС‚С‹С… СЃСЃС‹Р»</div>
                    </div>
                    <div class="text-center p-3 bg-gray-50 rounded-lg">
                        <div class="text-2xl font-bold text-orange-600">${(summary.critical_issues || 0) + (summary.warning_issues || 0)}</div>
                        <div class="text-xs text-gray-500">Р’СЃРµ РїСЂРѕР±Р»РµРј</div>
                    </div>
                </div>
                
                <!-- Pages Quality -->
                <div class="border-t pt-4">
                    <h4 class="font-semibold text-gray-700 mb-3">РљР°С‡РµСЃС‚ СЃС‚СЂР°РЅРёС†:</h4>
                    <div class="space-y-2">
                        <div class="flex items-center">
                            <div class="w-20 text-sm text-gray-600">РҐРѕСЂРѕС€РёРµ</div>
                            <div class="flex-1 bg-gray-200 rounded-full h-3 mx-2">
                                <div class="bg-green-500 h-3 rounded-full" style="width: ${goodPercent}%"></div>
                            </div>
                            <div class="w-16 text-right text-sm font-medium">${goodPercent}%</div>
                        </div>
                        <div class="flex items-center">
                            <div class="w-20 text-sm text-gray-600">РЎСЂРµРґРЅРёРµ</div>
                            <div class="flex-1 bg-gray-200 rounded-full h-3 mx-2">
                                <div class="bg-yellow-500 h-3 rounded-full" style="width: ${avgPercent}%"></div>
                            </div>
                            <div class="w-16 text-right text-sm font-medium">${avgPercent}%</div>
                        </div>
                        <div class="flex items-center">
                            <div class="w-20 text-sm text-gray-600">РџСЂРѕР±Р»РµРјРЅС‹Рµ</div>
                            <div class="flex-1 bg-gray-200 rounded-full h-3 mx-2">
                                <div class="bg-red-500 h-3 rounded-full" style="width: ${badPercent}%"></div>
                            </div>
                            <div class="w-16 text-right text-sm font-medium">${badPercent}%</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Content Analysis -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4"><i class="fas fa-chart-bar mr-2 text-blue-500"></i>РђРЅР°Р»РёР· РєРѕРЅС‚РµРЅС‚Р°</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                    <div class="p-2 bg-gray-50 rounded">
                        <span class="text-gray-600">Р’СЃРµ РёР·РѕР±СЂР°Р¶РµРЅРёР№:</span>
                        <span class="font-medium ml-2">${content.total_images || 0}</span>
                    </div>
                    <div class="p-2 bg-red-50 rounded">
                        <span class="text-gray-600">Р‘РµР· alt-С‚РµРєСЃС‚Р°:</span>
                        <span class="font-medium ml-2 text-red-600">${content.images_without_alt || 0}</span>
                    </div>
                    <div class="p-2 bg-gray-50 rounded">
                        <span class="text-gray-600">Р’СЃРµ СЃСЃС‹Р»:</span>
                        <span class="font-medium ml-2">${content.total_links || 0}</span>
                    </div>
                    <div class="p-2 bg-gray-50 rounded">
                        <span class="text-gray-600">РЎС‚СЂР°РЅРёС† СЃ Title:</span>
                        <span class="font-medium ml-2">${content.pages_with_title || 0}/${summary.pages_crawled || 0}</span>
                    </div>
                    <div class="p-2 bg-gray-50 rounded">
                        <span class="text-gray-600">РЎС‚СЂР°РЅРёС† СЃ H1:</span>
                        <span class="font-medium ml-2">${content.pages_with_h1 || 0}/${summary.pages_crawled || 0}</span>
                    </div>
                    <div class="p-2 bg-gray-50 rounded">
                        <span class="text-gray-600">РЎС‚СЂР°РЅРёС†  Schema:</span>
                        <span class="font-medium ml-2">${content.pages_with_schema_org || 0}/${summary.pages_crawled || 0}</span>
                    </div>
                    <div class="p-2 bg-gray-50 rounded">
                        <span class="text-gray-600">РЎСЂРµРґРЅРµРµ СЃР» РЅР° СЃС‚СЂР°РЅРёС†Рµ:</span>
                        <span class="font-medium ml-2">${Math.round(content.average_word_count || 0)}</span>
                    </div>
                    <div class="p-2 bg-gray-50 rounded">
                        <span class="text-gray-600">Р’СЂРµ Р·Р°РіСЂСѓР·РєРё:</span>
                        <span class="font-medium ml-2">${(content.average_load_time || 0) * 1000}ms</span>
                    </div>
                    <div class="p-2 bg-gray-50 rounded">
                        <span class="text-gray-600">Р РµРґРёСЂРµРєС‚С‹:</span>
                        <span class="font-medium ml-2">${summary.redirects_count || 0}</span>
                    </div>
                </div>
            </div>
            
            <!-- Technology Stack -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4"><i class="fas fa-microchip mr-2 text-purple-500"></i>РўРµС…РЅРѕР»РѕРіРёРё</h3>
                <div class="flex flex-wrap">
                    ${techHTML}
                </div>
            </div>
            
            <!-- Issues -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4"><i class="fas fa-bug mr-2 text-red-500"></i>РџСЂРѕР±Р»РµРјС‹</h3>
                ${issuesHTML}
            </div>
            
            <!-- Recommendations -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4"><i class="fas fa-lightbulb mr-2 text-yellow-500"></i>Р РµРєРѕРјРµРЅРґР°С†РёРё</h3>
                ${recsHTML}
            </div>
        </div>
    `;
}

function generateRenderAuditHTML(result) {
    const r = result.results || result;
    const summary = r.summary || {};
    const variants = Array.isArray(r.variants) ? r.variants : [];
    const issues = Array.isArray(r.issues) ? r.issues : [];
    const mobileVariant = variants.find(v => (v?.profile_type === 'mobile') || v?.mobile === true || v?.variant_id === 'googlebot_mobile');
    const desktopVariant = variants.find(v => (v?.profile_type === 'desktop') || v?.mobile === false || v?.variant_id === 'googlebot_desktop');
    const score = Number(summary.score ?? 0);
    const scorePct = Math.max(0, Math.min(100, Math.round(score)));

    const severityRank = { critical: 0, warning: 1, info: 2 };
    const severityLabel = (sev) => {
        const s = String(sev || 'info').toLowerCase();
        if (s === 'critical') return 'CRITICAL';
        if (s === 'warning') return 'WARNING';
        return 'INFO';
    };
    const severityBadge = (sev) => {
        const s = String(sev || 'info').toLowerCase();
        if (s === 'critical') return 'bg-rose-100 text-rose-700';
        if (s === 'warning') return 'bg-amber-100 text-amber-700';
        return 'bg-sky-100 text-sky-700';
    };
    const scoreBadgeClass = (value) => value >= 80 ? 'bg-emerald-100 text-emerald-700' : value >= 60 ? 'bg-amber-100 text-amber-700' : 'bg-rose-100 text-rose-700';

    const screenshotItems = [];
    variants.forEach(v => {
        const shots = v.screenshots || {};
        Object.entries(shots).forEach(([key, shot]) => {
            if (shot && shot.url) screenshotItems.push({ src: shot.url, caption: `${v.variant_label || v.variant_id} | ${key}` });
        });
    });
    mobileLightboxItems = screenshotItems;

    const issueCodeMap = new Map();
    issues.forEach((item) => {
        const code = String(item.code || 'unknown');
        const sev = String(item.severity || 'info').toLowerCase();
        if (!issueCodeMap.has(code)) issueCodeMap.set(code, { code, total: 0, critical: 0, warning: 0, info: 0 });
        const row = issueCodeMap.get(code);
        row.total += 1;
        row[sev] = (row[sev] || 0) + 1;
    });
    const issueCodeRows = Array.from(issueCodeMap.values())
        .sort((a, b) => (b.total - a.total))
        .slice(0, 10);

    const variantRows = variants.map((v) => {
        const m = v.metrics || {};
        const seoReq = v.seo_required || {};
        const shots = Object.keys(v.screenshots || {});
        return {
            label: v.variant_label || v.variant_id || '-',
            profile: v.profile_type || (v.mobile ? 'mobile' : 'desktop'),
            score: Number(m.score ?? 0),
            missingTotal: Number(m.total_missing ?? 0),
            missingPct: Number(m.missing_pct ?? 0),
            renderMs: Number(v.timings?.rendered_s ?? 0) * 1000,
            seoFail: Number(seoReq.fail ?? 0),
            seoWarn: Number(seoReq.warn ?? 0),
            shots: shots.length,
        };
    }).sort((a, b) => (a.score - b.score) || (b.missingPct - a.missingPct));

    const renderGapRowsHtml = variantRows.map((row) => `
        <tr class="border-b border-slate-100 text-sm">
            <td class="py-2 pr-2">${escapeHtml(row.label)}</td>
            <td class="py-2 pr-2">${escapeHtml(row.profile)}</td>
            <td class="py-2 pr-2"><span class="px-2 py-0.5 rounded-full text-xs ${scoreBadgeClass(row.score)}">${escapeHtml(row.score.toFixed(1))}</span></td>
            <td class="py-2 pr-2">${escapeHtml(Math.round(row.missingTotal))}</td>
            <td class="py-2 pr-2">${escapeHtml(row.missingPct.toFixed(1))}%</td>
            <td class="py-2 pr-2">${escapeHtml(Math.round(row.renderMs))} ms</td>
            <td class="py-2 pr-2 text-rose-700 font-medium">${escapeHtml(row.seoFail)}</td>
            <td class="py-2 pr-2 text-amber-700 font-medium">${escapeHtml(row.seoWarn)}</td>
            <td class="py-2 pr-2">${escapeHtml(row.shots)}</td>
        </tr>
    `).join('');

    const normalizeText = (value) => String(value ?? '').trim();
    const metricTextCell = (value) => {
        const text = normalizeText(value);
        if (!text) return '<span class="text-slate-400">-</span>';
        const preview = text.length > 70 ? `${text.slice(0, 70)}...` : text;
        return `<div class="font-medium text-slate-800">${escapeHtml(preview)}</div><div class="text-[11px] text-slate-500">len: ${escapeHtml(text.length)}</div>`;
    };
    const toCount = (value) => {
        const n = Number(value ?? 0);
        return Number.isFinite(n) ? Math.max(0, Math.round(n)) : 0;
    };
    const deltaBadge = (delta) => {
        if (delta > 0) return `<span class="inline-flex text-[11px] px-1.5 py-0.5 rounded bg-emerald-100 text-emerald-700">+${escapeHtml(delta)}</span>`;
        if (delta < 0) return `<span class="inline-flex text-[11px] px-1.5 py-0.5 rounded bg-rose-100 text-rose-700">${escapeHtml(delta)}</span>`;
        return `<span class="inline-flex text-[11px] px-1.5 py-0.5 rounded bg-slate-100 text-slate-500">0</span>`;
    };
    const lenDeltaCell = (rawValue, renderedValue) => {
        const rawText = normalizeText(rawValue);
        const renderedText = normalizeText(renderedValue);
        const delta = renderedText.length - rawText.length;
        return deltaBadge(delta);
    };
    const countDeltaCell = (rawValue, renderedValue) => {
        const delta = toCount(renderedValue) - toCount(rawValue);
        return deltaBadge(delta);
    };
    const impactBadge = (impactScore) => {
        if (impactScore >= 4) return '<span class="px-2 py-0.5 rounded-full text-xs bg-rose-100 text-rose-700">high</span>';
        if (impactScore >= 2) return '<span class="px-2 py-0.5 rounded-full text-xs bg-amber-100 text-amber-700">medium</span>';
        if (impactScore >= 1) return '<span class="px-2 py-0.5 rounded-full text-xs bg-sky-100 text-sky-700">low</span>';
        return '<span class="px-2 py-0.5 rounded-full text-xs bg-emerald-100 text-emerald-700">none</span>';
    };
    const contentDiffRowsData = variants.map((v) => {
        const raw = v.raw || {};
        const rendered = v.rendered || {};
        const titleChanged = normalizeText(raw.title) !== normalizeText(rendered.title);
        const descChanged = normalizeText(raw.meta_description) !== normalizeText(rendered.meta_description);
        const h1Changed = toCount(raw.h1_count) !== toCount(rendered.h1_count);
        const imagesChanged = toCount(raw.images_count) !== toCount(rendered.images_count);
        const linksChanged = toCount(raw.links_count) !== toCount(rendered.links_count);
        const impactScore = [titleChanged, descChanged, h1Changed, imagesChanged, linksChanged].filter(Boolean).length;
        const rowClass = impactScore >= 4 ? 'bg-rose-50/40' : impactScore >= 2 ? 'bg-amber-50/40' : '';
        return {
            variantLabel: v.variant_label || v.variant_id || '-',
            profile: v.profile_type || (v.mobile ? 'mobile' : 'desktop'),
            raw,
            rendered,
            impactScore,
            rowClass,
            titleChanged,
            descChanged,
            h1Changed,
            imagesChanged,
            linksChanged,
        };
    }).sort((a, b) => b.impactScore - a.impactScore || String(a.variantLabel).localeCompare(String(b.variantLabel)));
    const diffSummary = contentDiffRowsData.reduce((acc, row) => {
        acc.titleChanged += row.titleChanged ? 1 : 0;
        acc.descChanged += row.descChanged ? 1 : 0;
        acc.h1Changed += row.h1Changed ? 1 : 0;
        acc.imagesChanged += row.imagesChanged ? 1 : 0;
        acc.linksChanged += row.linksChanged ? 1 : 0;
        acc.highImpact += row.impactScore >= 4 ? 1 : 0;
        return acc;
    }, { titleChanged: 0, descChanged: 0, h1Changed: 0, imagesChanged: 0, linksChanged: 0, highImpact: 0 });
    const totalDiffRows = contentDiffRowsData.length || 1;
    const summaryRatio = (value) => `${Math.round((value / totalDiffRows) * 100)}%`;
    const topDivergencesHtml = contentDiffRowsData
        .filter((row) => row.impactScore > 0)
        .slice(0, 3)
        .map((row) => {
            const changedFields = [];
            if (row.titleChanged) changedFields.push('title');
            if (row.descChanged) changedFields.push('description');
            if (row.h1Changed) changedFields.push('h1');
            if (row.imagesChanged) changedFields.push('images');
            if (row.linksChanged) changedFields.push('links');
            return `
                <div class="rounded-lg border border-slate-200 bg-slate-50 p-2">
                    <div class="flex items-center justify-between gap-2">
                        <div class="text-sm font-medium text-slate-800 truncate">${escapeHtml(row.variantLabel)}</div>
                        ${impactBadge(row.impactScore)}
                    </div>
                    <div class="text-xs text-slate-500 mt-1">${escapeHtml(row.profile)}</div>
                    <div class="text-xs text-slate-700 mt-1">Changed: ${escapeHtml(changedFields.join(', ') || '-')}</div>
                </div>
            `;
        }).join('');
    const contentDiffRowsHtml = contentDiffRowsData.map((row) => {
        return `
            <tr class="border-b border-slate-100 text-sm align-top ${row.rowClass}">
                <td class="py-2 pr-2 font-medium">${escapeHtml(row.variantLabel)}</td>
                <td class="py-2 pr-2 text-slate-600">${escapeHtml(row.profile)}</td>
                <td class="py-2 pr-2">${impactBadge(row.impactScore)}</td>
                <td class="py-2 pr-2">${metricTextCell(row.raw.title)}</td>
                <td class="py-2 pr-2">${metricTextCell(row.rendered.title)}</td>
                <td class="py-2 pr-2">${lenDeltaCell(row.raw.title, row.rendered.title)}</td>
                <td class="py-2 pr-2">${metricTextCell(row.raw.meta_description)}</td>
                <td class="py-2 pr-2">${metricTextCell(row.rendered.meta_description)}</td>
                <td class="py-2 pr-2">${lenDeltaCell(row.raw.meta_description, row.rendered.meta_description)}</td>
                <td class="py-2 pr-2 font-medium">${escapeHtml(toCount(row.raw.h1_count))}</td>
                <td class="py-2 pr-2 font-medium">${escapeHtml(toCount(row.rendered.h1_count))}</td>
                <td class="py-2 pr-2">${countDeltaCell(row.raw.h1_count, row.rendered.h1_count)}</td>
                <td class="py-2 pr-2 font-medium">${escapeHtml(toCount(row.raw.images_count))}</td>
                <td class="py-2 pr-2 font-medium">${escapeHtml(toCount(row.rendered.images_count))}</td>
                <td class="py-2 pr-2">${countDeltaCell(row.raw.images_count, row.rendered.images_count)}</td>
                <td class="py-2 pr-2 font-medium">${escapeHtml(toCount(row.raw.links_count))}</td>
                <td class="py-2 pr-2 font-medium">${escapeHtml(toCount(row.rendered.links_count))}</td>
                <td class="py-2 pr-2">${countDeltaCell(row.raw.links_count, row.rendered.links_count)}</td>
            </tr>
        `;
    }).join('');

    const recommendations = [];
    const recSeen = new Set();
    (r.recommendations || []).forEach((rec) => {
        const text = String(rec || '').trim();
        const key = text.toLowerCase();
        if (text && !recSeen.has(key)) {
            recSeen.add(key);
            recommendations.push({ text, source: 'summary' });
        }
    });
    issues
        .slice()
        .sort((a, b) => (severityRank[String(a.severity || 'info').toLowerCase()] ?? 3) - (severityRank[String(b.severity || 'info').toLowerCase()] ?? 3))
        .slice(0, 8)
        .forEach((issue) => {
            const action = `${issue.title || issue.code || 'Issue'}${issue.variant ? ` (${issue.variant})` : ''}`;
            const key = action.toLowerCase();
            if (!recSeen.has(key)) {
                recSeen.add(key);
                recommendations.push({ text: action, source: 'issue' });
            }
        });
    const recommendationCardsHtml = recommendations.slice(0, 10).map((row) => `
        <div class="rounded-lg border border-slate-200 bg-slate-50 p-3">
            <div class="text-xs text-slate-500 uppercase tracking-wide">${escapeHtml(row.source)}</div>
            <div class="text-sm font-medium text-slate-900 mt-1">${escapeHtml(row.text)}</div>
        </div>
    `).join('');

    const topIssuesHtml = issues
        .slice()
        .sort((a, b) => {
            const sa = String(a.severity || 'info').toLowerCase();
            const sb = String(b.severity || 'info').toLowerCase();
            const bySev = (severityRank[sa] ?? 3) - (severityRank[sb] ?? 3);
            if (bySev !== 0) return bySev;
            return String(a.code || '').localeCompare(String(b.code || ''));
        })
        .slice(0, 20)
        .map((i) => `
            <div class="py-2 border-b border-slate-100 text-sm">
                <div class="flex flex-wrap items-center gap-2 mb-1">
                    <span class="px-2 py-0.5 rounded-full text-xs ${severityBadge(i.severity)}">${severityLabel(i.severity)}</span>
                    <span class="font-medium text-slate-800">${escapeHtml(i.code || 'issue')}</span>
                    <span class="text-xs text-slate-500">${escapeHtml(i.variant || 'profile')}</span>
                </div>
                <div class="text-slate-800">${escapeHtml(i.title || '')}</div>
                <div class="text-slate-600">${escapeHtml(i.details || '')}</div>
                ${(i.examples || []).length ? `<ul class="list-disc pl-5 text-xs text-slate-600 mt-1">${(i.examples || []).slice(0, 3).map(ex => `<li class="break-all">${escapeHtml(ex)}</li>`).join('')}</ul>` : ''}
            </div>
        `).join('');

    const renderProfileCard = (v, accent = 'blue') => {
        if (!v) {
            return `
                <div class="bg-white rounded-2xl shadow-lg border border-rose-200 p-6">
                    <h4 class="font-semibold text-rose-700 mb-2">Profile unavailable</h4>
                    <div class="text-sm text-rose-700">Variant payload is missing in the render result.</div>
                </div>
            `;
        }
        const metrics = v.metrics || {};
        const seoReq = v.seo_required || {};
        const scoreValue = Number(metrics.score ?? 0);
        const miss = Math.round(Number(metrics.total_missing ?? 0));
        const missPctVal = Number(metrics.missing_pct ?? 0).toFixed(1);
        const renderedMs = Math.round(Number(v.timings?.rendered_s ?? 0) * 1000);
        const emulation = v.emulation || {};
        const shots = v.screenshots || {};
        const shotList = Object.entries(shots).filter(([, shot]) => shot && shot.url);
        const firstShot = shotList[0]?.[1]?.url || '';
        const shotIndex = firstShot ? screenshotItems.findIndex(i => i.src === firstShot) : -1;
        const accentBox = accent === 'blue' ? 'from-sky-50 to-blue-100 border-blue-200' : 'from-slate-50 to-gray-100 border-gray-200';
        const profilePill = String(v.profile_type || (v.mobile ? 'mobile' : 'desktop')).toLowerCase() === 'mobile'
            ? 'bg-blue-100 text-blue-700'
            : 'bg-slate-200 text-slate-700';
        const variantIssues = Array.isArray(v.issues) ? v.issues : [];
        const issuePreview = variantIssues.slice(0, 4).map((it) => `
            <li><span class="font-medium ${String(it.severity || '').toLowerCase() === 'critical' ? 'text-rose-700' : 'text-amber-700'}">${severityLabel(it.severity)}</span> - ${escapeHtml(it.title || it.code || 'Issue')}</li>
        `).join('');
        return `
            <div class="bg-gradient-to-br ${accentBox} rounded-2xl shadow-lg border p-6">
                <div class="flex items-start justify-between mb-3">
                    <div>
                        <h4 class="text-lg font-semibold text-slate-800">${escapeHtml(v.variant_label || v.variant_id || 'Variant')}</h4>
                        <div class="mt-1 inline-flex text-[11px] px-2 py-1 rounded-full ${profilePill}">${escapeHtml(v.profile_type || (v.mobile ? 'mobile' : 'desktop'))}</div>
                    </div>
                    <span class="text-xs px-2 py-1 rounded-full ${scoreBadgeClass(scoreValue)}">Score ${escapeHtml(scoreValue.toFixed(1))}</span>
                </div>
                <div class="grid grid-cols-2 gap-2 text-sm mb-3">
                    <div class="bg-white/70 rounded-lg p-2"><span class="text-slate-600">Missing:</span> <span class="font-medium">${escapeHtml(miss)}</span></div>
                    <div class="bg-white/70 rounded-lg p-2"><span class="text-slate-600">Missing %:</span> <span class="font-medium">${escapeHtml(missPctVal)}%</span></div>
                    <div class="bg-white/70 rounded-lg p-2"><span class="text-slate-600">JS render:</span> <span class="font-medium">${escapeHtml(renderedMs)} ms</span></div>
                    <div class="bg-white/70 rounded-lg p-2"><span class="text-slate-600">SEO fail/warn:</span> <span class="font-medium">${escapeHtml(seoReq.fail || 0)}/${escapeHtml(seoReq.warn || 0)}</span></div>
                    <div class="bg-white/70 rounded-lg p-2"><span class="text-slate-600">Screenshots:</span> <span class="font-medium">${escapeHtml(shotList.length)}</span></div>
                    <div class="bg-white/70 rounded-lg p-2"><span class="text-slate-600">Viewport:</span> <span class="font-medium">${escapeHtml(emulation.viewport ? `${emulation.viewport.width}x${emulation.viewport.height}` : '-')}</span></div>
                </div>
                ${firstShot ? `
                    <div class="rounded-xl overflow-hidden border border-white/70 shadow cursor-zoom-in mb-3" onclick="openMobileLightbox(${Math.max(0, shotIndex)})">
                        <img src="${escapeHtml(firstShot)}" alt="${escapeHtml(v.variant_label || v.variant_id || 'Variant')}" class="w-full h-44 object-cover">
                    </div>
                ` : '<div class="text-sm text-slate-500 mb-3">No screenshots available.</div>'}
                ${issuePreview ? `
                    <div class="text-sm">
                        <div class="font-medium mb-1">Top variant issues</div>
                        <ul class="list-disc pl-5 text-slate-700">${issuePreview}</ul>
                    </div>
                ` : '<div class="text-sm text-emerald-700">No issues in this variant.</div>'}
            </div>
        `;
    };

    const issueCodeRowsHtml = issueCodeRows.map((row) => `
        <tr class="border-b border-slate-100 text-sm">
            <td class="py-2 pr-2">${escapeHtml(row.code)}</td>
            <td class="py-2 pr-2 font-medium">${escapeHtml(row.total)}</td>
            <td class="py-2 pr-2 text-rose-700">${escapeHtml(row.critical)}</td>
            <td class="py-2 pr-2 text-amber-700">${escapeHtml(row.warning)}</td>
            <td class="py-2 pr-2 text-sky-700">${escapeHtml(row.info)}</td>
        </tr>
    `).join('');

    const diagnosticsHtml = variants.length
        ? `<ul class="list-disc pl-5 text-xs text-slate-700">${variants.map(v => {
            const dShots = Object.keys(v.screenshots || {});
            const pType = String(v.profile_type || (v.mobile ? 'mobile' : 'desktop'));
            return `<li>${escapeHtml(v.variant_id || '-')} | ${escapeHtml(v.variant_label || '-')} | profile=${escapeHtml(pType)} | issues=${escapeHtml((v.issues || []).length)} | screenshots=${escapeHtml(dShots.join(',') || '-')}</li>`;
        }).join('')}</ul>`
        : '<div class="text-xs text-slate-500">No variant diagnostics in payload.</div>';

    return `
        <div class="space-y-6 renderpro-results">
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h3 class="text-lg font-semibold">Render Audit</h3>
                        <div class="mt-2 flex flex-wrap gap-2">
                            <span class="renderpro-chip">JS vs no-JS parity</span>
                            <span class="renderpro-chip">Variant gap matrix</span>
                            <span class="renderpro-chip">Actionable insights</span>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="downloadRenderDocxReport()" class="text-blue-600 hover:text-blue-800 text-sm"><i class="fas fa-file-word mr-1"></i>Download DOCX</button>
                        <button onclick="downloadRenderXlsxReport()" class="text-green-600 hover:text-green-800 text-sm"><i class="fas fa-file-excel mr-1"></i>Download XLSX</button>
                        <button onclick="copyCurrentTaskJson()" class="text-gray-700 hover:text-gray-900 text-sm"><i class="fas fa-copy mr-1"></i>Copy JSON</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3 text-sm">
                    <div class="rounded-xl border bg-slate-50 p-3">
                        <div class="text-xs text-slate-500">Variants</div>
                        <div class="text-xl font-semibold text-slate-900">${escapeHtml(summary.variants_total || variants.length || 0)}</div>
                    </div>
                    <div class="rounded-xl border bg-slate-50 p-3">
                        <div class="text-xs text-slate-500">Render score</div>
                        <div class="text-xl font-semibold ${score >= 80 ? 'text-emerald-700' : score >= 60 ? 'text-amber-700' : 'text-rose-700'}">${escapeHtml(summary.score ?? 'n/a')}</div>
                        <div class="mt-1 h-1.5 bg-slate-200 rounded-full overflow-hidden"><div class="h-full ${score >= 80 ? 'bg-emerald-500' : score >= 60 ? 'bg-amber-500' : 'bg-rose-500'}" style="width:${scorePct}%"></div></div>
                    </div>
                    <div class="rounded-xl border bg-slate-50 p-3">
                        <div class="text-xs text-slate-500">Missing content</div>
                        <div class="text-xl font-semibold text-slate-900">${escapeHtml(summary.missing_total || 0)}</div>
                        <div class="mt-1 text-xs text-slate-600">${escapeHtml(summary.avg_missing_pct || 0)}% avg</div>
                    </div>
                    <div class="rounded-xl border bg-slate-50 p-3">
                        <div class="text-xs text-slate-500">Avg JS render</div>
                        <div class="text-xl font-semibold text-slate-900">${escapeHtml(Math.round(Number(summary.avg_js_load_ms || 0)))} ms</div>
                        <div class="mt-1 text-xs text-slate-600">Engine: ${escapeHtml(r.engine || 'legacy')}</div>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-2 mt-3 text-sm">
                    <div class="rounded-lg border border-rose-200 bg-rose-50 p-2 text-center"><span class="text-rose-700">Critical</span><div class="font-semibold text-rose-800">${escapeHtml(summary.critical_issues || 0)}</div></div>
                    <div class="rounded-lg border border-amber-200 bg-amber-50 p-2 text-center"><span class="text-amber-700">Warning</span><div class="font-semibold text-amber-800">${escapeHtml(summary.warning_issues || 0)}</div></div>
                    <div class="rounded-lg border border-blue-200 bg-blue-50 p-2 text-center"><span class="text-blue-700">Info</span><div class="font-semibold text-blue-800">${escapeHtml(summary.info_issues || 0)}</div></div>
                </div>
                <div class="mt-3 text-xs text-slate-500 break-all">URL: ${escapeHtml(result.url || '')}</div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6 overflow-auto">
                <h4 class="font-semibold mb-3">Render Gap Matrix (JS vs no-JS)</h4>
                <table class="w-full min-w-[940px]">
                    <thead>
                        <tr class="text-left text-xs text-slate-500 border-b">
                            <th class="py-2 pr-2">Variant</th>
                            <th class="py-2 pr-2">Profile</th>
                            <th class="py-2 pr-2">Score</th>
                            <th class="py-2 pr-2">Missing</th>
                            <th class="py-2 pr-2">Missing %</th>
                            <th class="py-2 pr-2">JS render</th>
                            <th class="py-2 pr-2">SEO fail</th>
                            <th class="py-2 pr-2">SEO warn</th>
                            <th class="py-2 pr-2">Shots</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${renderGapRowsHtml || '<tr><td colspan="9" class="py-3 text-sm text-slate-500">No variant rows in payload.</td></tr>'}
                    </tbody>
                </table>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6 overflow-auto">
                <h4 class="font-semibold mb-3">JS vs no-JS Content Diff</h4>
                <div class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-6 gap-2 mb-4">
                    <div class="rounded-lg border bg-slate-50 p-2">
                        <div class="text-[11px] uppercase tracking-wide text-slate-500">Title changed</div>
                        <div class="text-base font-semibold text-slate-900">${escapeHtml(diffSummary.titleChanged)}</div>
                        <div class="text-[11px] text-slate-500">${escapeHtml(summaryRatio(diffSummary.titleChanged))} variants</div>
                    </div>
                    <div class="rounded-lg border bg-slate-50 p-2">
                        <div class="text-[11px] uppercase tracking-wide text-slate-500">Description changed</div>
                        <div class="text-base font-semibold text-slate-900">${escapeHtml(diffSummary.descChanged)}</div>
                        <div class="text-[11px] text-slate-500">${escapeHtml(summaryRatio(diffSummary.descChanged))} variants</div>
                    </div>
                    <div class="rounded-lg border bg-slate-50 p-2">
                        <div class="text-[11px] uppercase tracking-wide text-slate-500">H1 changed</div>
                        <div class="text-base font-semibold text-slate-900">${escapeHtml(diffSummary.h1Changed)}</div>
                        <div class="text-[11px] text-slate-500">${escapeHtml(summaryRatio(diffSummary.h1Changed))} variants</div>
                    </div>
                    <div class="rounded-lg border bg-slate-50 p-2">
                        <div class="text-[11px] uppercase tracking-wide text-slate-500">Images changed</div>
                        <div class="text-base font-semibold text-slate-900">${escapeHtml(diffSummary.imagesChanged)}</div>
                        <div class="text-[11px] text-slate-500">${escapeHtml(summaryRatio(diffSummary.imagesChanged))} variants</div>
                    </div>
                    <div class="rounded-lg border bg-slate-50 p-2">
                        <div class="text-[11px] uppercase tracking-wide text-slate-500">Links changed</div>
                        <div class="text-base font-semibold text-slate-900">${escapeHtml(diffSummary.linksChanged)}</div>
                        <div class="text-[11px] text-slate-500">${escapeHtml(summaryRatio(diffSummary.linksChanged))} variants</div>
                    </div>
                    <div class="rounded-lg border bg-rose-50 border-rose-200 p-2">
                        <div class="text-[11px] uppercase tracking-wide text-rose-600">High impact</div>
                        <div class="text-base font-semibold text-rose-800">${escapeHtml(diffSummary.highImpact)}</div>
                        <div class="text-[11px] text-rose-600">>=4 changed metrics</div>
                    </div>
                </div>
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-xs font-semibold uppercase tracking-wide text-slate-500">Top divergence variants</div>
                        <div class="text-[11px] text-slate-500">Delta: positive means JS adds content, negative means JS loses content</div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                        ${topDivergencesHtml || '<div class="text-sm text-slate-500">No meaningful JS/no-JS divergences.</div>'}
                    </div>
                </div>
                <table class="w-full min-w-[1900px]">
                    <thead>
                        <tr class="text-left text-xs text-slate-500 border-b">
                            <th class="py-2 pr-2">Variant</th>
                            <th class="py-2 pr-2">Profile</th>
                            <th class="py-2 pr-2">Impact</th>
                            <th class="py-2 pr-2">Title (no-JS)</th>
                            <th class="py-2 pr-2">Title (JS)</th>
                            <th class="py-2 pr-2">Delta</th>
                            <th class="py-2 pr-2">Description (no-JS)</th>
                            <th class="py-2 pr-2">Description (JS)</th>
                            <th class="py-2 pr-2">Delta</th>
                            <th class="py-2 pr-2">H1 (no-JS)</th>
                            <th class="py-2 pr-2">H1 (JS)</th>
                            <th class="py-2 pr-2">Delta</th>
                            <th class="py-2 pr-2">Images (no-JS)</th>
                            <th class="py-2 pr-2">Images (JS)</th>
                            <th class="py-2 pr-2">Delta</th>
                            <th class="py-2 pr-2">Links (no-JS)</th>
                            <th class="py-2 pr-2">Links (JS)</th>
                            <th class="py-2 pr-2">Delta</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${contentDiffRowsHtml || '<tr><td colspan="18" class="py-3 text-sm text-slate-500">No raw/rendered content stats in payload.</td></tr>'}
                    </tbody>
                </table>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
                ${renderProfileCard(desktopVariant, 'gray')}
                ${renderProfileCard(mobileVariant, 'blue')}
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow-md p-6 overflow-auto">
                    <h4 class="font-semibold mb-3">Issue Type Overview</h4>
                    <table class="w-full min-w-[520px]">
                        <thead>
                            <tr class="text-left text-xs text-slate-500 border-b">
                                <th class="py-2 pr-2">Code</th>
                                <th class="py-2 pr-2">Total</th>
                                <th class="py-2 pr-2">Critical</th>
                                <th class="py-2 pr-2">Warning</th>
                                <th class="py-2 pr-2">Info</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${issueCodeRowsHtml || '<tr><td colspan="5" class="py-3 text-sm text-slate-500">No issue code stats.</td></tr>'}
                        </tbody>
                    </table>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h4 class="font-semibold mb-3">Actionable Recommendations</h4>
                    <div class="grid grid-cols-1 gap-3">
                        ${recommendationCardsHtml || '<div class="text-sm text-slate-500">No recommendations available.</div>'}
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6">
                <h4 class="font-semibold mb-2">Priority Issues</h4>
                ${topIssuesHtml || '<div class="text-sm text-slate-500">No issues found.</div>'}
            </div>

            <details class="bg-white rounded-xl shadow-md p-4 border border-gray-100">
                <summary class="cursor-pointer text-sm font-medium">Variant diagnostics (debug)</summary>
                <div class="mt-3">${diagnosticsHtml}</div>
            </details>
        </div>
    `;
}
function generateMobileCheckHTML(result) {
    const r = result.results || result;
    const summary = r.summary || {};
    const devices = r.device_results || [];
    const issues = r.issues || [];

    mobileLightboxItems = devices
        .filter(d => d.screenshot_url)
        .map(d => ({ src: d.screenshot_url, caption: `${d.device_name} (${d.category || 'СѓСЃС‚СЂРѕР№СЃС‚'})` }));

    const deviceCards = devices.map((d, idx) => `
        <div class="bg-white rounded-xl shadow-md p-4 border border-gray-100">
            <div class="flex justify-between items-center mb-2">
                <h4 class="font-semibold text-gray-800">${d.device_name}</h4>
                <span class="text-xs px-2 py-1 rounded-full ${d.mobile_friendly ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'}">${d.mobile_friendly ? '' : 'РџСЂРѕР±Р»РµРјС‹'}</span>
            </div>
            <div class="text-sm text-gray-600 mb-2">${d.viewport?.width || '-'}x${d.viewport?.height || '-'} | ${d.load_time_ms || 0}  | РїСЂРѕР±Р»РµРј: ${d.issues_count || 0}</div>
            ${d.screenshot_url ? `
                <div class="rounded-lg overflow-hidden border cursor-zoom-in" onclick="openMobileLightbox(${idx})">
                    <img src="${d.screenshot_url}" alt="${d.device_name}" class="w-full h-44 object-cover">
                </div>
            ` : `<div class="text-sm text-gray-500">РЎРєСЂРёРЅС€РѕС‚ РѕС‚СЃСѓС‚СЃС‚РІСѓРµС‚</div>`}
            ${(d.issues || []).length ? `
                <div class="mt-3 text-sm">
                    <div class="font-medium mb-1">РљР»СЋС‡РµРІС‹Рµ РїСЂРѕР±Р»РµРјС‹:</div>
                    <ul class="list-disc pl-5 text-red-600">
                        ${(d.issues || []).slice(0, 3).map(i => `<li>${i.title}</li>`).join('')}
                    </ul>
                </div>
            ` : ''}
        </div>
    `).join('');

    const topIssuesHtml = (issues || []).slice(0, 20).map(i => `
            <div class="py-2 border-b text-sm">
            <div class="font-medium ${i.severity === 'critical' ? 'text-red-700' : (i.severity === 'warning' ? 'text-amber-700' : 'text-blue-700')}">
                ${(i.severity || 'info').toUpperCase()} | ${i.device || 'РЈСЃС‚СЂРѕР№СЃС‚'}
            </div>
            <div class="text-gray-700">${i.title || ''}</div>
            <div class="text-gray-500">${i.details || ''}</div>
        </div>
    `).join('');

    const recommendationsHtml = (r.recommendations || []).map(rec => `<li>${rec}</li>`).join('');

    return `
        <div class="space-y-6">
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">РџСЂРѕРІРµСЂРєР° РјРѕР±РёР»СЊРЅРѕР№ РІРµСЂСЃРёРё</h3>
                    <div class="flex gap-3">
                        <button onclick="downloadMobileDocxReport()" class="text-blue-600 hover:text-blue-800 text-sm"><i class="fas fa-file-word mr-1"></i>РЎРєР°С‡Р°С‚СЊ DOCX</button>
                        <button onclick="downloadMobileXlsxReport()" class="text-green-600 hover:text-green-800 text-sm"><i class="fas fa-file-excel mr-1"></i>РЎРєР°С‡Р°С‚СЊ XLSX (РѕС€РёР±РєРё)</button>
                        <button onclick="copyCurrentTaskJson()" class="text-gray-700 hover:text-gray-900 text-sm"><i class="fas fa-copy mr-1"></i>РљРѕРїРёСЂРѕРІР°С‚СЊ JSON</button>
                    </div>
                </div>
                <p class="text-sm text-gray-600 mb-4">
                    РћС‚С‡РµС‚ РїРѕРєР°Р·С‹РІР°РµС‚ РєР°С‡РµСЃС‚ РјРѕР±РёР»СЊРЅРѕР№ Р°РґР°РїС‚Р°С†РёРё, РїСЂРѕР±Р»РµРјС‹ РёРЅС‚РµСЂС„РµР№СЃР° РЅР° СѓСЃС‚СЂРѕР№СЃС‚РІР°С… Рё СЂРёСЃРєРё РґР»СЏ РїРѕР»СЊР·РѕРІР°С‚РµР» РѕРїС‹С‚Р°.
                </p>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div><span class="text-gray-600">URL:</span> <span class="font-medium">${result.url}</span></div>
                    <div><span class="text-gray-600">Р”РІРёР¶:</span> <span class="font-medium">${r.engine || 'legacy'}</span></div>
                    <div><span class="text-gray-600">РЈСЃС‚СЂРѕР№СЃС‚РІ:</span> <span class="font-medium">${summary.total_devices || (r.devices_tested || []).length}</span></div>
                    <div><span class="text-gray-600">РћС†РµРЅРєР°:</span> <span class="font-medium">${r.score ?? 'РЅ/Рґ'}</span></div>
                    <div><span class="text-gray-600">РњРѕР±РёР»СЊРЅРѕ-РґСЂСѓР¶РµР»СЋР±РЅРѕ:</span> <span class="font-medium ${r.mobile_friendly ? 'text-green-600' : 'text-red-600'}">${r.mobile_friendly ? 'Р”Р°' : 'РќРµС‚'}</span></div>
                    <div><span class="text-gray-600">РљСЂРёС‚РёС‡РЅС‹С…:</span> <span class="font-medium text-red-700">${summary.critical_issues || 0}</span></div>
                    <div><span class="text-gray-600">РџСЂРµРґСѓРїСЂРµР¶РґРµРЅРёР№:</span> <span class="font-medium text-amber-700">${summary.warning_issues || 0}</span></div>
                    <div><span class="text-gray-600">РЎСЂРµ Р·Р°РіСЂСѓР·РєР°:</span> <span class="font-medium">${summary.avg_load_time_ms || 0} </span></div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                ${deviceCards || '<div class="text-sm text-gray-500">РќРµС‚ СЂРµР·СѓР»СЊС‚Р°С‚  СѓСЃС‚СЂРѕР№СЃС‚РІР°Рј.</div>'}
            </div>

            <div class="bg-white rounded-xl shadow-md p-6">
                <h4 class="font-semibold mb-2">РќР°Р№РґРµРЅРЅС‹Рµ РїСЂРѕР±Р»РµРјС‹</h4>
                ${topIssuesHtml || '<div class="text-sm text-gray-500">РџСЂРѕР±Р»РµРј РЅРµ РѕР±РЅР°СЂСѓР¶РµРЅРѕ.</div>'}
            </div>

            <div class="bg-white rounded-xl shadow-md p-6">
                <h4 class="font-semibold mb-2">Р РµРєРѕРјРµРЅРґР°С†РёРё</h4>
                <ul class="list-disc pl-5 text-sm text-gray-700">${recommendationsHtml || '<li>Р РµРєРѕРјРµРЅРґР°С†РёР№ РЅРµС‚.</li>'}</ul>
            </div>
        </div>
    `;
}

function generateOnPageAuditHTML(result) {
    const r = result.results || {};
    const summary = r.summary || {};
    const content = r.content || {};
    const keywords = r.keywords || [];
    const issues = r.issues || [];
    const topTerms = r.top_terms || [];
    const technical = r.technical || {};
    const schema = r.schema || {};
    const opengraph = r.opengraph || {};
    const links = r.links || {};
    const media = r.media || {};
    const readability = r.readability || {};
    const ai = r.ai_insights || {};
    const ngrams = r.ngrams || {};
    const contentProfile = r.content_profile || {};
    const params = r.parameter_values || [];
    const linkAnchorTerms = r.link_anchor_terms || [];
    const heatmap = r.heatmap || {};
    const priorityQueue = r.priority_queue || [];
    const targets = r.targets || [];
    const recs = r.recommendations || [];
    const titleMeta = r.title || {};
    const descMeta = r.description || {};
    const h1Meta = r.h1 || {};
    const keywordCoverage = r.keyword_coverage || {};
    const scores = r.scores || {};

    const keywordsRows = keywords.slice(0, 30).map(k => `
        <tr class="border-b border-gray-100 text-sm">
            <td class="py-2 pr-2 font-medium">${k.keyword || ''}</td>
            <td class="py-2 pr-2">${k.occurrences ?? 0}</td>
            <td class="py-2 pr-2">${k.density_pct ?? 0}%</td>
            <td class="py-2 pr-2">${k.in_title ? 'Р”Р°' : 'РќРµС‚'}</td>
            <td class="py-2 pr-2">${k.in_description ? 'Р”Р°' : 'РќРµС‚'}</td>
            <td class="py-2 pr-2">${k.in_h1 ? 'Р”Р°' : 'РќРµС‚'}</td>
            <td class="py-2 pr-2">
                <span class="px-2 py-1 rounded-full text-xs ${k.status === 'critical' ? 'bg-red-100 text-red-700' : (k.status === 'warning' ? 'bg-amber-100 text-amber-700' : 'bg-emerald-100 text-emerald-700')}">
                    ${(k.status || 'ok').toUpperCase()}
                </span>
            </td>
        </tr>
    `).join('');

    const issuesHtml = issues.slice(0, 25).map(i => `
        <div data-issue-severity="${(i.severity || 'info').toLowerCase()}" class="text-sm border-l-4 ${i.severity === 'critical' ? 'border-red-500 bg-red-50' : i.severity === 'warning' ? 'border-yellow-500 bg-yellow-50' : 'border-blue-500 bg-blue-50'} p-3 rounded-r mb-2">
            <div class="font-semibold">${(i.severity || 'info').toUpperCase()} | ${i.code || 'issue'}</div>
            <div>${i.title || ''}</div>
            <div class="text-gray-600">${i.details || ''}</div>
        </div>
    `).join('');

    const termsHtml = topTerms.slice(0, 15).map(t => `
        <div class="flex items-center justify-between text-sm py-1 border-b border-gray-100">
            <span>${t.term || ''}</span>
            <span class="font-medium">${t.count ?? 0} (${t.pct ?? 0}%)</span>
        </div>
    `).join('');
    const bigramsHtml = (ngrams.bigrams || []).slice(0, 10).map(t => `
        <div class="flex items-center justify-between text-sm py-1 border-b border-gray-100">
            <span>${t.term || ''}</span>
            <span class="font-medium">${t.count ?? 0} (${t.pct ?? 0}%)</span>
        </div>
    `).join('');
    const trigramsHtml = (ngrams.trigrams || []).slice(0, 10).map(t => `
        <div class="flex items-center justify-between text-sm py-1 border-b border-gray-100">
            <span>${t.term || ''}</span>
            <span class="font-medium">${t.count ?? 0} (${t.pct ?? 0}%)</span>
        </div>
    `).join('');
    const spam = r.spam_metrics || {};

    const recsHtml = recs.map(x => `<li>${x}</li>`).join('');
    const linkTermsHtml = linkAnchorTerms.slice(0, 10).map(t => `
        <div class="flex items-center justify-between text-sm py-1 border-b border-gray-100">
            <span>${t.term || ''}</span>
            <span class="font-medium">${t.count ?? 0}</span>
        </div>
    `).join('');
    const paramRows = params.map(p => `
        <tr class="border-b border-gray-100 text-sm">
            <td class="py-2 pr-2 font-medium">${p.parameter || ''}</td>
            <td class="py-2 pr-2">${p.value ?? ''}</td>
            <td class="py-2 pr-2">
                <span class="px-2 py-1 rounded-full text-xs ${p.status === 'good' ? 'bg-emerald-100 text-emerald-700' : (p.status === 'acceptable' ? 'bg-amber-100 text-amber-700' : (p.status === 'bad' ? 'bg-red-100 text-red-700' : 'bg-slate-100 text-slate-700'))}">
                    ${(p.status || 'info').toUpperCase()}
                </span>
            </td>
        </tr>
    `).join('');
    const heatmapCards = Object.entries(heatmap).map(([k, v]) => `
        <div class="rounded-xl border p-3 ${v.score >= 80 ? 'bg-emerald-50 border-emerald-200' : (v.score >= 60 ? 'bg-amber-50 border-amber-200' : 'bg-rose-50 border-rose-200')}">
            <div class="text-xs uppercase tracking-wide text-gray-500">${k}</div>
            <div class="text-2xl font-semibold">${v.score ?? 0}</div>
            <div class="text-xs text-gray-600">Issues: ${v.issues ?? 0}, C:${v.critical ?? 0}, W:${v.warning ?? 0}</div>
        </div>
    `).join('');
    const queueRows = priorityQueue.slice(0, 12).map(q => `
        <tr class="border-b border-gray-100 text-sm">
            <td class="py-2 pr-2">${q.bucket || '-'}</td>
            <td class="py-2 pr-2">${(q.severity || '').toUpperCase()}</td>
            <td class="py-2 pr-2">${q.code || ''}</td>
            <td class="py-2 pr-2">${q.title || ''}</td>
            <td class="py-2 pr-2">${q.priority_score ?? 0}</td>
            <td class="py-2 pr-2">${q.effort ?? 0}</td>
        </tr>
    `).join('');
    const targetRows = targets.map(t => `
        <tr class="border-b border-gray-100 text-sm">
            <td class="py-2 pr-2 font-medium">${t.metric || ''}</td>
            <td class="py-2 pr-2">${t.current ?? 0}</td>
            <td class="py-2 pr-2">${t.target ?? 0}</td>
            <td class="py-2 pr-2 ${Number(t.delta || 0) > 0 ? 'text-red-700' : 'text-emerald-700'}">${t.delta ?? 0}</td>
        </tr>
    `).join('');
    const clampPct = (v) => Math.max(0, Math.min(100, Number(v || 0)));
    const scoreBar = (label, value, tone = 'blue') => {
        const pct = clampPct(value);
        const toneMap = {
            blue: 'bg-blue-500',
            emerald: 'bg-emerald-500',
            amber: 'bg-amber-500',
            rose: 'bg-rose-500',
            indigo: 'bg-indigo-500',
        };
        return `
            <div class="rounded-xl border border-slate-200 p-3 bg-slate-50">
                <div class="flex items-center justify-between text-xs text-slate-600 mb-1">
                    <span>${label}</span>
                    <span class="font-semibold">${pct.toFixed(1)}</span>
                </div>
                <div class="h-2 rounded-full bg-slate-200 overflow-hidden">
                    <div class="h-2 ${toneMap[tone] || toneMap.blue}" style="width:${pct}%"></div>
                </div>
            </div>
        `;
    };
    const scoreBars = [
        scoreBar('Overall Score', r.score ?? summary.score ?? 0, 'blue'),
        scoreBar('Spam Score', scores.spam_score ?? summary.spam_score ?? 0, 'emerald'),
        scoreBar('Keyword Coverage', keywordCoverage.coverage_pct ?? summary.keyword_coverage_pct ?? 0, 'indigo'),
        scoreBar('AI Risk', ai.ai_risk_composite ?? summary.ai_risk_composite ?? 0, 'rose'),
    ].join('');
    const quickActions = priorityQueue.slice(0, 6).map((q, idx) => `
        <div class="rounded-xl border border-slate-200 p-3 ${q.bucket === 'Now' ? 'bg-rose-50' : (q.bucket === 'Next' ? 'bg-amber-50' : 'bg-emerald-50')}">
            <div class="flex items-center justify-between mb-1">
                <span class="text-xs font-semibold uppercase tracking-wide text-slate-600">#${idx + 1} ${q.bucket || 'Later'}</span>
                <span class="text-xs text-slate-500">P ${q.priority_score ?? 0}</span>
            </div>
            <div class="text-sm font-medium text-slate-800">${q.title || q.code || 'Issue'}</div>
            <div class="text-xs text-slate-600 mt-1">${(q.severity || '').toUpperCase()} | Effort ${q.effort ?? 0}</div>
        </div>
    `).join('');

    return `
        <div class="space-y-6">
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h3 class="text-lg font-semibold">OnPage Audit</h3>
                        <p class="text-sm text-gray-500 break-all">${result.url || ''}</p>
                    </div>
                    <div class="flex flex-wrap items-center gap-3">
                        <button onclick="downloadOnpageDocxReport()" class="text-blue-600 hover:text-blue-800 text-sm"><i class="fas fa-file-word mr-1"></i>РЎРєР°С‡Р°С‚СЊ DOCX</button>
                        <button onclick="downloadOnpageXlsxReport()" class="text-green-600 hover:text-green-800 text-sm"><i class="fas fa-file-excel mr-1"></i>РЎРєР°С‡Р°С‚СЊ XLSX</button>
                        <button onclick="copyOnpageTopFixes()" class="text-rose-700 hover:text-rose-900 text-sm"><i class="fas fa-bolt mr-1"></i>Copy Top Fixes</button>
                        <button onclick="copyOnpageRecommendations()" class="text-indigo-700 hover:text-indigo-900 text-sm"><i class="fas fa-list-check mr-1"></i>Copy Recommendations</button>
                        <button onclick="copyCurrentTaskJson()" class="text-gray-700 hover:text-gray-900 text-sm"><i class="fas fa-copy mr-1"></i>РљРѕРїРёСЂРѕРІР°С‚СЊ JSON</button>
                    </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-7 gap-3 text-sm">
                    <div class="rounded-xl border bg-slate-50 p-3"><div class="text-xs text-slate-500">Score</div><div class="text-xl font-semibold">${r.score ?? summary.score ?? 0}</div></div>
                    <div class="rounded-xl border bg-slate-50 p-3"><div class="text-xs text-slate-500">Р РЋР В»Р С•Р Р†</div><div class="text-xl font-semibold">${content.word_count ?? 0}</div></div>
                    <div class="rounded-xl border bg-slate-50 p-3"><div class="text-xs text-slate-500">Spam Score</div><div class="text-xl font-semibold">${scores.spam_score ?? summary.spam_score ?? 0}</div></div>
                    <div class="rounded-xl border bg-slate-50 p-3"><div class="text-xs text-slate-500">KW Coverage</div><div class="text-xl font-semibold">${keywordCoverage.coverage_pct ?? summary.keyword_coverage_pct ?? 0}%</div></div>
                    <div class="rounded-xl border bg-slate-50 p-3"><div class="text-xs text-slate-500">AI Risk</div><div class="text-xl font-semibold">${ai.ai_risk_composite ?? summary.ai_risk_composite ?? 0}</div></div>
                    <div class="rounded-xl border bg-slate-50 p-3"><div class="text-xs text-slate-500">Critical</div><div class="text-xl font-semibold text-red-700">${summary.critical_issues ?? 0}</div></div>
                    <div class="rounded-xl border bg-slate-50 p-3"><div class="text-xs text-slate-500">Warning</div><div class="text-xl font-semibold text-amber-700">${summary.warning_issues ?? 0}</div></div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h4 class="font-semibold mb-3">Schema</h4>
                    <div class="space-y-1 text-sm">
                        <div><span class="text-gray-600">JSON-LD blocks:</span> <span class="font-medium">${schema.json_ld_blocks ?? 0}</span></div>
                        <div><span class="text-gray-600">Valid JSON-LD:</span> <span class="font-medium">${schema.json_ld_valid_blocks ?? 0}</span></div>
                        <div><span class="text-gray-600">Microdata items:</span> <span class="font-medium">${schema.microdata_items ?? 0}</span></div>
                        <div><span class="text-gray-600">RDFa items:</span> <span class="font-medium">${schema.rdfa_items ?? 0}</span></div>
                        <div><span class="text-gray-600">Types:</span> <span class="font-medium">${(schema.types || []).map(t => t.type).slice(0, 8).join(', ') || '-'}</span></div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h4 class="font-semibold mb-3">OpenGraph</h4>
                    <div class="space-y-1 text-sm">
                        <div><span class="text-gray-600">Tags count:</span> <span class="font-medium">${opengraph.tags_count ?? 0}</span></div>
                        <div><span class="text-gray-600">Required present:</span> <span class="font-medium">${opengraph.required_present_count ?? 0}/5</span></div>
                        <div><span class="text-gray-600">Missing:</span> <span class="font-medium">${(opengraph.required_missing || []).join(', ') || '-'}</span></div>
                        <div><span class="text-gray-600">og:title:</span> <span class="font-medium">${(opengraph.tags || {})['og:title'] || '-'}</span></div>
                        <div><span class="text-gray-600">og:description:</span> <span class="font-medium">${(opengraph.tags || {})['og:description'] || '-'}</span></div>
                        <div><span class="text-gray-600">og:image:</span> <span class="font-medium break-all">${(opengraph.tags || {})['og:image'] || '-'}</span></div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6">
                <h4 class="font-semibold mb-3">AI Signals</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-3 text-sm">
                    <div><span class="text-gray-600">AI marker density/1k:</span> <span class="font-medium">${ai.ai_marker_density_1k ?? 0}</span></div>
                    <div><span class="text-gray-600">Hedging ratio:</span> <span class="font-medium">${ai.hedging_ratio ?? 0}</span></div>
                    <div><span class="text-gray-600">Template repetition:</span> <span class="font-medium">${ai.template_repetition ?? 0}</span></div>
                    <div><span class="text-gray-600">Burstiness CV:</span> <span class="font-medium">${ai.burstiness_cv ?? 0}</span></div>
                    <div><span class="text-gray-600">Perplexity proxy:</span> <span class="font-medium">${ai.perplexity_proxy ?? 0}</span></div>
                    <div><span class="text-gray-600">Entity depth/1k:</span> <span class="font-medium">${ai.entity_depth_1k ?? 0}</span></div>
                    <div><span class="text-gray-600">Claim specificity:</span> <span class="font-medium">${ai.claim_specificity_score ?? 0}</span></div>
                    <div><span class="text-gray-600">Author signal:</span> <span class="font-medium">${ai.author_signal_score ?? 0}</span></div>
                    <div><span class="text-gray-600">Source attribution:</span> <span class="font-medium">${ai.source_attribution_score ?? 0}</span></div>
                    <div><span class="text-gray-600">AI risk composite:</span> <span class="font-medium">${ai.ai_risk_composite ?? 0}</span></div>
                </div>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h4 class="font-semibold mb-3">Score Overview</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        ${scoreBars}
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h4 class="font-semibold mb-3">Top Fixes (Quick Actions)</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        ${quickActions || '<div class="text-sm text-gray-500">РќРµС‚ РґР°РЅРЅС‹С….</div>'}
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6">
                <h4 class="font-semibold mb-3">Severity Heatmap</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 xl:grid-cols-6 gap-3">
                    ${heatmapCards || '<div class="text-sm text-gray-500">РќРµС‚ РґР°РЅРЅС‹С….</div>'}
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6 overflow-auto">
                <h4 class="font-semibold mb-3">Priority Queue (Now / Next / Later)</h4>
                <table class="w-full min-w-[860px]">
                    <thead class="sticky top-0 z-10 bg-white">
                        <tr class="text-left text-xs text-gray-500 border-b">
                            <th class="py-2 pr-2 bg-white">Bucket</th>
                            <th class="py-2 pr-2 bg-white">Severity</th>
                            <th class="py-2 pr-2 bg-white">Code</th>
                            <th class="py-2 pr-2 bg-white">Issue</th>
                            <th class="py-2 pr-2 bg-white">Priority</th>
                            <th class="py-2 pr-2 bg-white">Effort</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${queueRows || '<tr><td class="py-2 text-sm text-gray-500" colspan="6">РќРµС‚ РґР°РЅРЅС‹С….</td></tr>'}
                    </tbody>
                </table>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6 overflow-auto">
                <h4 class="font-semibold mb-3">Before / After Targets</h4>
                <table class="w-full min-w-[640px]">
                    <thead class="sticky top-0 z-10 bg-white">
                        <tr class="text-left text-xs text-gray-500 border-b">
                            <th class="py-2 pr-2 bg-white">Metric</th>
                            <th class="py-2 pr-2 bg-white">Current</th>
                            <th class="py-2 pr-2 bg-white">Target</th>
                            <th class="py-2 pr-2 bg-white">Delta</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${targetRows || '<tr><td class="py-2 text-sm text-gray-500" colspan="4">РќРµС‚ РґР°РЅРЅС‹С….</td></tr>'}
                    </tbody>
                </table>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6">
                <h4 class="font-semibold mb-3">Р РµРєРѕРјРµРЅРґР°С†РёРё</h4>
                    <ul class="list-disc pl-5 text-sm text-gray-700">${recsHtml || '<li>Р РµРєРѕРјРµРЅРґР°С†РёР№ РЅРµС‚.</li>'}</ul>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
                    <h4 class="font-semibold">Issues</h4>
                    <div class="inline-flex rounded-lg border border-slate-200 p-1 bg-slate-50 text-xs">
                        <button type="button" data-onpage-issues-filter="all" onclick="filterOnpageIssues('all')" class="px-2 py-1 rounded-md bg-slate-900 text-white">All</button>
                        <button type="button" data-onpage-issues-filter="critical" onclick="filterOnpageIssues('critical')" class="px-2 py-1 rounded-md text-slate-700">Critical</button>
                        <button type="button" data-onpage-issues-filter="warning" onclick="filterOnpageIssues('warning')" class="px-2 py-1 rounded-md text-slate-700">Warning</button>
                        <button type="button" data-onpage-issues-filter="info" onclick="filterOnpageIssues('info')" class="px-2 py-1 rounded-md text-slate-700">Info</button>
                    </div>
                </div>
                <div class="text-xs text-slate-500 mb-2">Shown: <span id="onpage-issues-count">${Math.min(25, issues.length)} / ${Math.min(25, issues.length)}</span></div>
                <div id="onpage-issues-list">
                    ${issuesHtml || '<div class="text-sm text-gray-500">РџСЂРѕР±Р»РµРј РЅРµ РѕР±РЅР°СЂСѓР¶РµРЅРѕ.</div>'}
                </div>
            </div>
        </div>
    `;
}

function generateSiteAuditProHTML(result) {
    const r = result.results || {};
    const summary = r.summary || {};
    const pages = r.pages || [];
    const issues = r.issues || [];
    const pipeline = r.pipeline || {};
    const metrics = pipeline.metrics || {};
    const chunkManifest = (r.artifacts || {}).chunk_manifest || {};
    const artifactsMeta = r.artifacts || {};
    const crawlBudgetSummary = artifactsMeta.crawl_budget_summary || {};
    const homepageSecurity = artifactsMeta.homepage_security || {};
    const mode = r.mode || result.mode || 'quick';
    const isBatchMode = Boolean(result.batch_mode || artifactsMeta.batch_mode);
    const batchUrlsCount = Number(result.batch_urls_count || artifactsMeta.batch_urls_requested || 0);
    const duplicates = pipeline.duplicates || {};
    const duplicateTitleGroups = Array.isArray(duplicates.title_groups) ? duplicates.title_groups : [];
    const duplicateDescriptionGroups = Array.isArray(duplicates.description_groups) ? duplicates.description_groups : [];
    const pagesCount = Number(summary.total_pages ?? pages.length ?? 0);
    const totalPagesBase = Math.max(1, pagesCount);
    const totalIssuesBase = Math.max(1, issues.length);
    const normalizeRecommendationText = (text) => String(text || '')
        .toLowerCase()
        .replace(/[^\w\s]/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
    const issueFamilyByCode = (code) => {
        const codeL = String(code || '').toLowerCase();
        if (/(title|meta|h1|canonical|robots|viewport|charset|schema|structured)/.test(codeL)) return 'OnPage+Structured';
        if (/(http_status|https|cache|compression|security|mixed_content|crawl_budget|redirect)/.test(codeL)) return 'Technical';
        if (/(thin_content|duplicate_content|ai_|hidden_content|cloaking|cta|list|table|content)/.test(codeL)) return 'Content+AI';
        if (/(anchor|link|orphan|pagerank)/.test(codeL)) return 'LinkGraph';
        if (/(image|alt|webp|avif|external)/.test(codeL)) return 'Images+External';
        if (/(hierarchy|heading|h1_hierarchy)/.test(codeL)) return 'Hierarchy';
        if (/(keyword|tf_idf|intent|cannibal)/.test(codeL)) return 'Keywords';
        return 'Other';
    };
    const ownerHintByCode = (code) => {
        const codeL = String(code || '').toLowerCase();
        if (/(title|meta|h1|keyword|content|ai_|duplicate_)/.test(codeL)) return 'Content+SEO';
        if (/(schema|structured|hreflang|canonical|index|http_status)/.test(codeL)) return 'SEO+Dev';
        if (/(security|cache|compression|https|crawl_budget|redirect)/.test(codeL)) return 'Dev+Infra';
        return 'SEO';
    };
    const rootCauseCluster = (code) => {
        const codeL = String(code || '').toLowerCase();
        if (/(title|meta|h1|keyword|content|duplicate|ai_)/.test(codeL)) return 'Content model';
        if (/(canonical|index|robots|http_status|redirect|crawl_budget)/.test(codeL)) return 'Indexing flow';
        if (/(schema|structured|hreflang)/.test(codeL)) return 'Structured data';
        if (/(security|https|cache|compression|mixed_content)/.test(codeL)) return 'Platform infra';
        if (/(image|alt|webp|avif)/.test(codeL)) return 'Media pipeline';
        return 'General SEO';
    };
    const issueActionByCode = (code) => {
        const codeL = String(code || '').toLowerCase();
        if (codeL.includes('title')) return 'Fix title tags: uniqueness and optimal length.';
        if (codeL.includes('meta')) return 'Improve meta description quality and uniqueness.';
        if (codeL.includes('h1') || codeL.includes('hierarchy')) return 'Normalize heading hierarchy (single H1, valid H2/H3 tree).';
        if (codeL.includes('canonical')) return 'Resolve canonical conflicts and align canonical targets.';
        if (codeL.includes('crawl_budget') || codeL.includes('redirect')) return 'Reduce crawl waste: redirects, parameter traps, non-indexable branches.';
        if (codeL.includes('schema') || codeL.includes('structured')) return 'Fix structured data coverage and schema errors.';
        if (codeL.includes('image') || codeL.includes('alt')) return 'Fix image optimization issues: ALT, lazy-load, dimensions.';
        if (codeL.includes('anchor') || codeL.includes('link') || codeL.includes('orphan')) return 'Improve internal linking and anchor quality.';
        if (codeL.includes('security') || codeL.includes('https')) return 'Close technical security/header issues.';
        return 'Prioritize this issue type and apply template-level fixes.';
    };
    const recommendationThemeFromText = (text) => {
        const t = normalizeRecommendationText(text);
        if (!t) return { key: 'general', label: 'General SEO', action: 'Prioritize fixes by impact and severity.' };
        if (/(title|meta)/.test(t)) return { key: 'metadata', label: 'Metadata quality', action: 'Improve title/meta uniqueness and quality across templates.' };
        if (/(h1|heading|hierarchy)/.test(t)) return { key: 'heading_structure', label: 'Heading structure', action: 'Normalize heading hierarchy and enforce one clear H1.' };
        if (/(canonical|index|robots|crawl|redirect|http status)/.test(t)) return { key: 'indexing_flow', label: 'Indexing flow', action: 'Fix indexing signals and reduce crawl waste.' };
        if (/(schema|structured)/.test(t)) return { key: 'structured_data', label: 'Structured data', action: 'Fix schema coverage/validation on key templates.' };
        if (/(image|alt|lazy|webp|avif)/.test(t)) return { key: 'image_pipeline', label: 'Image pipeline', action: 'Fix ALT coverage and image optimization issues.' };
        if (/(anchor|link|orphan)/.test(t)) return { key: 'internal_links', label: 'Internal links', action: 'Improve internal links and anchor relevance for hubs.' };
        if (/(security|https|header|cache|compression)/.test(t)) return { key: 'platform_infra', label: 'Platform infra', action: 'Close infrastructure and security-level SEO issues.' };
        if (/(duplicate|thin|content|keyword|ai)/.test(t)) return { key: 'content_model', label: 'Content model', action: 'Improve content uniqueness, depth and intent coverage.' };
        return { key: `custom:${t.slice(0, 80)}`, label: 'General SEO', action: String(text || '').trim() || 'General SEO improvements.' };
    };
    const issuesByUrl = {};
    issues.forEach((issue) => {
        const url = String(issue.url || '');
        if (!url) return;
        if (!issuesByUrl[url]) issuesByUrl[url] = [];
        issuesByUrl[url].push(issue);
    });

    const issueCodeStatsMap = new Map();
    const clusterStatsMap = new Map();
    const ownerStatsMap = new Map();
    const issueFamilyStatsMap = new Map();
    const groupedIssuesByCode = new Map();
    issues.forEach((issue) => {
        const code = String(issue.code || 'unknown');
        const severity = String(issue.severity || 'info').toLowerCase();
        const cluster = rootCauseCluster(code);
        const owner = ownerHintByCode(code);
        const family = issueFamilyByCode(code);
        const url = String(issue.url || '');
        if (!issueCodeStatsMap.has(code)) issueCodeStatsMap.set(code, { code, count: 0, critical: 0, warning: 0, info: 0 });
        const codeRow = issueCodeStatsMap.get(code);
        codeRow.count += 1;
        codeRow[severity] = (codeRow[severity] || 0) + 1;
        if (!clusterStatsMap.has(cluster)) clusterStatsMap.set(cluster, { cluster, count: 0 });
        clusterStatsMap.get(cluster).count += 1;
        if (!ownerStatsMap.has(owner)) ownerStatsMap.set(owner, { owner, count: 0 });
        ownerStatsMap.get(owner).count += 1;
        if (!issueFamilyStatsMap.has(family)) issueFamilyStatsMap.set(family, { family, count: 0 });
        issueFamilyStatsMap.get(family).count += 1;
        if (!groupedIssuesByCode.has(code)) {
            groupedIssuesByCode.set(code, { code, critical: 0, warning: 0, info: 0, urls: new Set() });
        }
        const grouped = groupedIssuesByCode.get(code);
        grouped[severity] = (grouped[severity] || 0) + 1;
        if (url) grouped.urls.add(url);
    });

    const issueActionPlan = Array.from(groupedIssuesByCode.values()).map((row) => {
        const critical = Number(row.critical || 0);
        const warning = Number(row.warning || 0);
        const info = Number(row.info || 0);
        const topSeverity = critical > 0 ? 'critical' : warning > 0 ? 'warning' : 'info';
        const affectedPages = row.urls.size;
        const sharePct = Number(((affectedPages / totalPagesBase) * 100).toFixed(1));
        const impactScore = Number(((critical * 3.0) + (warning * 2.0) + info + (sharePct / 10.0)).toFixed(1));
        const effort = topSeverity === 'critical' ? 'M' : 'S';
        const roiScore = Number((impactScore / (effort === 'M' ? 1.3 : 1.0)).toFixed(1));
        const sprintBucket = roiScore >= 25 ? 'Now' : roiScore >= 10 ? 'Next' : 'Later';
        const action = issueActionByCode(row.code);
        const theme = recommendationThemeFromText(action);
        return {
            code: row.code,
            topSeverity,
            affectedPages,
            sharePct,
            critical,
            warning,
            info,
            impactScore,
            effort,
            roiScore,
            sprintBucket,
            owner: ownerHintByCode(row.code),
            rootCause: rootCauseCluster(row.code),
            recommendation: action,
            representativeUrls: Array.from(row.urls).slice(0, 5),
            themeKey: theme.key,
            themeLabel: theme.label,
            themeAction: theme.action,
        };
    }).sort((a, b) =>
        (b.impactScore - a.impactScore) ||
        (b.critical - a.critical) ||
        (b.warning - a.warning)
    );

    const recommendationMap = new Map();
    issueActionPlan.forEach((row) => {
        if (!recommendationMap.has(row.themeKey)) {
            recommendationMap.set(row.themeKey, {
                action: row.themeAction,
                theme: row.themeLabel,
                affectedUrls: new Set(),
                critical: 0,
                warning: 0,
                info: 0,
                sourceCodes: new Set(),
            });
        }
        const bucket = recommendationMap.get(row.themeKey);
        row.representativeUrls.forEach((u) => bucket.affectedUrls.add(u));
        bucket.critical += row.critical;
        bucket.warning += row.warning;
        bucket.info += row.info;
        bucket.sourceCodes.add(row.code);
    });

    pages.forEach((page) => {
        const rec = String(page.recommendation || '').trim();
        if (!rec) return;
        const theme = recommendationThemeFromText(rec);
        const url = String(page.url || '');
        const pageIssues = issuesByUrl[url] || [];
        if (!recommendationMap.has(theme.key)) {
            recommendationMap.set(theme.key, {
                action: theme.action,
                theme: theme.label,
                affectedUrls: new Set(),
                critical: 0,
                warning: 0,
                info: 0,
                sourceCodes: new Set(),
            });
        }
        const bucket = recommendationMap.get(theme.key);
        if (url) bucket.affectedUrls.add(url);
        pageIssues.forEach((i) => {
            const code = String(i.code || '').trim();
            if (code) bucket.sourceCodes.add(code);
        });
    });

    const actionableRecommendations = Array.from(recommendationMap.values())
        .map((row) => ({
            ...row,
            affectedCount: row.affectedUrls.size,
            urlsPreview: Array.from(row.affectedUrls).slice(0, 3),
            codesPreview: Array.from(row.sourceCodes).slice(0, 4),
        }))
        .sort((a, b) =>
            (b.critical - a.critical) ||
            (b.warning - a.warning) ||
            (b.affectedCount - a.affectedCount)
        )
        .slice(0, 10);

    const issueCodeStats = Array.from(issueCodeStatsMap.values())
        .map((row) => ({ ...row, sharePct: Number(((row.count / totalIssuesBase) * 100).toFixed(1)) }))
        .sort((a, b) => (b.count - a.count))
        .slice(0, 8);
    const clusterStats = Array.from(clusterStatsMap.values())
        .sort((a, b) => (b.count - a.count))
        .slice(0, 6);
    const ownerStats = Array.from(ownerStatsMap.values())
        .sort((a, b) => (b.count - a.count))
        .slice(0, 6);
    const issueFamilyStats = Array.from(issueFamilyStatsMap.values())
        .map((row) => ({ ...row, sharePct: Number(((row.count / totalIssuesBase) * 100).toFixed(1)) }))
        .sort((a, b) => (b.count - a.count))
        .slice(0, 7);
    const criticalPages = pages
        .map((page) => {
            const url = String(page.url || '');
            const pageIssues = issuesByUrl[url] || [];
            const critical = pageIssues.filter(i => String(i.severity || '').toLowerCase() === 'critical').length;
            const warning = pageIssues.filter(i => String(i.severity || '').toLowerCase() === 'warning').length;
            return { url, critical, warning };
        })
        .filter((row) => row.critical > 0 || row.warning > 0)
        .sort((a, b) => (b.critical - a.critical) || (b.warning - a.warning))
        .slice(0, 8);
    const criticalPagesAllCount = pages.filter((page) => {
        const url = String(page.url || '');
        const pageIssues = issuesByUrl[url] || [];
        return pageIssues.some((i) => String(i.severity || '').toLowerCase() === 'critical');
    }).length;
    const criticalPagesPct = Number(((criticalPagesAllCount / totalPagesBase) * 100).toFixed(1));
    const topFixPages = pages
        .map((p) => ({
            url: p.url || '',
            health: Number(p.health_score ?? 0),
            issues: Array.isArray(p.all_issues) ? p.all_issues.length : 0,
            recommendation: p.recommendation || '',
        }))
        .sort((a, b) => (b.issues - a.issues) || (a.health - b.health))
        .slice(0, 10);
    const totalIssues = Number(summary.issues_total ?? issues.length ?? 0);
    const score = Number(summary.score ?? 0);
    const scorePct = Math.max(0, Math.min(100, Math.round(score)));
    const issueLoadPct = pagesCount > 0 ? Math.min(100, Math.round((totalIssues / pagesCount) * 10)) : 0;
    const crawlRiskHigh = Number(metrics.crawl_budget_high_risk ?? 0);
    const crawlRiskMedium = Number(metrics.crawl_budget_medium_risk ?? 0);
    const boolLabel = (value) => value === true ? 'Yes' : value === false ? 'No' : 'n/a';
    const avgPerfLightFromPages = pages.length
        ? Number((pages.reduce((sum, p) => sum + Number(p.perf_light_score || 0), 0) / pages.length).toFixed(1))
        : 0;
    const aiPages = pages.map((p) => ({
        url: p.url || '',
        aiRiskScore: Number(p.ai_risk_score || 0),
        aiRiskLevel: String(p.ai_risk_level || 'low').toLowerCase(),
        aiMarkersCount: Number(p.ai_markers_count || 0),
        aiDensity: Number(p.ai_markers_density_1k || 0),
        aiSample: String(p.ai_marker_sample || ''),
        aiGuard: p.ai_false_positive_guard === true,
    }));
    const aiTotals = {
        markerHits: aiPages.reduce((sum, row) => sum + row.aiMarkersCount, 0),
        avgRisk: Number((aiPages.reduce((sum, row) => sum + row.aiRiskScore, 0) / Math.max(1, aiPages.length)).toFixed(1)),
        avgDensity: Number((aiPages.reduce((sum, row) => sum + row.aiDensity, 0) / Math.max(1, aiPages.length)).toFixed(2)),
        highRiskPages: aiPages.filter((row) => row.aiRiskLevel === 'high').length,
        mediumRiskPages: aiPages.filter((row) => row.aiRiskLevel === 'medium').length,
        guardedPages: aiPages.filter((row) => row.aiGuard).length,
    };
    const aiRiskRowsHtml = aiPages
        .filter((row) => row.aiMarkersCount > 0 || row.aiRiskScore > 0)
        .sort((a, b) =>
            (b.aiRiskScore - a.aiRiskScore) ||
            (b.aiMarkersCount - a.aiMarkersCount) ||
            (b.aiDensity - a.aiDensity)
        )
        .slice(0, 10)
        .map((row) => `
            <tr class="border-b border-slate-100 align-top">
                <td class="py-2 pr-2 text-xs break-all">${escapeHtml(row.url)}</td>
                <td class="py-2 pr-2 text-xs font-medium">${escapeHtml(row.aiRiskScore.toFixed(1))}</td>
                <td class="py-2 pr-2 text-xs">${escapeHtml(row.aiMarkersCount)}</td>
                <td class="py-2 pr-2 text-xs">${escapeHtml(row.aiDensity.toFixed(2))}</td>
                <td class="py-2 pr-2 text-xs">
                    <span class="px-2 py-0.5 rounded-full ${row.aiRiskLevel === 'high' ? 'bg-rose-100 text-rose-700' : row.aiRiskLevel === 'medium' ? 'bg-amber-100 text-amber-700' : 'bg-emerald-100 text-emerald-700'}">${escapeHtml(row.aiRiskLevel)}</span>
                </td>
                <td class="py-2 pr-2 text-xs text-slate-700">${escapeHtml(row.aiSample || '-')}</td>
            </tr>
        `).join('');
    const contentSignals = {
        lowUnique: pages.filter((p) => Number(p.unique_percent || 0) > 0 && Number(p.unique_percent || 0) < 55).length,
        highBoilerplate: pages.filter((p) => Number(p.boilerplate_percent || 0) >= 45).length,
        keywordStuffing: pages.filter((p) => Number(p.keyword_stuffing_score || 0) >= 3).length,
        hiddenContent: pages.filter((p) => p.hidden_content === true).length,
        highFiller: pages.filter((p) => Number(p.filler_ratio || 0) >= 0.08).length,
        toxicContent: pages.filter((p) => Number(p.toxicity_score || 0) >= 1.5).length,
    };
    const contentHygieneScore = Math.max(0, 100 - Math.min(100, Math.round(((contentSignals.highBoilerplate + contentSignals.keywordStuffing + contentSignals.hiddenContent) / totalPagesBase) * 100)));
    const aiTrustScore = Math.max(0, 100 - Math.min(100, Math.round((aiTotals.highRiskPages / totalPagesBase) * 100)));
    const indexingStabilityScore = Math.max(0, 100 - Math.min(100, Math.round(((crawlRiskHigh + Number(metrics.non_https_pages || 0)) / totalPagesBase) * 100)));
    const accessibilityScore = Math.max(0, 100 - Math.min(100, Math.round((Number(metrics.pages_without_alt || 0) / totalPagesBase) * 100)));
    const insightPillars = [
        { label: 'Content hygiene', value: contentHygieneScore, tone: contentHygieneScore >= 75 ? 'text-emerald-700' : contentHygieneScore >= 55 ? 'text-amber-700' : 'text-rose-700' },
        { label: 'AI trust', value: aiTrustScore, tone: aiTrustScore >= 75 ? 'text-emerald-700' : aiTrustScore >= 55 ? 'text-amber-700' : 'text-rose-700' },
        { label: 'Indexing stability', value: indexingStabilityScore, tone: indexingStabilityScore >= 75 ? 'text-emerald-700' : indexingStabilityScore >= 55 ? 'text-amber-700' : 'text-rose-700' },
        { label: 'Accessibility baseline', value: accessibilityScore, tone: accessibilityScore >= 75 ? 'text-emerald-700' : accessibilityScore >= 55 ? 'text-amber-700' : 'text-rose-700' },
    ];
    const insightPillarsHtml = insightPillars.map((item) => `
        <div class="rounded-xl border border-slate-200 bg-white p-3">
            <div class="text-xs text-slate-500">${escapeHtml(item.label)}</div>
            <div class="mt-1 text-xl font-semibold ${item.tone}">${escapeHtml(item.value)}</div>
            <div class="mt-1 h-1.5 bg-slate-200 rounded-full overflow-hidden">
                <div class="h-full ${item.value >= 75 ? 'bg-emerald-500' : item.value >= 55 ? 'bg-amber-500' : 'bg-rose-500'}" style="width:${escapeHtml(item.value)}%"></div>
            </div>
        </div>
    `).join('');
    const metricTone = (state) => state === 'good'
        ? 'bg-emerald-50 text-emerald-700 border-emerald-200'
        : state === 'warn'
            ? 'bg-amber-50 text-amber-700 border-amber-200'
            : 'bg-rose-50 text-rose-700 border-rose-200';
    const pipelineRows = [
        {
            metric: 'Avg response time',
            value: `${Number(metrics.avg_response_time_ms || 0)} ms`,
            target: '< 1200 ms',
            state: Number(metrics.avg_response_time_ms || 0) <= 1200 ? 'good' : Number(metrics.avg_response_time_ms || 0) <= 2000 ? 'warn' : 'bad',
        },
        {
            metric: 'Avg readability',
            value: Number(metrics.avg_readability_score || 0).toFixed(1),
            target: '>= 55',
            state: Number(metrics.avg_readability_score || 0) >= 55 ? 'good' : Number(metrics.avg_readability_score || 0) >= 40 ? 'warn' : 'bad',
        },
        {
            metric: 'Avg link quality',
            value: Number(metrics.avg_link_quality_score || 0).toFixed(1),
            target: '>= 70',
            state: Number(metrics.avg_link_quality_score || 0) >= 70 ? 'good' : Number(metrics.avg_link_quality_score || 0) >= 50 ? 'warn' : 'bad',
        },
        {
            metric: 'Avg perf light score',
            value: Number((metrics.avg_perf_light_score ?? avgPerfLightFromPages) || 0).toFixed(1),
            target: '>= 70',
            state: Number((metrics.avg_perf_light_score ?? avgPerfLightFromPages) || 0) >= 70 ? 'good' : Number((metrics.avg_perf_light_score ?? avgPerfLightFromPages) || 0) >= 50 ? 'warn' : 'bad',
        },
        {
            metric: 'Orphan pages',
            value: escapeHtml(metrics.orphan_pages ?? 0),
            target: '0',
            state: Number(metrics.orphan_pages || 0) === 0 ? 'good' : Number(metrics.orphan_pages || 0) <= Math.max(2, Math.round(totalPagesBase * 0.05)) ? 'warn' : 'bad',
        },
        {
            metric: 'Pages without ALT',
            value: escapeHtml(metrics.pages_without_alt ?? 0),
            target: '<= 10%',
            state: Number(metrics.pages_without_alt || 0) <= Math.round(totalPagesBase * 0.1) ? 'good' : Number(metrics.pages_without_alt || 0) <= Math.round(totalPagesBase * 0.2) ? 'warn' : 'bad',
        },
        {
            metric: 'Non-HTTPS pages',
            value: escapeHtml(metrics.non_https_pages ?? 0),
            target: '0',
            state: Number(metrics.non_https_pages || 0) === 0 ? 'good' : 'bad',
        },
        {
            metric: 'Crawl risk (H/M)',
            value: `${Number(metrics.crawl_budget_high_risk || 0)} / ${Number(metrics.crawl_budget_medium_risk || 0)}`,
            target: 'Downtrend',
            state: Number(metrics.crawl_budget_high_risk || 0) === 0 ? 'good' : Number(metrics.crawl_budget_high_risk || 0) <= Math.max(1, Math.round(totalPagesBase * 0.05)) ? 'warn' : 'bad',
        },
    ];
    const pipelineRowsHtml = pipelineRows.map((row) => `
        <tr class="border-b border-slate-100 text-sm">
            <td class="py-2 pr-2 font-medium text-slate-800">${escapeHtml(row.metric)}</td>
            <td class="py-2 pr-2 text-slate-900">${escapeHtml(row.value)}</td>
            <td class="py-2 pr-2 text-slate-500">${escapeHtml(row.target)}</td>
            <td class="py-2 pr-2">
                <span class="px-2 py-0.5 rounded-full border text-xs ${metricTone(row.state)}">${escapeHtml(row.state.toUpperCase())}</span>
            </td>
        </tr>
    `).join('');
    const spamTermMap = new Map();
    const pushSpamTerm = (term, type, url, weight = 1.0) => {
        const clean = String(term || '').trim().toLowerCase();
        const cleanUrl = String(url || '').trim();
        if (!clean || clean.length < 3) return;
        const key = `${type}::${clean}`;
        if (!spamTermMap.has(key)) {
            spamTermMap.set(key, { term: clean, type, pages: new Set(), weight: 0 });
        }
        const node = spamTermMap.get(key);
        if (cleanUrl) node.pages.add(cleanUrl);
        node.weight += Number(weight || 0);
    };
    pages.forEach((page) => {
        const url = String(page.url || '');
        const keywordProfile = page.keyword_density_profile || {};
        Object.entries(keywordProfile).forEach(([term, density]) => {
            const d = Number(density || 0);
            if (d >= 2.5) pushSpamTerm(term, 'keyword_density', url, d / 2);
        });
        (page.filler_phrases || []).slice(0, 12).forEach((term) => pushSpamTerm(term, 'filler_phrase', url, 1.7));
        (page.ai_markers_list || []).slice(0, 12).forEach((term) => pushSpamTerm(term, 'ai_marker', url, 2.0));
        if (Number(page.keyword_stuffing_score || 0) >= 3) {
            (page.top_keywords || []).slice(0, 5).forEach((term) => pushSpamTerm(term, 'keyword_stuffing', url, Number(page.keyword_stuffing_score || 0) / 2));
        }
    });
    const spamRows = Array.from(spamTermMap.values())
        .map((row) => {
            const pagesHit = row.pages.size;
            const sharePct = Number(((pagesHit / totalPagesBase) * 100).toFixed(1));
            const riskScore = Number((row.weight + pagesHit + (sharePct / 10)).toFixed(1));
            return { ...row, pagesHit, sharePct, riskScore };
        })
        .sort((a, b) => (b.riskScore - a.riskScore) || (b.pagesHit - a.pagesHit))
        .slice(0, 20);
    const spamRowsHtml = spamRows.map((row) => `
        <tr class="border-b border-slate-100 text-sm">
            <td class="py-2 pr-2 font-medium text-slate-800">${escapeHtml(row.term)}</td>
            <td class="py-2 pr-2 text-xs">
                <span class="px-2 py-0.5 rounded-full ${row.type === 'ai_marker' ? 'bg-rose-100 text-rose-700' : row.type === 'filler_phrase' ? 'bg-amber-100 text-amber-700' : 'bg-indigo-100 text-indigo-700'}">${escapeHtml(row.type)}</span>
            </td>
            <td class="py-2 pr-2">${escapeHtml(row.pagesHit)}</td>
            <td class="py-2 pr-2">${escapeHtml(row.sharePct)}%</td>
            <td class="py-2 pr-2 font-medium">${escapeHtml(row.riskScore)}</td>
        </tr>
    `).join('');
    const downloadsHtml = (chunkManifest.chunks || []).flatMap(chunk =>
        (chunk.files || []).map(f => {
            const safeUrl = sanitizeHttpUrl(f.download_url || '');
            if (!safeUrl) {
                return `<span class="text-sm text-gray-500">${escapeHtml(f.filename || 'artifact.jsonl')} (invalid download URL)</span>`;
            }
            return `
                <a class="text-sm text-blue-700 hover:text-blue-900 underline"
                   href="${escapeHtml(safeUrl)}"
                   target="_blank"
                   rel="noopener">
                    ${escapeHtml(f.filename || 'artifact.jsonl')} (${escapeHtml(f.records || 0)} rows)
                </a>
            `;
        })
    ).join('<br>');
    const topFixRowsHtml = topFixPages.map((row) => `
        <tr class="border-b border-slate-100 align-top">
            <td class="py-2 pr-2 text-sm break-all">${escapeHtml(row.url)}</td>
            <td class="py-2 pr-2 text-sm font-medium">${escapeHtml(row.health.toFixed(1))}</td>
            <td class="py-2 pr-2 text-sm font-medium">${escapeHtml(row.issues)}</td>
            <td class="py-2 pr-2 text-xs text-slate-700">${escapeHtml(row.recommendation || '-')}</td>
        </tr>
    `).join('');
    const duplicateTitleHtml = duplicateTitleGroups.slice(0, 5).map((g) => `
        <div class="text-sm py-2 border-b border-slate-100">
            <div class="font-medium truncate">${escapeHtml(g.value || '')}</div>
            <div class="text-xs text-slate-500">URLs: ${escapeHtml((g.urls || []).length)}</div>
        </div>
    `).join('');
    const duplicateDescriptionHtml = duplicateDescriptionGroups.slice(0, 5).map((g) => `
        <div class="text-sm py-2 border-b border-slate-100">
            <div class="font-medium truncate">${escapeHtml(g.value || '')}</div>
            <div class="text-xs text-slate-500">URLs: ${escapeHtml((g.urls || []).length)}</div>
        </div>
    `).join('');
    const issueTypeRowsHtml = issueCodeStats.map((row) => `
        <tr class="border-b border-slate-100 align-top">
            <td class="py-2 pr-2 text-xs">
                <button type="button" onclick="applySiteProIssuePreset('${escapeHtml(String(row.code || '').replace(/'/g, '\\\''))}')" class="text-indigo-700 hover:text-indigo-900 underline">${escapeHtml(row.code)}</button>
            </td>
            <td class="py-2 pr-2 text-xs font-medium">${escapeHtml(row.count)}</td>
            <td class="py-2 pr-2 text-xs text-slate-600">${escapeHtml(row.sharePct)}%</td>
            <td class="py-2 pr-2 text-xs text-red-700">${escapeHtml(row.critical || 0)}</td>
            <td class="py-2 pr-2 text-xs text-amber-700">${escapeHtml(row.warning || 0)}</td>
            <td class="py-2 pr-2 text-xs text-blue-700">${escapeHtml(row.info || 0)}</td>
        </tr>
    `).join('');
    const clusterRowsHtml = clusterStats.map((row) => `
        <div class="flex items-center justify-between py-1.5 border-b border-slate-100 text-sm">
            <button type="button" onclick="applySiteProIssuePreset('${escapeHtml(String(row.cluster || '').replace(/'/g, '\\\''))}')" class="text-indigo-700 hover:text-indigo-900 underline text-left">${escapeHtml(row.cluster)}</button>
            <span class="font-semibold">${escapeHtml(row.count)}</span>
        </div>
    `).join('');
    const ownerRowsHtml = ownerStats.map((row) => `
        <div class="flex items-center justify-between py-1.5 border-b border-slate-100 text-sm">
            <button type="button" onclick="applySiteProOwnerPreset('${escapeHtml(String(row.owner || '').replace(/'/g, '\\\''))}')" class="text-indigo-700 hover:text-indigo-900 underline text-left">${escapeHtml(row.owner)}</button>
            <span class="font-semibold">${escapeHtml(row.count)}</span>
        </div>
    `).join('');
    const issueFamilyCardsHtml = issueFamilyStats.map((row) => `
        <div class="rounded-lg border border-slate-200 bg-slate-50 p-3">
            <div class="text-xs uppercase tracking-wide text-slate-500">${escapeHtml(row.family)}</div>
            <div class="mt-1 text-lg font-semibold text-slate-900">${escapeHtml(row.count)}</div>
            <div class="text-xs text-slate-600">${escapeHtml(row.sharePct)}% of all issues</div>
        </div>
    `).join('');
    const criticalPagesRowsHtml = criticalPages.map((row) => `
        <tr class="border-b border-slate-100 align-top">
            <td class="py-2 pr-2 text-xs break-all">${escapeHtml(row.url)}</td>
            <td class="py-2 pr-2 text-xs text-red-700 font-medium">${escapeHtml(row.critical)}</td>
            <td class="py-2 pr-2 text-xs text-amber-700 font-medium">${escapeHtml(row.warning)}</td>
        </tr>
    `).join('');
    const recommendationCardsHtml = actionableRecommendations.map((row) => `
        <div class="rounded-lg border border-slate-200 bg-slate-50 p-3">
            <div class="inline-flex items-center px-2 py-0.5 rounded-full bg-indigo-100 text-indigo-700 text-[11px] mb-1">${escapeHtml(row.theme || 'General SEO')}</div>
            <div class="text-sm font-medium text-slate-900">${escapeHtml(row.action)}</div>
            <div class="mt-1 text-xs text-slate-600">Affected pages: ${escapeHtml(row.affectedCount)} | C:${escapeHtml(row.critical)} W:${escapeHtml(row.warning)} I:${escapeHtml(row.info)}</div>
            <div class="mt-1 text-xs text-slate-500">Issue types: ${escapeHtml(row.codesPreview.join(', ') || '-')}</div>
            <div class="mt-2 text-xs text-slate-500">${row.urlsPreview.map((u) => `<div class="break-all">${escapeHtml(u)}</div>`).join('') || '<div>-</div>'}</div>
        </div>
    `).join('');
    const actionPlanRowsHtml = issueActionPlan.slice(0, 12).map((row, idx) => `
        <tr class="border-b border-slate-100 align-top">
            <td class="py-2 pr-2 text-xs font-semibold">${escapeHtml(idx + 1)}</td>
            <td class="py-2 pr-2 text-xs">
                <button type="button" onclick="applySiteProIssuePreset('${escapeHtml(String(row.code || '').replace(/'/g, '\\\''))}')" class="text-indigo-700 hover:text-indigo-900 underline">${escapeHtml(row.code)}</button>
            </td>
            <td class="py-2 pr-2 text-xs">
                <span class="px-2 py-0.5 rounded-full ${row.topSeverity === 'critical' ? 'bg-rose-100 text-rose-700' : row.topSeverity === 'warning' ? 'bg-amber-100 text-amber-700' : 'bg-sky-100 text-sky-700'}">${escapeHtml(row.topSeverity)}</span>
            </td>
            <td class="py-2 pr-2 text-xs">${escapeHtml(row.affectedPages)} (${escapeHtml(row.sharePct)}%)</td>
            <td class="py-2 pr-2 text-xs font-medium">${escapeHtml(row.impactScore)}</td>
            <td class="py-2 pr-2 text-xs">${escapeHtml(row.owner)}</td>
            <td class="py-2 pr-2 text-xs">${escapeHtml(row.sprintBucket)}</td>
            <td class="py-2 pr-2 text-xs text-slate-700">${escapeHtml(row.recommendation)}</td>
        </tr>
    `).join('');
    const nowRoadmap = actionableRecommendations
        .filter((row) => row.critical > 0)
        .slice(0, 5);
    const nextRoadmap = actionableRecommendations
        .filter((row) => row.critical === 0 && row.warning > 0)
        .slice(0, 5);
    const laterRoadmap = actionableRecommendations
        .filter((row) => row.critical === 0 && row.warning === 0)
        .slice(0, 5);
    const roadmapList = (rows, emptyText) => rows.length
        ? rows.map((row) => `<li class="mb-2"><div class="font-medium">${escapeHtml(row.action)}</div><div class="text-xs text-slate-500">Coverage: ${escapeHtml(row.affectedCount)} pages</div></li>`).join('')
        : `<li class="text-slate-500">${escapeHtml(emptyText)}</li>`;

    return `
        <div class="space-y-6 sitepro-results">
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h3 class="text-lg font-semibold">Site Audit Pro</h3>
                        <div class="mt-2 flex flex-wrap gap-2 text-xs">
                            <span class="inline-flex items-center px-2.5 py-1 rounded-full bg-indigo-100 text-indigo-700">mode: ${escapeHtml(mode)}</span>
                            <span class="inline-flex items-center px-2.5 py-1 rounded-full ${isBatchMode ? 'bg-emerald-100 text-emerald-700' : 'bg-gray-100 text-gray-700'}">
                                ${isBatchMode ? 'batch mode' : 'crawl mode'}
                            </span>
                            ${isBatchMode ? `<span class="inline-flex items-center px-2.5 py-1 rounded-full bg-emerald-100 text-emerald-700">URLs: ${escapeHtml(batchUrlsCount)}</span>` : ''}
                            <span class="sitepro-chip">AI + Content Lens</span>
                            <span class="sitepro-chip">Actionable Plan</span>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="downloadSiteAuditProDocxReport()" class="text-blue-600 hover:text-blue-800 text-sm"><i class="fas fa-file-word mr-1"></i>РЎРєР°С‡Р°С‚СЊ DOCX</button>
                        <button onclick="downloadSiteAuditProXlsxReport()" class="text-green-600 hover:text-green-800 text-sm"><i class="fas fa-file-excel mr-1"></i>РЎРєР°С‡Р°С‚СЊ XLSX</button>
                        <button onclick="copyCurrentTaskJson()" class="text-gray-700 hover:text-gray-900 text-sm"><i class="fas fa-copy mr-1"></i>РљРѕРїРёСЂРѕРІР°С‚СЊ JSON</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3 text-sm">
                    <div class="rounded-xl border bg-slate-50 p-3">
                        <div class="text-xs text-slate-500">Pages</div>
                        <div class="text-xl font-semibold text-slate-900">${escapeHtml(pagesCount)}</div>
                    </div>
                    <div class="rounded-xl border bg-slate-50 p-3">
                        <div class="text-xs text-slate-500">Score</div>
                        <div class="text-xl font-semibold ${score >= 80 ? 'text-emerald-700' : score >= 60 ? 'text-amber-700' : 'text-rose-700'}">${escapeHtml(summary.score ?? 'n/a')}</div>
                        <div class="mt-1 h-1.5 bg-slate-200 rounded-full overflow-hidden"><div class="h-full ${score >= 80 ? 'bg-emerald-500' : score >= 60 ? 'bg-amber-500' : 'bg-rose-500'}" style="width:${scorePct}%"></div></div>
                    </div>
                    <div class="rounded-xl border bg-slate-50 p-3">
                        <div class="text-xs text-slate-500">Issues</div>
                        <div class="text-xl font-semibold text-slate-900">${escapeHtml(totalIssues)}</div>
                        <div class="mt-1 h-1.5 bg-slate-200 rounded-full overflow-hidden"><div class="h-full bg-indigo-500" style="width:${issueLoadPct}%"></div></div>
                    </div>
                    <div class="rounded-xl border bg-slate-50 p-3">
                        <div class="text-xs text-slate-500">URL</div>
                        <div class="font-medium break-all">${escapeHtml(result.url || '')}</div>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-2 mt-3 text-sm">
                    <div class="rounded-lg border border-red-200 bg-red-50 p-2 text-center"><span class="text-red-700">Critical</span><div class="font-semibold text-red-800">${escapeHtml(summary.critical_issues || 0)}</div></div>
                    <div class="rounded-lg border border-amber-200 bg-amber-50 p-2 text-center"><span class="text-amber-700">Warning</span><div class="font-semibold text-amber-800">${escapeHtml(summary.warning_issues || 0)}</div></div>
                    <div class="rounded-lg border border-blue-200 bg-blue-50 p-2 text-center"><span class="text-blue-700">Info</span><div class="font-semibold text-blue-800">${escapeHtml(summary.info_issues || 0)}</div></div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6">
                <h4 class="font-semibold mb-3">Quality Pillars</h4>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                    ${insightPillarsHtml}
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
                    <h4 class="font-semibold">Issues explorer</h4>
                    <div class="inline-flex rounded-lg border border-slate-200 p-1 bg-slate-50 text-xs">
                        <button type="button" data-sitepro-issues-filter="all" onclick="setSiteAuditProIssuesFilter('all')" class="px-2 py-1 rounded-md bg-slate-900 text-white">All</button>
                        <button type="button" data-sitepro-issues-filter="critical" onclick="setSiteAuditProIssuesFilter('critical')" class="px-2 py-1 rounded-md text-slate-700">Critical</button>
                        <button type="button" data-sitepro-issues-filter="warning" onclick="setSiteAuditProIssuesFilter('warning')" class="px-2 py-1 rounded-md text-slate-700">Warning</button>
                        <button type="button" data-sitepro-issues-filter="info" onclick="setSiteAuditProIssuesFilter('info')" class="px-2 py-1 rounded-md text-slate-700">Info</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-6 gap-2 mb-3">
                    <input id="sitepro-issues-search" type="text" oninput="updateSiteAuditProIssuesQuery(this.value)" placeholder="Search code, title, URL..." class="md:col-span-3 px-3 py-2 border rounded-lg text-sm">
                    <select id="sitepro-issues-limit" onchange="updateSiteAuditProIssuesLimit(this.value)" class="px-3 py-2 border rounded-lg text-sm">
                        <option value="20" selected>20 rows</option>
                        <option value="50">50 rows</option>
                        <option value="100">100 rows</option>
                    </select>
                    <select id="sitepro-issues-sort" onchange="updateSiteAuditProIssuesSort(this.value)" class="px-3 py-2 border rounded-lg text-sm">
                        <option value="severity" selected>Sort: severity</option>
                        <option value="url">Sort: URL</option>
                    </select>
                    <select id="sitepro-issues-owner" onchange="updateSiteAuditProIssuesOwner(this.value)" class="px-3 py-2 border rounded-lg text-sm">
                        <option value="all" selected>Owner: all</option>
                        <option value="SEO">Owner: SEO</option>
                        <option value="Content+SEO">Owner: Content+SEO</option>
                        <option value="SEO+Dev">Owner: SEO+Dev</option>
                        <option value="Dev+Infra">Owner: Dev+Infra</option>
                    </select>
                </div>
                <div class="text-xs text-slate-500 mb-2">Shown: <span id="sitepro-issues-count">0 / 0</span></div>
                <div id="sitepro-issues-list" class="max-h-[420px] overflow-auto pr-1"></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h4 class="font-semibold mb-3">AI Marker Risk Overview</h4>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="rounded-lg border border-rose-200 bg-rose-50 p-3">
                            <div class="text-rose-700">High-risk pages</div>
                            <div class="text-xl font-semibold text-rose-800">${escapeHtml(aiTotals.highRiskPages)}</div>
                        </div>
                        <div class="rounded-lg border border-amber-200 bg-amber-50 p-3">
                            <div class="text-amber-700">Medium-risk pages</div>
                            <div class="text-xl font-semibold text-amber-800">${escapeHtml(aiTotals.mediumRiskPages)}</div>
                        </div>
                        <div class="rounded-lg border border-indigo-200 bg-indigo-50 p-3">
                            <div class="text-indigo-700">Marker hits</div>
                            <div class="text-xl font-semibold text-indigo-800">${escapeHtml(aiTotals.markerHits)}</div>
                        </div>
                        <div class="rounded-lg border border-slate-200 bg-slate-50 p-3">
                            <div class="text-slate-700">Avg risk / density</div>
                            <div class="text-xl font-semibold text-slate-900">${escapeHtml(aiTotals.avgRisk)} / ${escapeHtml(aiTotals.avgDensity)}</div>
                        </div>
                    </div>
                    <div class="mt-2 text-xs text-slate-500">False-positive guard active on ${escapeHtml(aiTotals.guardedPages)} pages.</div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h4 class="font-semibold mb-3">Content Quality Pressure</h4>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="rounded-lg border border-amber-200 bg-amber-50 p-3">
                            <div class="text-amber-700">Low unique text</div>
                            <div class="text-xl font-semibold text-amber-800">${escapeHtml(contentSignals.lowUnique)}</div>
                        </div>
                        <div class="rounded-lg border border-rose-200 bg-rose-50 p-3">
                            <div class="text-rose-700">High boilerplate</div>
                            <div class="text-xl font-semibold text-rose-800">${escapeHtml(contentSignals.highBoilerplate)}</div>
                        </div>
                        <div class="rounded-lg border border-rose-200 bg-rose-50 p-3">
                            <div class="text-rose-700">Keyword stuffing risk</div>
                            <div class="text-xl font-semibold text-rose-800">${escapeHtml(contentSignals.keywordStuffing)}</div>
                        </div>
                        <div class="rounded-lg border border-sky-200 bg-sky-50 p-3">
                            <div class="text-sky-700">Hidden content flags</div>
                            <div class="text-xl font-semibold text-sky-800">${escapeHtml(contentSignals.hiddenContent)}</div>
                        </div>
                        <div class="rounded-lg border border-amber-200 bg-amber-50 p-3">
                            <div class="text-amber-700">High filler ratio</div>
                            <div class="text-xl font-semibold text-amber-800">${escapeHtml(contentSignals.highFiller)}</div>
                        </div>
                        <div class="rounded-lg border border-rose-200 bg-rose-50 p-3">
                            <div class="text-rose-700">Toxic wording flags</div>
                            <div class="text-xl font-semibold text-rose-800">${escapeHtml(contentSignals.toxicContent)}</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6">
                <h4 class="font-semibold mb-3">Pipeline Metrics</h4>
                <table class="w-full min-w-[760px]">
                    <thead>
                        <tr class="text-left text-xs text-slate-500 border-b">
                            <th class="py-2 pr-2">Metric</th>
                            <th class="py-2 pr-2">Current</th>
                            <th class="py-2 pr-2">Target</th>
                            <th class="py-2 pr-2">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${pipelineRowsHtml}
                    </tbody>
                </table>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h4 class="font-semibold mb-3">Executive Risk Snapshot</h4>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="rounded-lg border border-rose-200 bg-rose-50 p-3">
                            <div class="text-rose-700">Critical pages</div>
                            <div class="text-xl font-semibold text-rose-800">${escapeHtml(criticalPagesAllCount)}</div>
                            <div class="text-xs text-rose-700">${escapeHtml(criticalPagesPct)}% of scanned pages</div>
                        </div>
                        <div class="rounded-lg border border-amber-200 bg-amber-50 p-3">
                            <div class="text-amber-700">Parameterized URLs</div>
                            <div class="text-xl font-semibold text-amber-800">${escapeHtml(crawlBudgetSummary.parameterized_urls ?? 0)}</div>
                            <div class="text-xs text-amber-700">Potential crawl waste</div>
                        </div>
                        <div class="rounded-lg border border-sky-200 bg-sky-50 p-3">
                            <div class="text-sky-700">Deep path URLs</div>
                            <div class="text-xl font-semibold text-sky-800">${escapeHtml(crawlBudgetSummary.deep_path_urls ?? 0)}</div>
                            <div class="text-xs text-sky-700">Depth >= 4</div>
                        </div>
                        <div class="rounded-lg border border-slate-200 bg-slate-50 p-3">
                            <div class="text-slate-700">High / Medium crawl risk</div>
                            <div class="text-xl font-semibold text-slate-900">${escapeHtml(crawlBudgetSummary.high_risk_urls ?? 0)} / ${escapeHtml(crawlBudgetSummary.medium_risk_urls ?? 0)}</div>
                            <div class="text-xs text-slate-600">From crawl budget model</div>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h4 class="font-semibold mb-3">Homepage Security Snapshot</h4>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div><span class="text-gray-600">Headers score:</span> <span class="font-medium">${escapeHtml(homepageSecurity.security_headers_score ?? 'n/a')}</span></div>
                        <div><span class="text-gray-600">Mixed content:</span> <span class="font-medium">${escapeHtml(homepageSecurity.mixed_content_count ?? 0)}</span></div>
                        <div><span class="text-gray-600">CSP:</span> <span class="font-medium">${boolLabel(homepageSecurity.csp_present)}</span></div>
                        <div><span class="text-gray-600">HSTS:</span> <span class="font-medium">${boolLabel(homepageSecurity.hsts_present)}</span></div>
                        <div><span class="text-gray-600">X-Frame-Options:</span> <span class="font-medium">${boolLabel(homepageSecurity.x_frame_options_present)}</span></div>
                        <div><span class="text-gray-600">Referrer-Policy:</span> <span class="font-medium">${boolLabel(homepageSecurity.referrer_policy_present)}</span></div>
                        <div><span class="text-gray-600">Permissions-Policy:</span> <span class="font-medium">${boolLabel(homepageSecurity.permissions_policy_present)}</span></div>
                        <div><span class="text-gray-600">URL:</span> <span class="font-medium break-all">${escapeHtml(homepageSecurity.url || result.url || '-')}</span></div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow-md p-6 overflow-auto">
                    <h4 class="font-semibold mb-3">Issue Types Overview</h4>
                    <table class="w-full min-w-[620px]">
                        <thead>
                            <tr class="text-left text-xs text-slate-500 border-b">
                                <th class="py-2 pr-2">Code</th>
                                <th class="py-2 pr-2">Total</th>
                                <th class="py-2 pr-2">Share</th>
                                <th class="py-2 pr-2">Critical</th>
                                <th class="py-2 pr-2">Warning</th>
                                <th class="py-2 pr-2">Info</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${issueTypeRowsHtml || '<tr><td colspan="6" class="py-3 text-sm text-slate-500">No issue codes in payload.</td></tr>'}
                        </tbody>
                    </table>
                </div>
                <div class="space-y-6">
                    <div class="bg-white rounded-xl shadow-md p-6">
                        <h4 class="font-semibold mb-3">Root Cause Clusters</h4>
                        ${clusterRowsHtml || '<div class="text-sm text-slate-500">No clusters available.</div>'}
                    </div>
                    <div class="bg-white rounded-xl shadow-md p-6">
                        <h4 class="font-semibold mb-3">Owner Distribution</h4>
                        ${ownerRowsHtml || '<div class="text-sm text-slate-500">No owner breakdown available.</div>'}
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6">
                <h4 class="font-semibold mb-3">Issue Family Distribution</h4>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                    ${issueFamilyCardsHtml || '<div class="text-sm text-slate-500">No issue family stats available.</div>'}
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6 overflow-auto">
                <h4 class="font-semibold mb-3">Action Plan by Issue Type</h4>
                <table class="w-full min-w-[980px]">
                    <thead>
                        <tr class="text-left text-xs text-slate-500 border-b">
                            <th class="py-2 pr-2">#</th>
                            <th class="py-2 pr-2">Issue code</th>
                            <th class="py-2 pr-2">Severity</th>
                            <th class="py-2 pr-2">Affected pages</th>
                            <th class="py-2 pr-2">Impact</th>
                            <th class="py-2 pr-2">Owner</th>
                            <th class="py-2 pr-2">Sprint</th>
                            <th class="py-2 pr-2">Recommendation</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${actionPlanRowsHtml || '<tr><td colspan="8" class="py-3 text-sm text-slate-500">No action plan rows available.</td></tr>'}
                    </tbody>
                </table>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6 overflow-auto">
                <h4 class="font-semibold mb-3">Top Critical Pages</h4>
                <table class="w-full min-w-[680px]">
                    <thead>
                        <tr class="text-left text-xs text-slate-500 border-b">
                            <th class="py-2 pr-2">URL</th>
                            <th class="py-2 pr-2">Critical</th>
                            <th class="py-2 pr-2">Warning</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${criticalPagesRowsHtml || '<tr><td colspan="3" class="py-3 text-sm text-slate-500">No critical/warning pages found.</td></tr>'}
                    </tbody>
                </table>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6 overflow-auto">
                <h4 class="font-semibold mb-3">Top pages to fix</h4>
                <table class="w-full min-w-[720px]">
                    <thead>
                        <tr class="text-left text-xs text-slate-500 border-b">
                            <th class="py-2 pr-2">URL</th>
                            <th class="py-2 pr-2">Health</th>
                            <th class="py-2 pr-2">Issues</th>
                            <th class="py-2 pr-2">Recommendation</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${topFixRowsHtml || '<tr><td colspan="4" class="py-3 text-sm text-slate-500">No page-level rows available.</td></tr>'}
                    </tbody>
                </table>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h4 class="font-semibold mb-3">Crawl Budget Risk</h4>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="rounded-lg border border-rose-200 bg-rose-50 p-3">
                            <div class="text-rose-700">High risk pages</div>
                            <div class="text-xl font-semibold text-rose-800">${escapeHtml(crawlRiskHigh)}</div>
                        </div>
                        <div class="rounded-lg border border-amber-200 bg-amber-50 p-3">
                            <div class="text-amber-700">Medium risk pages</div>
                            <div class="text-xl font-semibold text-amber-800">${escapeHtml(crawlRiskMedium)}</div>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h4 class="font-semibold mb-3">Duplicate Groups</h4>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="rounded-lg border bg-slate-50 p-3 text-center">
                            <div class="text-slate-500 text-xs">Title groups</div>
                            <div class="text-lg font-semibold">${escapeHtml(duplicateTitleGroups.length)}</div>
                        </div>
                        <div class="rounded-lg border bg-slate-50 p-3 text-center">
                            <div class="text-slate-500 text-xs">Description groups</div>
                            <div class="text-lg font-semibold">${escapeHtml(duplicateDescriptionGroups.length)}</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h4 class="font-semibold mb-3">Top Duplicate Titles</h4>
                    ${duplicateTitleHtml || '<div class="text-sm text-slate-500">No duplicate title groups.</div>'}
                </div>
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h4 class="font-semibold mb-3">Top Duplicate Descriptions</h4>
                    ${duplicateDescriptionHtml || '<div class="text-sm text-slate-500">No duplicate description groups.</div>'}
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6 overflow-auto">
                <h4 class="font-semibold mb-3">Spam Detector: Terms and Phrases</h4>
                <table class="w-full min-w-[760px]">
                    <thead>
                        <tr class="text-left text-xs text-slate-500 border-b">
                            <th class="py-2 pr-2">Term / Phrase</th>
                            <th class="py-2 pr-2">Signal type</th>
                            <th class="py-2 pr-2">Pages</th>
                            <th class="py-2 pr-2">Share</th>
                            <th class="py-2 pr-2">Risk score</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${spamRowsHtml || '<tr><td colspan="5" class="py-3 text-sm text-slate-500">No spam signals detected in current payload.</td></tr>'}
                    </tbody>
                </table>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6">
                <h4 class="font-semibold mb-3">Roadmap: Now / Next / Later</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div class="rounded-lg border border-rose-200 bg-rose-50 p-3">
                        <div class="font-semibold text-rose-800 mb-2">Now</div>
                        <ul class="list-disc pl-4">${roadmapList(nowRoadmap, 'No critical actions queued.')}</ul>
                    </div>
                    <div class="rounded-lg border border-amber-200 bg-amber-50 p-3">
                        <div class="font-semibold text-amber-800 mb-2">Next</div>
                        <ul class="list-disc pl-4">${roadmapList(nextRoadmap, 'No warning actions queued.')}</ul>
                    </div>
                    <div class="rounded-lg border border-sky-200 bg-sky-50 p-3">
                        <div class="font-semibold text-sky-800 mb-2">Later</div>
                        <ul class="list-disc pl-4">${roadmapList(laterRoadmap, 'No backlog actions queued.')}</ul>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6">
                <h4 class="font-semibold mb-2">Actionable Recommendations</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    ${recommendationCardsHtml || '<div class="text-sm text-slate-500">No recommendations available.</div>'}
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6">
                <h4 class="font-semibold mb-2">Downloads</h4>
                ${artifactsMeta.payload_compacted ? `
                    <div class="text-xs text-amber-700 bg-amber-50 border border-amber-200 rounded px-3 py-2 mb-3">
                        Payload compact mode is enabled. Full deep data is available via chunk downloads below.
                    </div>
                    <div class="text-xs text-gray-600 mb-3">
                        Omitted from inline payload:
                        issues=${escapeHtml((artifactsMeta.omitted_counts || {}).issues ?? 0)},
                        semantic=${escapeHtml((artifactsMeta.omitted_counts || {}).semantic_linking_map ?? 0)},
                        pages=${escapeHtml((artifactsMeta.omitted_counts || {}).pages ?? 0)}
                    </div>
                ` : ''}
                ${downloadsHtml || '<div class="text-sm text-gray-500">Chunk artifacts are not available for this run.</div>'}
            </div>
        </div>
    `;
}

// Export copyToClipboard to global scope
window.copyToClipboard = copyToClipboard;
</script>
{% endblock %}
